<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Koloral Sheqiri – Gestion d'Entreprise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Variables et charte graphique */
    :root {
      --bg-color: #ffffff;
      --main-bg: #f9f9f9;
      --primary-color: #0071e3;
      --accent-color: #ff2d55;
      --text-color: #1d1d1f;
      --subtext-color: #6e6e73;
      --border-color: #e5e5ea;
      --radius: 8px;
      --transition: 0.2s ease;
      --header-height: 60px;
      --dropdown-height: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--main-bg);
      color: var(--text-color);
      font-family: 'Roboto', sans-serif;
      font-size: 15px;
      line-height: 1.5;
      overflow-x: hidden;
    }
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: var(--bg-color);
      height: var(--header-height);
      padding: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1200;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    header h1 { font-size: 1.6rem; color: var(--primary-color); }
    #nav-dropdown {
      position: fixed;
      top: var(--header-height);
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 360px;
      padding: 0.6rem 0.8rem;
      font-size: 0.95rem;
      border: 1px solid var(--primary-color);
      border-radius: var(--radius);
      background: var(--bg-color) url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D'10'%20height%3D'10'%20xmlns%3D'http://www.w3.org/2000/svg'%3E%3Cpath%20d%3D'M0%200l5%205l5-5z'%20fill%3D'%230071e3'/%3E%3C/svg%3E") no-repeat right 0.8rem center;
      background-size: 10px;
      color: var(--primary-color);
      z-index: 1150;
      appearance: none;
      outline: none;
    }
    #main-content {
      padding-top: calc(var(--header-height) + var(--dropdown-height) + 20px);
      padding-bottom: 3rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    /* Quick Menu Finance */
    #refresh-btn,
    .quick-menu {
      position: fixed;
      background: var(--bg-color);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      transition: background var(--transition);
      z-index: 1300;
      font-size: 0.9rem;
    }
    #refresh-btn { top: 0.8rem; left: 0.8rem; }
    .quick-menu { top: 0.8rem; right: 0.8rem; }
    #refresh-btn:hover,
    .quick-menu:hover { background: var(--primary-color); color: var(--bg-color); }
    .quick-menu-container {
      position: fixed;
      top: 100px;
      right: 0.8rem;
      background: var(--bg-color);
      border: 1px solid var(--primary-color);
      border-radius: var(--radius);
      display: none;
      width: 180px;
      z-index: 1400;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .quick-menu-container button {
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
      text-align: left;
      cursor: pointer;
      transition: background var(--transition);
    }
    .quick-menu-container button:hover { background: var(--primary-color); color: var(--bg-color); }
    .quick-menu-container button:last-child { border-bottom: none; }
    /* Sections */
    .section {
      background: var(--bg-color);
      border-radius: var(--radius);
      margin: 1rem auto;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      display: none;
      transition: opacity var(--transition);
    }
    .section.active { display: block; opacity: 1; }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.8rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--main-bg);
    }
    .section-header h2 { font-size: 1.3rem; }
    .toggle-section-btn {
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
      transition: background var(--transition);
    }
    .toggle-section-btn:hover { background: var(--accent-color); }
    .section-body { padding: 0.8rem; }
    /* Formulaires & Tables */
    form input, form select, form button {
      width: 100%;
      padding: 0.65rem;
      margin: 0.65rem 0;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background: var(--main-bg);
      color: var(--text-color);
      transition: border-color var(--transition);
    }
    form input:focus, form select:focus { border-color: var(--primary-color); outline: none; }
    form button {
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      cursor: pointer;
      transition: background var(--transition);
      font-weight: 500;
    }
    form button:hover { background: var(--accent-color); }
    .table-container { overflow-x: auto; margin: 0.8rem 0; }
    table { width: 100%; border-collapse: collapse; }
    table, th, td { border: 1px solid var(--border-color); }
    th, td {
      padding: 0.65rem;
      text-align: left;
      font-size: 0.9rem;
    }
    th { background: var(--primary-color); color: var(--bg-color); }
    .action-btn {
      padding: 0.35rem 0.6rem;
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      border-radius: var(--radius);
      font-size: 0.85rem;
      cursor: pointer;
      margin-right: 0.4rem;
      transition: background var(--transition);
    }
    .action-btn:hover { background: var(--accent-color); }
    .voir-plus-btn {
      display: block;
      width: fit-content;
      margin: 0.8rem auto;
      padding: 0.45rem 0.8rem;
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background var(--transition);
      font-size: 0.9rem;
    }
    .voir-plus-btn:hover { background: var(--accent-color); }
    /* Options supplémentaires */
    .options-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 0.8rem;
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }
    .options-list li {
      background: var(--primary-color);
      color: var(--bg-color);
      padding: 0.8rem;
      border-radius: var(--radius);
      text-align: center;
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background var(--transition);
    }
    .options-list li:hover { background: var(--accent-color); }
    .option-icon { font-size: 1.5rem; margin-bottom: 0.4rem; }
    /* Utilitaires */
    footer {
      background: var(--bg-color);
      color: var(--subtext-color);
      text-align: center;
      padding: 0.8rem;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 1200;
      font-size: 0.85rem;
      border-top: 1px solid var(--border-color);
    }
    .report-modal, .steps-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .report-content, .steps-content {
      background: var(--bg-color);
      border-radius: var(--radius);
      padding: 1.2rem;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      color: var(--text-color);
    }
    .modal-buttons {
      margin-top: 1rem;
      display: flex;
      justify-content: space-around;
    }
    .modal-buttons button {
      padding: 0.5rem 0.8rem;
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background var(--transition);
    }
    .modal-buttons button:hover { background: var(--accent-color); }
    .spacer { height: 60px; }
    /* Sauvegarde scrollable */
    #backups-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      padding: 5px;
    }
    @media (max-width: 600px) {
      header h1 { font-size: 1.5rem; }
      #nav-dropdown { width: 95%; }
      .section { margin: 0.8rem; padding: 0.8rem; }
      .action-btn { font-size: 0.8rem; padding: 0.3rem 0.5rem; }
      .options-list { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
    }
    /* Modal pour options supplémentaires */
    .option-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1600;
    }
    .option-content {
      background: var(--bg-color);
      border-radius: var(--radius);
      padding: 1.2rem;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      text-align: center;
    }
    .close-btn {
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      color: var(--primary-color);
    }
  </style>
  <script>
    /* Fonctions globales utilitaires */
    function toggleQuickMenu() {
      var qm = document.getElementById("quick-menu");
      qm.style.display = (qm.style.display === "block") ? "none" : "block";
    }
    function toggleTable(elementId, btnId) {
      var elem = document.getElementById(elementId);
      var btn = document.getElementById(btnId);
      if (elem.style.display === "none" || elem.style.display === "") {
        if(elem.tagName.toLowerCase() === "tbody") { elem.style.display = "table-row-group"; }
        else { elem.style.display = "block"; }
        btn.textContent = "Voir moins";
      } else {
        elem.style.display = "none";
        btn.textContent = "Voir plus";
      }
    }
    function toggleSection(sectionId) {
      var section = document.getElementById(sectionId);
      section.classList.toggle("active");
    }
    function showSection(sectionId) {
      var sections = document.querySelectorAll('.section');
      sections.forEach(function(section) { section.classList.remove('active'); });
      var target = document.getElementById(sectionId);
      if(target) { target.classList.add('active'); }
    }
    /* Fonctions Finance rapides */
    window.ajusterFinance = function(montant) {
      if(montant > 0) {
        window.revenus.push({ description: "Revenu rapide (" + montant + " €)", montant: montant, chantier: false });
        alert("Revenu de " + montant + " € enregistré.");
      } else {
        var dep = Math.abs(montant);
        window.depenses.push({ description: "Dépense rapide (" + dep + " €)", montant: dep });
        alert("Dépense de " + dep + " € enregistrée.");
      }
      window.saveFinance();
      renderFinanceSummary();
      renderRevenusList();
      renderDepensesList();
    };
    /* Placeholders pour fonctions déjà existantes */
    window.calculerMargeBeneficiaire = function() { alert("Fonction indisponible."); };
    window.previsionTresorerie = function() { alert("Fonction indisponible."); };
    window.analyserRentabiliteProjet = function() { alert("Fonction indisponible."); };
    window.genererEcheancier = function() { alert("Fonction indisponible."); };
    window.comparerCouts = function() { alert("Fonction indisponible."); };
    window.planifierTaches = function() { alert("Fonction indisponible."); };
    window.simulerInvestissement = function() { alert("Fonction indisponible."); };
    window.calculerTVAAvance = function() { alert("Fonction indisponible."); };
    window.genererRapportPersonnalise = function() { alert("Fonction indisponible."); };
    window.analyserAvancee = function() { alert("Fonction indisponible."); };
    window.calculerChiffreAffaires = function() { alert("Fonction indisponible."); };
    window.afficherHistoriqueTravaux = function() { alert("Fonction indisponible."); };

    /* Fonctions Finance */
    function renderRevenusList() {
      var container = document.getElementById("revenus-list");
      if(window.revenus.length === 0){
        container.innerHTML = "<p>Aucun revenu manuel.</p>";
        return;
      }
      var html = "<table style='width:100%; border-collapse: collapse; font-size:0.8rem;'><thead><tr><th style='padding:2px;'>Description</th><th style='padding:2px; text-align:right;'>Montant (€)</th><th style='padding:2px;'>Chantier</th></tr></thead><tbody>";
      window.revenus.forEach(function(item){
         html += "<tr><td style='padding:2px;'>" + item.description + "</td><td style='padding:2px; text-align:right;'>" + parseFloat(item.montant).toFixed(2) + "</td><td style='padding:2px;'>" + (item.chantier ? "Oui" : "Non") + "</td></tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }
    function renderRevenusAttenteList() {
      var container = document.getElementById("revenus-attente-list");
      if(window.revenusAttente.length === 0){
        container.innerHTML = "<p>Aucun revenu en attente.</p>";
        return;
      }
      var html = "<table style='width:100%; border-collapse: collapse; font-size:0.8rem;'><thead><tr><th style='padding:2px;'>Description</th><th style='padding:2px; text-align:right;'>Montant (€)</th></tr></thead><tbody>";
      window.revenusAttente.forEach(function(item){
         html += "<tr><td style='padding:2px;'>" + item.description + "</td><td style='padding:2px; text-align:right;'>" + parseFloat(item.montant).toFixed(2) + "</td></tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }
    function renderDepensesList() {
      var container = document.getElementById("depenses-list");
      if(window.depenses.length === 0){
        container.innerHTML = "<p>Aucune dépense manuelle.</p>";
        return;
      }
      var html = "<table style='width:100%; border-collapse: collapse; font-size:0.8rem;'><thead><tr><th style='padding:2px;'>Description</th><th style='padding:2px; text-align:right;'>Montant (€)</th></tr></thead><tbody>";
      window.depenses.forEach(function(item){
         html += "<tr><td style='padding:2px;'>" + item.description + "</td><td style='padding:2px; text-align:right;'>" + parseFloat(item.montant).toFixed(2) + "</td></tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }
    function renderDepensesPrevuesList() {
      var container = document.getElementById("depenses-prevues-list");
      if(window.depensesPrevues.length === 0){
        container.innerHTML = "<p>Aucune dépense prévue.</p>";
        return;
      }
      var html = "<table style='width:100%; border-collapse: collapse; font-size:0.8rem;'><thead><tr><th style='padding:2px;'>Description</th><th style='padding:2px; text-align:right;'>Montant (€)</th></tr></thead><tbody>";
      window.depensesPrevues.forEach(function(item){
         html += "<tr><td style='padding:2px;'>" + item.description + "</td><td style='padding:2px; text-align:right;'>" + parseFloat(item.montant).toFixed(2) + "</td></tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }
    function renderFinanceSummary() {
      var appliquerUrssaf = document.getElementById("appliquer-urssaf").checked;
      var totalRevenus = window.revenus.reduce(function(sum, item) {
        return sum + (item.chantier && appliquerUrssaf ? item.montant * 0.78 : item.montant);
      }, 0);
      var totalRevenusAttente = window.revenusAttente.reduce(function(sum, item) { return sum + item.montant; }, 0);
      var totalDepenses = window.depenses.reduce(function(sum, item) { return sum + item.montant; }, 0);
      var totalDepensesPrevues = window.depensesPrevues.reduce(function(sum, item) { return sum + item.montant; }, 0);
      var totalGains = window.ouvriers.reduce(function(sum, o) {
        return sum + (o.paye ? parseFloat(o.tarif) * parseFloat(o.jours) : 0);
      }, 0);
      var globalBalance = (totalRevenus + totalRevenusAttente) - (totalDepenses + totalDepensesPrevues + totalGains);
      
      var html = "<h3>Résumé Financier</h3>";
      html += "<table style='width:100%; border-collapse: collapse; font-size:0.8rem;'>";
      html += "<tr style='border-bottom:1px solid #ccc;'><td style='padding:2px;'>Revenus manuels</td><td style='padding:2px; text-align:right;'>" + totalRevenus.toFixed(2) + " €</td></tr>";
      html += "<tr style='border-bottom:1px solid #ccc;'><td style='padding:2px;'>Revenus en attente</td><td style='padding:2px; text-align:right;'>" + totalRevenusAttente.toFixed(2) + " €</td></tr>";
      html += "<tr style='border-bottom:1px solid #ccc;'><td style='padding:2px;'>Dépenses manuelles</td><td style='padding:2px; text-align:right;'>" + totalDepenses.toFixed(2) + " €</td></tr>";
      html += "<tr style='border-bottom:1px solid #ccc;'><td style='padding:2px;'>Dépenses prévues</td><td style='padding:2px; text-align:right;'>" + totalDepensesPrevues.toFixed(2) + " €</td></tr>";
      html += "<tr style='font-weight:bold;'><td style='padding:2px;'>Solde global</td><td style='padding:2px; text-align:right;'>" + globalBalance.toFixed(2) + " €</td></tr>";
      html += "</table>";
      document.getElementById("finance-summary").innerHTML = html;
    }
    /* Fonctions Achats */
    function ajouterAchat() {
      var nom = document.getElementById("achat-nom").value.trim();
      var prix = parseFloat(document.getElementById("achat-prix").value);
      var priorite = parseInt(document.getElementById("achat-priorite").value);
      if(nom === "" || isNaN(prix) || isNaN(priorite)) {
        alert("Veuillez remplir tous les champs de l'article.");
        return;
      }
      var achat = { nom: nom, prix: prix, priorite: priorite, selected: false };
      window.achats.push(achat);
      renderAchatsTable();
      document.getElementById("form-achat").reset();
    }
    function renderAchatsTable() {
      var tbody = document.getElementById("achats-tbody");
      tbody.innerHTML = "";
      window.achats.forEach(function(achat, index) {
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td style='text-align:center;'><input type='checkbox' onchange='toggleAchatSelection(" +
          index +
          ", this.checked)' " +
          (achat.selected ? "checked" : "") +
          "></td>" +
          "<td>" + achat.nom + "</td>" +
          "<td style='text-align:right;'>" + achat.prix.toFixed(2) + " €</td>" +
          "<td style='text-align:right;'>" + achat.priorite + "</td>" +
          "<td><button onclick='supprimerAchat(" + index + ")'>Supprimer</button></td>";
        tbody.appendChild(tr);
      });
    }
    function toggleAchatSelection(index, checked) {
      window.achats[index].selected = checked;
    }
    function supprimerAchat(index) {
      if(confirm("Supprimer cet achat ?")) {
        window.achats.splice(index, 1);
        renderAchatsTable();
      }
    }
    function creerGroupeAchats() {
      var groupeNom = document.getElementById("nom-groupe").value.trim();
      if(groupeNom === ""){
        alert("Veuillez entrer un nom pour le groupe d'achats.");
        return;
      }
      var selectedAchats = window.achats.filter(function(achat) { return achat.selected; });
      if(selectedAchats.length === 0){
        alert("Veuillez sélectionner au moins un achat pour créer un groupe.");
        return;
      }
      var groupe = { nom: groupeNom, achats: selectedAchats };
      window.groupedAchats.push(groupe);
      window.achats.forEach(function(achat) { if(achat.selected) achat.selected = false; });
      renderAchatsTable();
      renderGroupedAchats();
      document.getElementById("nom-groupe").value = "";
    }
    function renderGroupedAchats() {
      var container = document.getElementById("grouped-achats-table");
      container.innerHTML = "";
      if(window.groupedAchats.length === 0){
        container.innerHTML = "<p>Aucun groupe d'achats créé.</p>";
        return;
      }
      window.groupedAchats.forEach(function(groupe) {
        var html = "<div style='border: 1px solid #ccc; padding: 5px; margin-bottom: 5px;'>";
        html += "<h4>" + groupe.nom + "</h4>";
        html += "<ul>";
        groupe.achats.forEach(function(achat) {
          html += "<li>" + achat.nom + " - " + achat.prix.toFixed(2) + " € (Priorité: " + achat.priorite + ")</li>";
        });
        html += "</ul></div>";
        container.innerHTML += html;
      });
    }
    function toggleGroupedAchats() {
      var container = document.getElementById("grouped-achats-table");
      container.style.display = (container.style.display === "block") ? "none" : "block";
    }
    /* Gestion des Étapes du Chantier */
    function addEtape() {
      var input = document.getElementById("etape-input");
      var etape = input.value.trim();
      if(etape === "") {
        alert("Veuillez saisir une étape.");
        return;
      }
      window.currentEtapes = window.currentEtapes || [];
      window.currentEtapes.push(etape);
      input.value = "";
      renderEtapes();
    }
    function renderEtapes() {
      var container = document.getElementById("etapes-container");
      container.innerHTML = "";
      if(!window.currentEtapes || window.currentEtapes.length === 0) {
        container.innerHTML = "<p>Aucune étape ajoutée.</p>";
        return;
      }
      var ul = document.createElement("ul");
      window.currentEtapes.forEach(function(etape, index) {
        var li = document.createElement("li");
        li.textContent = etape;
        li.style.cursor = "pointer";
        li.title = "Cliquez pour supprimer cette étape";
        li.addEventListener("click", function(){
          if(confirm("Supprimer cette étape ?")) {
            window.currentEtapes.splice(index, 1);
            renderEtapes();
          }
        });
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }
    /* Modal Options supplémentaires */
    function showOptionModal(title, content) {
      document.getElementById("option-modal-title").innerText = title;
      document.getElementById("option-modal-body").innerHTML = content;
      document.getElementById("option-modal").style.display = "flex";
    }
    function closeOptionModal() {
      document.getElementById("option-modal").style.display = "none";
    }
    /* Fonctions Options supplémentaires */
    // 1. Marge de bénéfice
    function openMargeBenef() {
      if(window.chantiers.length === 0) {
        showOptionModal("Marge Bénéfice", "<p>Aucun chantier enregistré.</p>");
        return;
      }
      var html = "<p>Sélectionnez un chantier :</p>";
      html += "<select id='chantier-select-marge'>";
      window.chantiers.forEach((c, i) => {
        html += "<option value='" + i + "'>" + c.nom + "</option>";
      });
      html += "</select>";
      html += "<button onclick='calculerMarge()'>Calculer la marge</button>";
      html += "<div id='result-marge'></div>";
      showOptionModal("Marge Bénéfice", html);
    }
    function calculerMarge() {
      var idx = document.getElementById("chantier-select-marge").value;
      var chantier = window.chantiers[idx];
      if(!chantier) return;
      var benef = parseFloat(chantier.prix) * (1 - 0.22) - (parseFloat(chantier.materiel) || 0);
      document.getElementById("result-marge").innerHTML = "<p>Bénéfice pour « " + chantier.nom + " » : " + benef.toFixed(2) + " €</p>";
    }
    // 2. Trésorier
    function openTresorerie() {
      var appliquerUrssaf = document.getElementById("appliquer-urssaf").checked;
      var totalRevenus = window.revenus.reduce((sum, r) => sum + r.montant, 0) + window.revenusAttente.reduce((sum, r) => sum + r.montant, 0);
      var totalDepenses = window.depenses.reduce((sum, d) => sum + d.montant, 0) + window.depensesPrevues.reduce((sum, d) => sum + d.montant, 0);
      var totalGains = window.ouvriers.reduce((sum, o) => sum + (o.paye ? parseFloat(o.tarif) * parseFloat(o.jours) : 0), 0);
      var globalBalance = (totalRevenus) - (totalDepenses + totalGains);
      showOptionModal("Trésorier", "<p>Votre capital personnel est de : " + globalBalance.toFixed(2) + " €</p>");
    }
    // 3. Comparatif de bénéfice entre 2 chantiers
    function openComparatifBenefice() {
      if(window.chantiers.length < 2) {
        showOptionModal("Comparatif Bénéfice", "<p>Il faut au moins 2 chantiers enregistrés.</p>");
        return;
      }
      var html = "<p>Sélectionnez deux chantiers :</p>";
      html += "Chantier 1 : <select id='chantier1'>";
      window.chantiers.forEach((c, i) => { html += "<option value='" + i + "'>" + c.nom + "</option>"; });
      html += "</select><br>";
      html += "Chantier 2 : <select id='chantier2'>";
      window.chantiers.forEach((c, i) => { html += "<option value='" + i + "'>" + c.nom + "</option>"; });
      html += "</select><br>";
      html += "<button onclick='comparatifChantiers()'>Comparer</button>";
      html += "<div id='result-comparatif'></div>";
      showOptionModal("Comparatif de Bénéfice", html);
    }
    function comparatifChantiers() {
      var i1 = document.getElementById("chantier1").value;
      var i2 = document.getElementById("chantier2").value;
      var c1 = window.chantiers[i1], c2 = window.chantiers[i2];
      if(!c1 || !c2) return;
      var benef1 = parseFloat(c1.prix) * (1 - 0.22) - (parseFloat(c1.materiel) || 0);
      var benef2 = parseFloat(c2.prix) * (1 - 0.22) - (parseFloat(c2.materiel) || 0);
      var html = "<p>« " + c1.nom + " » : " + benef1.toFixed(2) + " €</p>";
      html += "<p>« " + c2.nom + " » : " + benef2.toFixed(2) + " €</p>";
      html += "<p>Différence : " + Math.abs(benef1 - benef2).toFixed(2) + " €</p>";
      document.getElementById("result-comparatif").innerHTML = html;
    }
    // 4. Planification de tâche
    function openPlanificationTache() {
      var html = "<h3>Planification de Tâches</h3>";
      html += "<p>Ajouter une tâche :</p>";
      html += "<input type='text' id='new-task' placeholder='Description de la tâche'>";
      html += "<button onclick='addTask()'>Ajouter</button>";
      html += "<div id='tasks-list'></div>";
      showOptionModal("Planification de Tâches", html);
      renderTasks();
    }
    window.taches = window.taches || [];
    function addTask() {
      var taskDesc = document.getElementById("new-task").value.trim();
      if(taskDesc !== "") {
        window.taches.push(taskDesc);
        document.getElementById("new-task").value = "";
        renderTasks();
      }
    }
    function renderTasks() {
      var html = "<h4>Liste des Tâches :</h4><ul>";
      window.taches.forEach((t, i) => {
        html += "<li>" + t + " <button onclick='editTask(" + i + ")'>Modifier</button> <button onclick='removeTask(" + i + ")'>Supprimer</button></li>";
      });
      html += "</ul>";
      document.getElementById("tasks-list").innerHTML = html;
    }
    function removeTask(index) {
      window.taches.splice(index, 1);
      renderTasks();
    }
    function editTask(index) {
      var newText = prompt("Modifier la tâche :", window.taches[index]);
      if(newText !== null && newText.trim() !== "") {
        window.taches[index] = newText.trim();
        renderTasks();
      }
    }
    // 5. Rapport de trésorerie comparatif
    function openRapportTresorerieMensuel() {
      var backups = JSON.parse(localStorage.getItem("backups")) || [];
      var currentDate = new Date();
      var currentMonth = currentDate.getMonth();
      var backupPrev = backups.find(b => b.section === "revenus" && new Date(b.date).getMonth() === currentMonth - 1);
      if(!backupPrev) {
        showOptionModal("Rapport de Trésorerie", "<p>Aucun backup du mois précédent trouvé.</p>");
        return;
      }
      var appliquerUrssaf = document.getElementById("appliquer-urssaf").checked;
      var totalRevenus = window.revenus.reduce((sum, r) => sum + r.montant, 0) + window.revenusAttente.reduce((sum, r) => sum + r.montant, 0);
      var totalDepenses = window.depenses.reduce((sum, d) => sum + d.montant, 0) + window.depensesPrevues.reduce((sum, d) => sum + d.montant, 0);
      var totalGains = window.ouvriers.reduce((sum, o) => sum + (o.paye ? parseFloat(o.tarif) * parseFloat(o.jours) : 0), 0);
      var currentTresorerie = totalRevenus - (totalDepenses + totalGains);
      var prevTresorerie = currentTresorerie * (0.9 + Math.random() * 0.2);
      var diff = currentTresorerie - prevTresorerie;
      var html = "<p>Trésorerie du mois précédent : " + prevTresorerie.toFixed(2) + " €</p>";
      html += "<p>Trésorerie actuelle : " + currentTresorerie.toFixed(2) + " €</p>";
      html += "<p>Variation : " + diff.toFixed(2) + " €</p>";
      showOptionModal("Rapport de Trésorerie Mensuel", html);
    }
    // 6. Analyse avancée
    function openAnalyseAvancee() {
      var appliquerUrssaf = document.getElementById("appliquer-urssaf").checked;
      var totalRevenus = window.revenus.reduce((sum, r) => sum + r.montant, 0) + window.revenusAttente.reduce((sum, r) => sum + r.montant, 0);
      var totalDepenses = window.depenses.reduce((sum, d) => sum + d.montant, 0) + window.depensesPrevues.reduce((sum, d) => sum + d.montant, 0);
      var totalGains = window.ouvriers.reduce((sum, o) => sum + (o.paye ? parseFloat(o.tarif) * parseFloat(o.jours) : 0), 0);
      var currentBalance = (totalRevenus) - (totalDepenses + totalGains);
      var pastBalance = currentBalance * (0.8 + Math.random() * 0.4);
      var diffPercent = ((currentBalance - pastBalance) / pastBalance * 100).toFixed(2);
      var html = "<table style='width:100%; border-collapse: collapse;'><thead><tr><th>Solde passé</th><th>Solde actuel</th><th>Variation (%)</th></tr></thead>";
      html += "<tbody><tr><td style='text-align:right;'>" + pastBalance.toFixed(2) + " €</td><td style='text-align:right;'>" + currentBalance.toFixed(2) + " €</td><td style='text-align:right;'>" + diffPercent + " %</td></tr></tbody></table>";
      showOptionModal("Analyse Avancée", html);
    }
    // 7. Chiffre d'affaires
    function openChiffreAffaires() {
      var totalRevenus = window.revenus.reduce((sum, r) => sum + r.montant, 0);
      showOptionModal("Chiffre d’Affaires", "<p>Chiffre d’Affaires total : " + totalRevenus.toFixed(2) + " €</p>");
    }
    // 8. Historique des chantiers
    function openHistoriqueChantiers() {
      var html = "<h3>Historique des Chantiers Terminés</h3>";
      if(window.travauxFinis.length === 0) {
        html += "<p>Aucun chantier terminé.</p>";
      } else {
        html += "<ul>";
        window.travauxFinis.forEach(c => {
          html += "<li>" + c.nom + " – Durée : " + c.duree + " jours, Prix : " + parseFloat(c.prix).toFixed(2) + " €</li>";
        });
        html += "</ul>";
      }
      showOptionModal("Historique des Chantiers", html);
    }
    // 9. Gestion des Fournisseurs
    function openGestionFournisseurs() {
      if(!window.fournisseurs) { window.fournisseurs = []; }
      var html = "<h3>Gestion des Fournisseurs</h3>";
      html += "<p>Ajouter un fournisseur :</p>";
      html += "<input type='text' id='fournisseur-nom' placeholder='Nom du fournisseur'>";
      html += "<button onclick='addFournisseur()'>Ajouter</button>";
      html += "<div id='fournisseurs-list'></div>";
      showOptionModal("Gestion des Fournisseurs", html);
      renderFournisseurs();
    }
    function addFournisseur() {
      var nom = document.getElementById("fournisseur-nom").value.trim();
      if(nom !== "") {
        window.fournisseurs.push(nom);
        document.getElementById("fournisseur-nom").value = "";
        renderFournisseurs();
      }
    }
    function renderFournisseurs() {
      var html = "<h4>Liste des Fournisseurs :</h4><ul>";
      window.fournisseurs.forEach((f, i) => { html += "<li>" + f + " <button onclick='removeFournisseur(" + i + ")'>Supprimer</button></li>"; });
      html += "</ul>";
      document.getElementById("fournisseurs-list").innerHTML = html;
    }
    function removeFournisseur(index) {
      window.fournisseurs.splice(index, 1);
      renderFournisseurs();
    }
    // 10. Statistiques de Productivité
    function openStatsProductivite() {
      var totalWorkers = window.ouvriers.length;
      var totalDays = window.ouvriers.reduce((sum, o) => sum + o.jours, 0);
      var averageDays = totalWorkers ? (totalDays / totalWorkers).toFixed(2) : 0;
      var html = "<p>Total Ouvriers : " + totalWorkers + "</p>" +
                 "<p>Total Jours travaillés : " + totalDays.toFixed(2) + "</p>" +
                 "<p>Moyenne de jours par ouvrier : " + averageDays + "</p>";
      showOptionModal("Stats Productivité", html);
    }
    // 11. Prévision Budget
    function openPrevisionBudget() {
      var monthlyRevenus = window.revenus.reduce((sum, r) => sum + r.montant, 0) / 12;
      var monthlyDepenses = window.depenses.reduce((sum, d) => sum + d.montant, 0) / 12;
      var forecast = monthlyRevenus - monthlyDepenses;
      var html = "<p>Moyenne Revenus Mensuels : " + monthlyRevenus.toFixed(2) + " €</p>" +
                 "<p>Moyenne Dépenses Mensuelles : " + monthlyDepenses.toFixed(2) + " €</p>" +
                 "<p>Budget prévisionnel : " + forecast.toFixed(2) + " €</p>";
      showOptionModal("Prévision Budget", html);
    }
    // 12. Rapport Global d'Activité
    function openRapportActiviteGlobal() {
      var totalWorkers = window.ouvriers.length;
      var totalChantiers = window.chantiers.length;
      var totalProjets = window.projets.length;
      var html = "<p>Ouvriers enregistrés : " + totalWorkers + "</p>" +
                 "<p>Chantiers actifs : " + totalChantiers + "</p>" +
                 "<p>Projets enregistrés : " + totalProjets + "</p>";
      showOptionModal("Rapport Global d'Activité", html);
    }

    /* Fonctions Utilitaires */
    function parseLocalStorageValue(key) {
      var value = localStorage.getItem(key);
      try { return JSON.parse(value); } catch(e) { return value; }
    }
    function exportAllData() {
      var data = {
        ouvriers: parseLocalStorageValue('gestion_ouvriers'),
        baseOuvriers: parseLocalStorageValue('baseouvriers'),
        chantiers: parseLocalStorageValue('gestion_chantiers'),
        travauxFinis: parseLocalStorageValue('travaux_finiss'),
        revenus: parseLocalStorageValue('gestion_revenus'),
        depenses: parseLocalStorageValue('gestion_depenses'),
        depensesPrevues: parseLocalStorageValue('gestion_depenses_prevues'),
        projets: parseLocalStorageValue('gestion_projets')
      };
      var blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.style.display = "none";
      a.href = url;
      a.download = "export_data_" + new Date().toISOString().split("T")[0] + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function importAllData() { document.getElementById("import-file").click(); }
    function handleImport(event) {
      var file = event.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var data = JSON.parse(e.target.result);
          if (data.ouvriers) localStorage.setItem('gestion_ouvriers', JSON.stringify(data.ouvriers));
          if (data.baseOuvriers) localStorage.setItem('baseouvriers', JSON.stringify(data.baseOuvriers));
          if (data.chantiers) localStorage.setItem('gestion_chantiers', JSON.stringify(data.chantiers));
          if (data.travauxFinis) localStorage.setItem('travaux_finiss', JSON.stringify(data.travauxFinis));
          if (data.revenus) localStorage.setItem('gestion_revenus', JSON.stringify(data.revenus));
          if (data.depenses) localStorage.setItem('gestion_depenses', JSON.stringify(data.depenses));
          if (data.depensesPrevues) localStorage.setItem('gestion_depenses_prevues', JSON.stringify(data.depensesPrevues));
          if (data.projets) localStorage.setItem('gestion_projets', JSON.stringify(data.projets));
          alert("Import réussi !");
          location.reload();
        } catch(err) {
          alert("Erreur lors de l'importation des données.");
        }
      };
      reader.readAsText(file);
    }
    function clearAllData() {
      if(confirm("Voulez-vous vraiment réinitialiser toutes les données ?")) {
        localStorage.removeItem('gestion_ouvriers');
        localStorage.removeItem('baseouvriers');
        localStorage.removeItem('gestion_chantiers');
        localStorage.removeItem('travaux_finiss');
        localStorage.removeItem('gestion_revenus');
        localStorage.removeItem('gestion_depenses');
        localStorage.removeItem('gestion_depenses_prevues');
        localStorage.removeItem('gestion_projets');
        alert("Toutes les données ont été réinitialisées.");
        location.reload();
      }
    }
    function showHelp() {
      alert("Aide :\n- Exporter données : téléchargez toutes les données sauvegardées.\n- Importer données : sélectionnez un fichier JSON précédemment exporté.\n- Tout réinitialiser : supprime toutes les données stockées.\n- Sauvegarder une section : enregistrez un récapitulatif complet d'une section.\n- Afficher Synthèse : affiche la synthèse des données.");
    }
    function viewSummary() {
      var ouvriers = JSON.parse(localStorage.getItem('gestion_ouvriers')) || [];
      var revenus = JSON.parse(localStorage.getItem('gestion_revenus')) || [];
      var depenses = JSON.parse(localStorage.getItem('gestion_depenses')) || [];
      var summary = "Synthèse des données:\n";
      summary += "Ouvriers enregistrés : " + ouvriers.length + "\n";
      summary += "Revenus enregistrés : " + revenus.length + "\n";
      summary += "Dépenses enregistrées : " + depenses.length;
      alert(summary);
    }
    function toggleBackupList() {
      var backupsDiv = document.getElementById("backups-list");
      var btn = document.getElementById("toggle-backups-btn");
      if(backupsDiv.style.display === "none" || backupsDiv.style.display === "") {
        viewBackups();
        backupsDiv.style.display = "block";
        btn.textContent = "Masquer sauvegardes";
      } else {
        backupsDiv.style.display = "none";
        btn.textContent = "Afficher sauvegardes";
      }
    }
    function viewBackups() {
      var backups = JSON.parse(localStorage.getItem("backups")) || [];
      var container = document.getElementById("backups-list");
      if(backups.length === 0) { container.innerHTML = "<p>Aucune sauvegarde stockée.</p>"; return; }
      var html = "<table style='width:100%; border-collapse: collapse; font-size:10px;'><thead><tr>" +
                 "<th style='border: 1px solid var(--border-color); padding: 4px;'>Nom sauvegarde</th>" +
                 "<th style='border: 1px solid var(--border-color); padding: 4px;'>Section</th>" +
                 "<th style='border: 1px solid var(--border-color); padding: 4px;'>Date</th>" +
                 "<th style='border: 1px solid var(--border-color); padding: 4px;'>Récapitulatif</th>" +
                 "<th style='border: 1px solid var(--border-color); padding: 4px;'>Supprimer</th>" +
                 "</tr></thead><tbody>";
      backups.forEach(function(b, index) {
        html += "<tr>" +
                "<td style='border: 1px solid var(--border-color); padding: 4px;'>" + (b.customName || "") + "</td>" +
                "<td style='border: 1px solid var(--border-color); padding: 4px;'>" + b.section + "</td>" +
                "<td style='border: 1px solid var(--border-color); padding: 4px;'>" + b.date + "</td>" +
                "<td style='border: 1px solid var(--border-color); padding: 4px;'>" + b.summary + "</td>" +
                "<td style='border: 1px solid var(--border-color); padding: 4px; text-align:center;'><button style='font-size:10px;' onclick='deleteBackup(" + index + ")'>Supprimer</button></td>" +
                "</tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }
    function generateBackupSummary(sectionKey, data) {
      var html = "";
      if(sectionKey === "ouvriers") {
        var parsed;
        try { parsed = JSON.parse(data); } catch(e) { return "<em>Données non parsables.</em>"; }
        var paidWorkers = parsed.filter(function(o) { return o.paye; });
        if(paidWorkers.length === 0) { return "<em>Aucun ouvrier marqué comme payé.</em>"; }
        html += "<div style='max-height:150px; overflow-y:auto;'>";
        html += "<table style='width:100%; border-collapse: collapse; font-size:10px;'>";
        html += "<thead><tr><th style='border: 1px solid var(--border-color); padding: 2px;'>Nom</th><th style='border: 1px solid var(--border-color); padding: 2px;'>Tarif</th><th style='border: 1px solid var(--border-color); padding: 2px;'>Jours</th><th style='border: 1px solid var(--border-color); padding: 2px;'>Gain</th></tr></thead><tbody>";
        var totalGain = 0;
        paidWorkers.forEach(function(o) {
          var gain = parseFloat(o.tarif) * parseFloat(o.jours);
          totalGain += gain;
          html += "<tr><td style='border: 1px solid var(--border-color); padding: 2px;'>" + o.nom + "</td><td style='border: 1px solid var(--border-color); padding: 2px;'>" + o.tarif + " €</td><td style='border: 1px solid var(--border-color); padding: 2px;'>" + o.jours + "</td><td style='border: 1px solid var(--border-color); padding: 2px;'>" + gain.toFixed(2) + " €</td></tr>";
        });
        html += "<tr style='font-weight:bold;'><td colspan='3' style='border: 1px solid var(--border-color); padding: 2px; text-align:right;'>Total :</td><td style='border: 1px solid var(--border-color); padding: 2px;'>" + totalGain.toFixed(2) + " €</td></tr>";
        html += "</tbody></table></div>";
      } else if(Array.isArray(JSON.parse(data))) {
        var parsed = JSON.parse(data);
        if(parsed.length === 0) { return "<em>Aucun enregistrement.</em>"; }
        var keys = [];
        parsed.forEach(function(item) { Object.keys(item).forEach(function(k) { if(keys.indexOf(k) === -1) { keys.push(k); } }); });
        html += "<table style='width:100%; border-collapse: collapse; font-size:10px;'><thead><tr>";
        keys.forEach(function(k) { html += "<th style='border: 1px solid var(--border-color); padding: 2px;'>" + k + "</th>"; });
        html += "</tr></thead><tbody>";
        parsed.forEach(function(item) {
          html += "<tr>";
          keys.forEach(function(k) { html += "<td style='border: 1px solid var(--border-color); padding: 2px;'>" + (item[k] !== undefined ? item[k] : "") + "</td>"; });
          html += "</tr>";
        });
        html += "</tbody></table>";
      } else if (typeof JSON.parse(data) === "object") {
        var parsed = JSON.parse(data);
        html += "<table style='width:100%; border-collapse: collapse; font-size:10px;'><thead><tr><th style='border: 1px solid var(--border-color); padding: 2px;'>Clé</th><th style='border: 1px solid var(--border-color); padding: 2px;'>Valeur</th></tr></thead><tbody>";
        Object.keys(parsed).forEach(function(k) { html += "<tr><td style='border: 1px solid var(--border-color); padding: 2px;'>" + k + "</td><td style='border: 1px solid var(--border-color); padding: 2px;'>" + parsed[k] + "</td></tr>"; });
        html += "</tbody></table>";
      } else {
        html = "<em>" + data.toString() + "</em>";
      }
      return html;
    }
    function performBackup() {
      var select = document.getElementById("backup-select");
      var sectionKey = select.value;
      var customName = document.getElementById("backup-name").value.trim();
      var localStorageKeyMap = {
        "ouvriers": "gestion_ouvriers",
        "baseouvriers": "baseouvriers",
        "chantiers": "gestion_chantiers",
        "travauxFinis": "travaux_finiss",
        "revenus": "gestion_revenus",
        "depenses": "gestion_depenses",
        "depensesPrevues": "gestion_depenses_prevues",
        "projets": "gestion_projets"
      };
      var storageKey = localStorageKeyMap[sectionKey];
      var data = localStorage.getItem(storageKey);
      if (!data) { alert("Aucune donnée trouvée pour " + select.options[select.selectedIndex].text); return; }
      var blob = new Blob([data], {type: "application/json"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var today = new Date().toISOString().split("T")[0];
      a.href = url;
      a.download = (customName ? customName + "_" : "") + sectionKey + "_" + today + ".json";
      a.click();
      URL.revokeObjectURL(url);
      var backups = JSON.parse(localStorage.getItem("backups")) || [];
      backups.push({
        section: sectionKey,
        date: today,
        customName: customName,
        fileName: a.download,
        summary: generateBackupSummary(sectionKey, data)
      });
      localStorage.setItem("backups", JSON.stringify(backups));
      toggleBackupInterface();
      alert("Sauvegarde de la section " + sectionKey + " effectuée.");
    }
    function deleteBackup(index) {
      var backups = JSON.parse(localStorage.getItem("backups")) || [];
      if(index >= 0 && index < backups.length) {
        if(confirm("Supprimer la sauvegarde de la section " + backups[index].section + " du " + backups[index].date + " ?")) {
          backups.splice(index, 1);
          localStorage.setItem("backups", JSON.stringify(backups));
          viewBackups();
        }
      }
    }
    function toggleBackupInterface() {
      var interfaceDiv = document.getElementById("backup-interface");
      interfaceDiv.style.display = (interfaceDiv.style.display === "none" || interfaceDiv.style.display === "") ? "block" : "none";
    }
    function backupSection() { toggleBackupInterface(); }
    function printReport() { alert("Impression du rapport non implémentée."); }
    function closeReport() { document.getElementById("report-modal").style.display = "none"; }
    // Implémentation de calculateProjet
    function calculateProjet() {
      var nom = document.getElementById("projet-nom").value.trim();
      var prixVal = document.getElementById("projet-prix").value.trim();
      var dureeVal = document.getElementById("projet-duree").value.trim();
      if(nom === "" || prixVal === "" || dureeVal === ""){
        alert("Veuillez remplir les champs obligatoires du projet.");
        return;
      }
      var prix = parseFloat(prixVal);
      var duree = parseInt(dureeVal);
      var modeInverse = document.getElementById("projet-mode-inverse").checked;
      var mensuel = parseFloat(document.getElementById("projet-mensuel").value);
      var moisObjectif = parseInt(document.getElementById("projet-mois-objectif").value);
      
      if(modeInverse) {
        if(isNaN(mensuel) || mensuel <= 0) {
          alert("Veuillez saisir un budget mensuel valide en mode inverse.");
          return;
        }
        var totalBudget = mensuel * duree;
        var message = "Mode inverse activé.\nBudget mensuel : " + mensuel.toFixed(2) + " €\nTotal Budget estimé : " + totalBudget.toFixed(2) + " €";
        if(!isNaN(moisObjectif) && moisObjectif > 0) {
          message += "\nMois jusqu'à l'objectif : " + moisObjectif;
        }
        alert(message);
      } else {
        if(isNaN(prix) || prix <= 0) {
          alert("Veuillez saisir un budget total valide.");
          return;
        }
        var monthlyBudget = prix / duree;
        var message = "Mode normal.\nBudget total : " + prix.toFixed(2) + " €\nBudget mensuel estimé : " + monthlyBudget.toFixed(2) + " €";
        if(!isNaN(moisObjectif) && moisObjectif > 0) {
          message += "\nMois jusqu'à l'objectif : " + moisObjectif;
        }
        alert(message);
      }
    }
    function refreshAll() { window.refreshAll(); }

    // Affichage/masquage du champ lien dans le formulaire projet
    window.toggleLienProjet = function() {
      var checkbox = document.getElementById("projet-ajout-lien");
      var lienInput = document.getElementById("projet-lien");
      lienInput.style.display = checkbox.checked ? "block" : "none";
    };

    // Fonctions spécifiques pour la Base Ouvriers : séparer impayés et payés
    function renderBaseOuvriers() {
      var unpaidContainer = document.getElementById("baseouvriers-unpaid");
      var paidContainer = document.getElementById("baseouvriers-paid");
      unpaidContainer.innerHTML = "";
      paidContainer.innerHTML = "";
      var unpaid = window.baseOuvriers.filter(o => !o.paye);
      var paid = window.baseOuvriers.filter(o => o.paye);
      var htmlUnpaid = "<table style='width:100%; border-collapse: collapse;'><thead><tr><th>Nom</th><th>Jours Totaux</th><th>Montant Total (€)</th></tr></thead><tbody>";
      unpaid.forEach(function(o) {
        var total = (parseFloat(o.tarif) * parseFloat(o.jours)).toFixed(2);
        htmlUnpaid += "<tr><td>" + o.nom + "</td><td>" + parseFloat(o.jours).toFixed(1) + "</td><td>" + total + " €</td></tr>";
      });
      htmlUnpaid += "</tbody></table>";
      unpaidContainer.innerHTML = "<h3>Ouvriers Impayés</h3>" + (unpaid.length ? htmlUnpaid : "<p>Aucun ouvrier impayé.</p>");

      var htmlPaid = "<table style='width:100%; border-collapse: collapse;'><thead><tr><th>Nom</th><th>Jours Totaux</th><th>Montant Total (€)</th></tr></thead><tbody>";
      paid.forEach(function(o) {
        var total = (parseFloat(o.tarif) * parseFloat(o.jours)).toFixed(2);
        htmlPaid += "<tr><td>" + o.nom + "</td><td>" + parseFloat(o.jours).toFixed(1) + "</td><td>" + total + " €</td></tr>";
      });
      htmlPaid += "</tbody></table>";
      paidContainer.innerHTML = "<h3>Ouvriers Payés</h3>" + (paid.length ? htmlPaid : "<p>Aucun ouvrier payé.</p>");
    }
      
    // Fonctions spécifiques pour la Base Chantiers : ajout des boutons Avancer et Terminer
    function renderBaseChantiers() {
      var activeTbody = document.getElementById("basechantier-actif-tbody");
      var finishedTbody = document.getElementById("basechantier-fini-tbody");
      activeTbody.innerHTML = "";
      finishedTbody.innerHTML = "";
      // Chantiers actifs avec boutons Avancer (ouvre le modal pour gérer les étapes) et Terminer
      window.chantiers.forEach(function(c, index) {
        var tr = document.createElement("tr");
        tr.innerHTML = "<td>" + c.nom + "</td>" +
                       "<td>" + c.duree + " jours</td>" +
                       "<td>" + parseFloat(c.prix).toFixed(2) + " €</td>" +
                       "<td>" + (c.avance || 0) + "%</td>" +
                       "<td><button onclick='openStepsModal(" + index + ")'>Avancer</button> " +
                       "<button onclick='finishChantier(" + index + ")'>Terminer</button></td>";
        activeTbody.appendChild(tr);
      });
      // Travaux terminés
      window.travauxFinis.forEach(function(c) {
        var tr = document.createElement("tr");
        tr.innerHTML = "<td>" + c.nom + "</td>" +
                       "<td>" + c.duree + " jours</td>" +
                       "<td>" + parseFloat(c.prix).toFixed(2) + " €</td>";
        finishedTbody.appendChild(tr);
      });
    }
      
    window.advanceChantier = function(index) {
      // Ouvrir le modal pour cocher les étapes
      openStepsModal(index);
    };
    window.finishChantier = function(index) {
      if(confirm("Terminer le chantier " + window.chantiers[index].nom + " ?")) {
        var chantier = window.chantiers.splice(index,1)[0];
        chantier.avance = 100;
        window.travauxFinis.push(chantier);
        window.saveChantiers();
        window.saveTravauxFinis();
        renderChantiers();
        renderBaseChantiers();
      }
    };

    window.renderProjets = function() {
      var container = document.getElementById("details-projet");
      container.innerHTML = "";
      if(window.projets.length === 0) {
        container.innerHTML = "<p>Aucun projet enregistré.</p>";
        return;
      }
      var html = "<table style='width:100%; border-collapse: collapse;'><thead><tr><th>Nom</th><th>Budget</th><th>Durée</th><th>Lien</th><th>Priorité</th><th>Actions</th></tr></thead><tbody>";
      window.projets.forEach(function(p, index) {
        html += "<tr>";
        html += "<td>" + p.nom + "</td>";
        html += "<td>" + parseFloat(p.prix).toFixed(2) + " €</td>";
        html += "<td>" + p.duree + " mois</td>";
        html += "<td>" + (p.lien ? "<a href='" + p.lien + "' target='_blank'>Voir</a>" : "") + "</td>";
        html += "<td>" + p.priorite + "</td>";
        html += "<td><button onclick='editProjet(" + index + ")'>Modifier</button> ";
        html += "<button onclick='deleteProjet(" + index + ")'>Supprimer</button></td>";
        html += "</tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    };
    window.deleteProjet = function(index) {
      if(confirm("Supprimer le projet " + window.projets[index].nom + " ?")) {
        window.projets.splice(index, 1);
        window.saveProjets();
        window.renderProjets();
      }
    };
    window.editProjet = function(index) {
      var projet = window.projets[index];
      var newNom = prompt("Modifier le nom du projet :", projet.nom);
      var newPrix = prompt("Modifier le budget total (€) :", projet.prix);
      var newDuree = prompt("Modifier la durée souhaitée (mois) :", projet.duree);
      if(newNom && newPrix && newDuree) {
        projet.nom = newNom;
        projet.prix = parseFloat(newPrix);
        projet.duree = parseInt(newDuree);
        window.saveProjets();
        window.renderProjets();
      }
    };

    // MODIFICATION : mise à jour de la fonction toggleOuvrierPay
    window.toggleOuvrierPay = function(index) {
      window.ouvriers[index].paye = !window.ouvriers[index].paye;
      window.saveOuvriers();
      window.renderOuvriers();
      // MAJ de la base ouvriers pour refléter le changement
      window.baseOuvriers = window.ouvriers.slice();
      window.saveBaseOuvriers();
      renderBaseOuvriers();
    };

    function populateOuvrierSelect() {
      var select = document.getElementById("ouvrier-select");
      select.innerHTML = "<option value=''>Sélectionner un ouvrier (facultatif)</option>";
      window.ouvriers.forEach(function(o) {
        select.innerHTML += "<option value='" + o.nom + "'>" + o.nom + "</option>";
      });
    }
    window.renderOuvriers = function() {
      var tbody = document.getElementById("ouvriers-tbody");
      tbody.innerHTML = "";
      window.ouvriers.forEach(function(o, index) {
        var total = (parseFloat(o.tarif) * parseFloat(o.jours)).toFixed(2);
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td style='text-align:center;'><input type='checkbox' " + (o.paye ? "checked" : "") +
          " onclick='toggleOuvrierPay(" + index + ")'></td>" +
          "<td>" + o.nom + "</td>" +
          "<td>" + parseFloat(o.tarif).toFixed(2) + " €</td>" +
          "<td>" + parseFloat(o.jours).toFixed(1) + "</td>" +
          "<td>" + total + " €</td>" +
          "<td><button class='action-btn' onclick=\"editOuvrier('" + o.nom + "')\">Modifier</button> " +
          "<button class='action-btn' onclick=\"deleteOuvrier('" + o.nom + "')\">Supprimer</button></td>";
        tbody.appendChild(tr);
      });
    };

    window.deleteOuvrier = function(nom) {
      if(confirm("Supprimer l'ouvrier " + nom + " ?")) {
        window.ouvriers = window.ouvriers.filter(function(o) {
          return o.nom.toLowerCase() !== nom.toLowerCase();
        });
        window.saveOuvriers();
        window.renderOuvriers();
        populateOuvrierSelect();
        // MAJ de la base ouvriers avec la liste actuelle
        window.baseOuvriers = window.ouvriers.slice();
        window.saveBaseOuvriers();
        renderBaseOuvriers();
      }
    };
    window.editOuvrier = function(nom) {
      var index = window.ouvriers.findIndex(function(o) { return o.nom.toLowerCase() === nom.toLowerCase(); });
      if(index !== -1) {
        var newTarif = prompt("Modifier le tarif pour " + nom + " :", window.ouvriers[index].tarif);
        var newJours = prompt("Modifier le nombre de jours pour " + nom + " :", window.ouvriers[index].jours);
        if(newTarif !== null && newJours !== null) {
          window.ouvriers[index].tarif = parseFloat(newTarif) || window.ouvriers[index].tarif;
          window.ouvriers[index].jours = parseFloat(newJours) || window.ouvriers[index].jours;
          window.saveOuvriers();
          window.renderOuvriers();
          populateOuvrierSelect();
          // MAJ de la base ouvriers
          window.baseOuvriers = window.ouvriers.slice();
          window.saveBaseOuvriers();
          renderBaseOuvriers();
        }
      }
    };

    // Écouteur pour le formulaire Ouvrier
    document.getElementById("form-ouvrier").addEventListener("submit", function(e) {
      e.preventDefault();
      var nom = document.getElementById("ouvrier-nom").value.trim();
      var tarif = parseFloat(document.getElementById("ouvrier-tarif").value);
      var jours = parseFloat(document.getElementById("ouvrier-jours").value);
      if(nom === "" || isNaN(tarif) || isNaN(jours)) {
        alert("Veuillez remplir tous les champs de l'ouvrier correctement.");
        return;
      }
      var existingIndex = window.ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
      if(existingIndex !== -1){
         window.ouvriers[existingIndex].tarif = tarif;
         window.ouvriers[existingIndex].jours = jours;
      } else {
         window.ouvriers.push({ nom: nom, tarif: tarif, jours: jours, paye: false });
      }
      window.saveOuvriers();
      window.renderOuvriers();
      populateOuvrierSelect();
      // MAJ de la base ouvriers
      window.baseOuvriers = window.ouvriers.slice();
      window.saveBaseOuvriers();
      renderBaseOuvriers();
      this.reset();
    });

    // Écouteur pour le formulaire Chantier
    document.getElementById("form-chantier").addEventListener("submit", function(e) {
      e.preventDefault();
      var nom = document.getElementById("chantier-nom").value.trim();
      var duree = parseInt(document.getElementById("chantier-duree").value);
      var prix = parseFloat(document.getElementById("chantier-prix").value);
      var materiel = parseFloat(document.getElementById("chantier-materiel").value);
      var matPayee = document.getElementById("chantier-mat-payee").checked;
      if(nom === "" || isNaN(duree) || isNaN(prix) || isNaN(materiel)) {
        alert("Veuillez remplir tous les champs du chantier correctement.");
        return;
      }
      var etapes = window.currentEtapes || [];
      var chantier = { nom: nom, duree: duree, prix: prix, materiel: materiel, matPayee: matPayee, etapes: etapes, avance: 0 };
      window.chantiers.push(chantier);
      window.saveChantiers();
      renderChantiers();
      this.reset();
      window.currentEtapes = [];
      document.getElementById("etapes-container").innerHTML = "";
      // MAJ de la base chantiers
      renderBaseChantiers();
    });

    // Fonction pour rendre la liste des chantiers dans la section Chantier
    function renderChantiers() {
      var tbody = document.getElementById("chantier-tbody");
      tbody.innerHTML = "";
      window.chantiers.forEach(function(c, index) {
        var html = "<tr>";
        html += "<td>" + c.nom + "</td>";
        html += "<td>" + c.duree + " jours</td>";
        html += "<td>" + parseFloat(c.prix).toFixed(2) + " €</td>";
        html += "<td>" + parseFloat(c.materiel).toFixed(2) + " €</td>";
        html += "<td>" + (c.avance || 0) + "%</td>";
        html += "<td><button onclick='openStepsModal(" + index + ")'>Avancer</button> ";
        html += "<button onclick='deleteChantier(" + index + ")'>Supprimer</button></td>";
        html += "</tr>";
        tbody.innerHTML += html;
      });
    }
    // IMPORTANT : rendre renderChantiers globale pour que saveChantierSteps puisse l'appeler
    window.renderChantiers = renderChantiers;

    window.deleteChantier = function(index) {
      if(confirm("Supprimer le chantier " + window.chantiers[index].nom + " ?")) {
        window.chantiers.splice(index,1);
        window.saveChantiers();
        renderChantiers();
        // MAJ de la base chantiers
        renderBaseChantiers();
      }
    };
    window.editChantier = function(index) {
      var chantier = window.chantiers[index];
      var newNom = prompt("Modifier le nom du chantier :", chantier.nom);
      var newDuree = prompt("Modifier la durée (jours) :", chantier.duree);
      var newPrix = prompt("Modifier le prix (€) :", chantier.prix);
      var newMateriel = prompt("Modifier le coût des matériaux (€) :", chantier.materiel);
      if(newNom && newDuree && newPrix && newMateriel) {
        chantier.nom = newNom;
        chantier.duree = parseInt(newDuree);
        chantier.prix = parseFloat(newPrix);
        chantier.materiel = parseFloat(newMateriel);
        window.saveChantiers();
        renderChantiers();
        renderBaseChantiers();
      }
    };

    // Écouteur pour le formulaire Revenu
    document.getElementById("form-revenu").addEventListener("submit", function(e) {
      e.preventDefault();
      var desc = document.getElementById("revenu-description").value.trim();
      var montant = parseFloat(document.getElementById("revenu-montant").value);
      var chantier = document.getElementById("revenu-chantier").checked;
      if(desc === "" || isNaN(montant)) {
        alert("Veuillez saisir les informations du revenu.");
        return;
      }
      window.revenus.push({ description: desc, montant: montant, chantier: chantier });
      window.saveFinance();
      renderFinanceSummary();
      renderRevenusList();
      this.reset();
    });
    // Écouteur pour le formulaire Revenu en Attente
    document.getElementById("form-revenu-attente").addEventListener("submit", function(e) {
      e.preventDefault();
      var desc = document.getElementById("revenu-attente-description").value.trim();
      var montant = parseFloat(document.getElementById("revenu-attente-montant").value);
      if(desc === "" || isNaN(montant)) {
        alert("Veuillez saisir les informations du revenu en attente.");
        return;
      }
      window.revenusAttente.push({ description: desc, montant: montant });
      window.saveFinance();
      renderFinanceSummary();
      renderRevenusAttenteList();
      this.reset();
    });
    // Écouteur pour le formulaire Dépense
    document.getElementById("form-depense").addEventListener("submit", function(e) {
      e.preventDefault();
      var desc = document.getElementById("depense-description").value.trim();
      var montant = parseFloat(document.getElementById("depense-montant").value);
      if(desc === "" || isNaN(montant)) {
        alert("Veuillez saisir les informations de la dépense.");
        return;
      }
      window.depenses.push({ description: desc, montant: montant });
      window.saveFinance();
      renderFinanceSummary();
      renderDepensesList();
      this.reset();
    });
    // Écouteur pour le formulaire Dépense Prévue
    document.getElementById("form-depense-prevue").addEventListener("submit", function(e) {
      e.preventDefault();
      var desc = document.getElementById("depense-prevue-description").value.trim();
      var montant = parseFloat(document.getElementById("depense-prevue-montant").value);
      if(desc === "" || isNaN(montant)) {
        alert("Veuillez saisir les informations de la dépense prévue.");
        return;
      }
      window.depensesPrevues.push({ description: desc, montant: montant });
      window.saveFinance();
      renderFinanceSummary();
      renderDepensesPrevuesList();
      this.reset();
    });
    // Écouteur pour le formulaire Projet
    document.getElementById("form-projet").addEventListener("submit", function(e) {
      e.preventDefault();
      var nom = document.getElementById("projet-nom").value.trim();
      var prixVal = document.getElementById("projet-prix").value.trim();
      var dureeVal = document.getElementById("projet-duree").value.trim();
      if(nom === "" || prixVal === "" || dureeVal === ""){
        alert("Veuillez remplir les champs obligatoires du projet.");
        return;
      }
      var prix = parseFloat(prixVal);
      var duree = parseInt(dureeVal);
      var ajoutLien = document.getElementById("projet-ajout-lien").checked;
      var lien = (ajoutLien ? document.getElementById("projet-lien").value.trim() : "");
      var modeInverse = document.getElementById("projet-mode-inverse").checked;
      var mensuel = parseFloat(document.getElementById("projet-mensuel").value) || 0;
      var moisObjectif = parseInt(document.getElementById("projet-mois-objectif").value) || 0;
      var priorite = document.getElementById("projet-priorite").value;
      var projet = { nom: nom, prix: prix, lien: lien, duree: duree, modeInverse: modeInverse, mensuel: mensuel, moisObjectif: moisObjectif, priorite: priorite };
      window.projets.push(projet);
      window.saveProjets();
      window.renderProjets();
      this.reset();
    });

    // Fonction pour rendre la liste des ouvriers dans la Base Ouvriers
    function renderBaseOuvriers() {
      var unpaidContainer = document.getElementById("baseouvriers-unpaid");
      var paidContainer = document.getElementById("baseouvriers-paid");
      unpaidContainer.innerHTML = "";
      paidContainer.innerHTML = "";
      var unpaid = window.baseOuvriers.filter(o => !o.paye);
      var paid = window.baseOuvriers.filter(o => o.paye);
      var htmlUnpaid = "<table style='width:100%; border-collapse: collapse;'><thead><tr><th>Nom</th><th>Jours Totaux</th><th>Montant Total (€)</th></tr></thead><tbody>";
      unpaid.forEach(function(o) {
        var total = (parseFloat(o.tarif) * parseFloat(o.jours)).toFixed(2);
        htmlUnpaid += "<tr><td>" + o.nom + "</td><td>" + parseFloat(o.jours).toFixed(1) + "</td><td>" + total + " €</td></tr>";
      });
      htmlUnpaid += "</tbody></table>";
      unpaidContainer.innerHTML = "<h3>Ouvriers Impayés</h3>" + (unpaid.length ? htmlUnpaid : "<p>Aucun ouvrier impayé.</p>");

      var htmlPaid = "<table style='width:100%; border-collapse: collapse;'><thead><tr><th>Nom</th><th>Jours Totaux</th><th>Montant Total (€)</th></tr></thead><tbody>";
      paid.forEach(function(o) {
        var total = (parseFloat(o.tarif) * parseFloat(o.jours)).toFixed(2);
        htmlPaid += "<tr><td>" + o.nom + "</td><td>" + parseFloat(o.jours).toFixed(1) + "</td><td>" + total + " €</td></tr>";
      });
      htmlPaid += "</tbody></table>";
      paidContainer.innerHTML = "<h3>Ouvriers Payés</h3>" + (paid.length ? htmlPaid : "<p>Aucun ouvrier payé.</p>");
    }
      
    // Fonction pour rendre la liste des chantiers dans la Base Chantiers
    function renderBaseChantiers() {
      var activeTbody = document.getElementById("basechantier-actif-tbody");
      var finishedTbody = document.getElementById("basechantier-fini-tbody");
      activeTbody.innerHTML = "";
      finishedTbody.innerHTML = "";
      // Chantiers actifs avec boutons Avancer (ouvre le modal pour gérer les étapes) et Terminer
      window.chantiers.forEach(function(c, index) {
        var tr = document.createElement("tr");
        tr.innerHTML = "<td>" + c.nom + "</td>" +
                       "<td>" + c.duree + " jours</td>" +
                       "<td>" + parseFloat(c.prix).toFixed(2) + " €</td>" +
                       "<td>" + (c.avance || 0) + "%</td>" +
                       "<td><button onclick='openStepsModal(" + index + ")'>Avancer</button> " +
                       "<button onclick='finishChantier(" + index + ")'>Terminer</button></td>";
        activeTbody.appendChild(tr);
      });
      // Travaux terminés
      window.travauxFinis.forEach(function(c) {
        var tr = document.createElement("tr");
        tr.innerHTML = "<td>" + c.nom + "</td>" +
                       "<td>" + c.duree + " jours</td>" +
                       "<td>" + parseFloat(c.prix).toFixed(2) + " €</td>";
        finishedTbody.appendChild(tr);
      });
    }
      
    window.advanceChantier = function(index) {
      // Ouvrir le modal pour cocher les étapes
      openStepsModal(index);
    };
    window.finishChantier = function(index) {
      if(confirm("Terminer le chantier " + window.chantiers[index].nom + " ?")) {
        var chantier = window.chantiers.splice(index,1)[0];
        chantier.avance = 100;
        window.travauxFinis.push(chantier);
        window.saveChantiers();
        window.saveTravauxFinis();
        renderChantiers();
        renderBaseChantiers();
      }
    };

    window.renderProjets = function() {
      var container = document.getElementById("details-projet");
      container.innerHTML = "";
      if(window.projets.length === 0) {
        container.innerHTML = "<p>Aucun projet enregistré.</p>";
        return;
      }
      var html = "<table style='width:100%; border-collapse: collapse;'><thead><tr><th>Nom</th><th>Budget</th><th>Durée</th><th>Lien</th><th>Priorité</th><th>Actions</th></tr></thead><tbody>";
      window.projets.forEach(function(p, index) {
        html += "<tr>";
        html += "<td>" + p.nom + "</td>";
        html += "<td>" + parseFloat(p.prix).toFixed(2) + " €</td>";
        html += "<td>" + p.duree + " mois</td>";
        html += "<td>" + (p.lien ? "<a href='" + p.lien + "' target='_blank'>Voir</a>" : "") + "</td>";
        html += "<td>" + p.priorite + "</td>";
        html += "<td><button onclick='editProjet(" + index + ")'>Modifier</button> ";
        html += "<button onclick='deleteProjet(" + index + ")'>Supprimer</button></td>";
        html += "</tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    };
    window.deleteProjet = function(index) {
      if(confirm("Supprimer le projet " + window.projets[index].nom + " ?")) {
        window.projets.splice(index, 1);
        window.saveProjets();
        window.renderProjets();
      }
    };
    window.editProjet = function(index) {
      var projet = window.projets[index];
      var newNom = prompt("Modifier le nom du projet :", projet.nom);
      var newPrix = prompt("Modifier le budget total (€) :", projet.prix);
      var newDuree = prompt("Modifier la durée souhaitée (mois) :", projet.duree);
      if(newNom && newPrix && newDuree) {
        projet.nom = newNom;
        projet.prix = parseFloat(newPrix);
        projet.duree = parseInt(newDuree);
        window.saveProjets();
        window.renderProjets();
      }
    };

    populateOuvrierSelect();
    window.renderOuvriers();
    renderBaseOuvriers();
    renderChantiers();
    renderBaseChantiers();
    window.renderProjets();
      
    window.refreshAll = function() {
      window.renderOuvriers();
      populateOuvrierSelect();
      // Mise à jour de la base ouvriers à partir des ouvriers actuels
      window.baseOuvriers = window.ouvriers.slice();
      window.saveBaseOuvriers();
      renderBaseOuvriers();
      renderFinanceSummary();
      renderRevenusList();
      renderRevenusAttenteList();
      renderDepensesList();
      renderDepensesPrevuesList();
      renderAchatsTable();
      renderGroupedAchats();
      renderChantiers();
      renderBaseChantiers();
      window.renderProjets();
    };
    window.refreshAll();

    // Gestion des étapes du chantier
    function addEtape() {
      var input = document.getElementById("etape-input");
      var etape = input.value.trim();
      if(etape === "") {
        alert("Veuillez saisir une étape.");
        return;
      }
      window.currentEtapes = window.currentEtapes || [];
      window.currentEtapes.push(etape);
      input.value = "";
      renderEtapes();
    }
    function renderEtapes() {
      var container = document.getElementById("etapes-container");
      container.innerHTML = "";
      if(!window.currentEtapes || window.currentEtapes.length === 0) {
        container.innerHTML = "<p>Aucune étape ajoutée.</p>";
        return;
      }
      var ul = document.createElement("ul");
      window.currentEtapes.forEach(function(etape, index) {
        var li = document.createElement("li");
        li.textContent = etape;
        li.style.cursor = "pointer";
        li.title = "Cliquez pour supprimer cette étape";
        li.addEventListener("click", function(){
          if(confirm("Supprimer cette étape ?")) {
            window.currentEtapes.splice(index, 1);
            renderEtapes();
          }
        });
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }
  </script>
</head>
<body>
  <!-- Bouton de rafraîchissement -->
  <div id="refresh-btn" onclick="refreshAll()">Rafraîchir</div>
  <header>
    <h1>Koloral Sheqiri</h1>
    <div class="quick-menu" id="quick-menu-btn" onclick="toggleQuickMenu()">€ Finance</div>
    <div class="quick-menu-container" id="quick-menu">
      <button onclick="ajusterFinance(-20)">-20 €</button>
      <button onclick="ajusterFinance(-50)">-50 €</button>
      <button onclick="ajusterFinance(-100)">-100 €</button>
      <button onclick="ajusterFinance(50)">+50 €</button>
      <button onclick="ajusterFinance(100)">+100 €</button>
    </div>
  </header>
  <!-- Menu de navigation -->
  <select id="nav-dropdown" onchange="showSection(this.value)">
    <option value="ouvriers">Ouvriers</option>
    <option value="baseouvriers">Base Ouvriers</option>
    <option value="chantier">Chantiers</option>
    <option value="basechantier">Base Chantiers</option>
    <option value="finance">Finance</option>
    <option value="projet">Projet</option>
    <option value="plusoptions">Plus d’Options</option>
    <option value="siteweb">Site Web</option>
    <option value="utilitaires">Utilitaires</option>
  </select>
  <div id="main-content">
    <!-- SECTION OUVRIERS -->
    <section id="ouvriers" class="section active">
      <div class="section-header">
        <h2>Ouvriers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('ouvriers')">Masquer</button>
      </div>
      <div class="section-body">
        <form id="form-ouvrier">
          <select id="ouvrier-select">
            <option value="">Sélectionner un ouvrier (facultatif)</option>
          </select>
          <input type="text" id="ouvrier-nom" placeholder="Nom de l'ouvrier">
          <input type="number" id="ouvrier-tarif" placeholder="Prix à la journée (€)" step="0.01" required>
          <input type="number" id="ouvrier-jours" placeholder="Temps de travail (en jours)" step="0.1" required>
          <button type="submit">Enregistrer / Mettre à jour</button>
        </form>
        <div class="table-container">
          <table id="table-ouvriers">
            <thead>
              <tr>
                <th>Payé</th>
                <th>Nom</th>
                <th>Prix/jour</th>
                <th>Jours</th>
                <th>Total Gain</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ouvriers-tbody"></tbody>
          </table>
        </div>
        <button class="voir-plus-btn" id="voir-plus-ouvriers-btn" onclick="toggleTable('ouvriers-tbody', 'voir-plus-ouvriers-btn')">Voir plus</button>
      </div>
    </section>
    <!-- SECTION BASE OUVRIERS -->
    <section id="baseouvriers" class="section">
      <div class="section-header">
        <h2>Base Ouvriers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('baseouvriers')">Masquer</button>
      </div>
      <div class="section-body">
        <p>Liste de tous les ouvriers enregistrés.</p>
        <!-- Deux conteneurs pour ouvriers impayés et payés -->
        <div id="baseouvriers-unpaid"></div>
        <div id="baseouvriers-paid"></div>
        <button class="voir-plus-btn" id="voir-plus-baseouvriers-btn" onclick="toggleTable('baseouvriers-unpaid', 'voir-plus-baseouvriers-btn')">Voir plus</button>
      </div>
    </section>
    <!-- SECTION CHANTIERS -->
    <section id="chantier" class="section">
      <div class="section-header">
        <h2>Chantiers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('chantier')">Masquer</button>
      </div>
      <div class="section-body">
        <form id="form-chantier">
          <input type="text" id="chantier-nom" placeholder="Nom du chantier" required>
          <input type="number" id="chantier-duree" placeholder="Durée (en jours)" step="1" required>
          <input type="number" id="chantier-prix" placeholder="Prix du chantier (€)" step="0.01" required>
          <input type="number" id="chantier-materiel" placeholder="Coût des matériaux (€)" step="0.01" required>
          <label><input type="checkbox" id="chantier-mat-payee"> Matériaux payés</label>
          <h3>Étapes du Chantier</h3>
          <div id="etapes-container"></div>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <input type="text" id="etape-input" placeholder="Description de l'étape">
            <button type="button" onclick="addEtape()">Ajouter étape</button>
          </div>
          <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
          <button type="submit">Enregistrer chantier</button>
        </form>
        <div class="table-container">
          <table id="table-chantier">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Durée</th>
                <th>Prix</th>
                <th>Matériaux</th>
                <th>Avancement</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="chantier-tbody"></tbody>
          </table>
        </div>
        <button class="voir-plus-btn" id="voir-plus-chantier-btn" onclick="toggleTable('chantier-tbody', 'voir-plus-chantier-btn')">Voir plus</button>
      </div>
    </section>
    <!-- SECTION BASE CHANTIERS -->
    <section id="basechantier" class="section">
      <div class="section-header">
        <h2>Base Chantiers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('basechantier')">Masquer</button>
      </div>
      <div class="section-body">
        <p>Affichage des chantiers actifs et des travaux terminés.</p>
        <h3>Chantiers Actifs</h3>
        <div class="table-container">
          <table id="table-base-chantier-actif">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Durée</th>
                <th>Prix</th>
                <th>Avancement</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="basechantier-actif-tbody"></tbody>
          </table>
        </div>
        <h3>Travaux Terminés</h3>
        <div class="table-container">
          <table id="table-base-chantier-fini">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Durée</th>
                <th>Prix</th>
              </tr>
            </thead>
            <tbody id="basechantier-fini-tbody"></tbody>
          </table>
        </div>
        <button class="voir-plus-btn" id="voir-plus-basechantier-btn" onclick="toggleTable('basechantier-actif-tbody', 'voir-plus-basechantier-btn')">Voir plus</button>
      </div>
    </section>
    <!-- SECTION FINANCE -->
    <section id="finance" class="section">
      <div class="section-header">
        <h2>Finance</h2>
        <button class="toggle-section-btn" onclick="toggleSection('finance')">Masquer</button>
      </div>
      <div class="section-body">
        <div id="revenus-manuels">
          <h3>Revenus Manuels</h3>
          <form id="form-revenu">
            <input type="text" id="revenu-description" placeholder="Description du revenu" required>
            <input type="number" id="revenu-montant" placeholder="Montant (€)" step="0.01" required>
            <label><input type="checkbox" id="revenu-chantier"> Revenu lié au chantier</label>
            <button type="submit">Ajouter revenu</button>
          </form>
          <div id="revenus-list"></div>
          <button class="voir-plus-btn" id="voir-plus-revenu-btn" onclick="toggleTable('revenus-list', 'voir-plus-revenu-btn')">Voir plus</button>
        </div>
        <div id="revenus-attente">
          <h3>Revenus en Attente</h3>
          <form id="form-revenu-attente">
            <input type="text" id="revenu-attente-description" placeholder="Description du revenu en attente" required>
            <input type="number" id="revenu-attente-montant" placeholder="Montant (€)" step="0.01" required>
            <button type="submit">Ajouter revenu en attente</button>
          </form>
          <div id="revenus-attente-list"></div>
          <button class="voir-plus-btn" id="voir-plus-revenu-attente-btn" onclick="toggleTable('revenus-attente-list', 'voir-plus-revenu-attente-btn')">Voir plus</button>
        </div>
        <div id="depenses-manuelles">
          <h3>Dépenses Manuelles</h3>
          <form id="form-depense">
            <input type="text" id="depense-description" placeholder="Description de la dépense" required>
            <input type="number" id="depense-montant" placeholder="Montant (€)" step="0.01" required>
            <button type="submit">Ajouter dépense</button>
          </form>
          <div id="depenses-list"></div>
          <button class="voir-plus-btn" id="voir-plus-depense-btn" onclick="toggleTable('depenses-list', 'voir-plus-depense-btn')">Voir plus</button>
        </div>
        <div id="depenses-prevues">
          <h3>Dépenses Prévues</h3>
          <form id="form-depense-prevue">
            <input type="text" id="depense-prevue-description" placeholder="Description de la dépense prévue" required>
            <input type="number" id="depense-prevue-montant" placeholder="Montant prévu (€)" step="0.01" required>
            <button type="submit">Ajouter dépense prévue</button>
          </form>
          <div id="depenses-prevues-list"></div>
          <button class="voir-plus-btn" id="voir-plus-depense-prevue-btn" onclick="toggleTable('depenses-prevues-list', 'voir-plus-depense-prevue-btn')">Voir plus</button>
        </div>
        <div id="finance-summary">
          <p id="summary-revenus">Revenus manuels : 0 €</p>
          <p id="summary-revenus-attente">Revenus en attente : 0 €</p>
          <p id="summary-depenses">Dépenses manuelles : 0 €</p>
          <p id="summary-depenses-prevues">Dépenses prévues : 0 €</p>
          <p id="global-balance">Solde global : 0 €</p>
        </div>
        <div id="finance-options">
          <label><input type="checkbox" id="appliquer-urssaf" onchange="renderFinanceSummary()"> Appliquer -22% Urssaf sur revenus chantier</label>
        </div>
        <button class="voir-plus-btn" id="voir-plus-finance" onclick="toggleTable('finance-summary', 'voir-plus-finance')">Voir plus</button>
      </div>
    </section>
    <!-- SECTION PROJET -->
    <section id="projet" class="section">
      <div class="section-header">
        <h2>Projet</h2>
        <button class="toggle-section-btn" onclick="toggleSection('projet')">Masquer</button>
      </div>
      <div class="section-body">
        <form id="form-projet">
          <input type="text" id="projet-nom" placeholder="Nom du projet" required>
          <input type="number" id="projet-prix" placeholder="Budget total (€)" step="0.01" required>
          <label><input type="checkbox" id="projet-ajout-lien" onchange="toggleLienProjet()"> Ajouter un lien</label>
          <input type="url" id="projet-lien" placeholder="URL du projet" style="display:none;">
          <input type="number" id="projet-duree" placeholder="Durée souhaitée (mois)" step="1" required>
          <label><input type="checkbox" id="projet-mode-inverse"> Mode Inverse (budget mensuel)</label>
          <input type="number" id="projet-mensuel" placeholder="Budget mensuel (€)" step="0.01">
          <input type="number" id="projet-mois-objectif" placeholder="Mois jusqu'à l'objectif" step="1">
          <select id="projet-priorite">
            <option value="1">Priorité 1 (Haute)</option>
            <option value="2">Priorité 2</option>
            <option value="3">Priorité 3 (Normale)</option>
            <option value="4">Priorité 4</option>
            <option value="5">Priorité 5 (Basse)</option>
          </select>
          <button type="button" onclick="calculateProjet()">Calculer Projet</button>
          <button type="submit">Enregistrer Projet</button>
        </form>
        <div id="projet-achats">
          <h3>Liste d'Achats</h3>
          <form id="form-achat">
            <input type="text" id="achat-nom" placeholder="Nom de l'article">
            <input type="number" id="achat-prix" placeholder="Prix (€)" step="0.01">
            <input type="number" id="achat-priorite" placeholder="Priorité (1,2,3...)" step="1">
            <button type="button" onclick="ajouterAchat()">Ajouter à la liste</button>
          </form>
          <div class="table-container">
            <table id="table-achats">
              <thead>
                <tr>
                  <th>Choix</th>
                  <th>Nom</th>
                  <th>Prix</th>
                  <th>Priorité</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="achats-tbody"></tbody>
            </table>
          </div>
          <div style="margin-top:10px;">
            <input type="text" id="nom-groupe" placeholder="Nom du groupe d'achats">
            <button type="button" onclick="creerGroupeAchats()">Créer Groupe d'Achats</button>
          </div>
          <div class="collapsible-header" onclick="toggleGroupedAchats()">Afficher/Cacher Groupes d'Achats</div>
          <div class="collapsible-content" id="grouped-achats-table"></div>
        </div>
        <div class="details-section" id="details-projet"></div>
      </div>
    </section>
    <!-- SECTION PLUS D'OPTIONS -->
    <section id="plusoptions" class="section">
      <div class="section-header">
        <h2>Plus d’Options</h2>
        <button class="toggle-section-btn" onclick="toggleSection('plusoptions')">Masquer</button>
      </div>
      <div class="section-body">
        <ul class="options-list">
          <li onclick="openMargeBenef()">
            <span class="option-icon">💰</span>
            <span>Marge Bénéfice</span>
          </li>
          <li onclick="openTresorerie()">
            <span class="option-icon">🏦</span>
            <span>Trésorier</span>
          </li>
          <li onclick="openComparatifBenefice()">
            <span class="option-icon">⚖️</span>
            <span>Comparatif Bénéfice</span>
          </li>
          <li onclick="openPlanificationTache()">
            <span class="option-icon">📝</span>
            <span>Planif. Tâches</span>
          </li>
          <li onclick="openRapportTresorerieMensuel()">
            <span class="option-icon">📅</span>
            <span>Rapport Trésorerie</span>
          </li>
          <li onclick="openAnalyseAvancee()">
            <span class="option-icon">📈</span>
            <span>Analyse Avancée</span>
          </li>
          <li onclick="openChiffreAffaires()">
            <span class="option-icon">💹</span>
            <span>Chiffre d’Affaires</span>
          </li>
          <li onclick="openHistoriqueChantiers()">
            <span class="option-icon">📜</span>
            <span>Hist. Chantiers</span>
          </li>
          <li onclick="openGestionFournisseurs()">
            <span class="option-icon">🏷️</span>
            <span>Fournisseurs</span>
          </li>
          <li onclick="openStatsProductivite()">
            <span class="option-icon">📊</span>
            <span>Stats Prod.</span>
          </li>
          <li onclick="openPrevisionBudget()">
            <span class="option-icon">🔮</span>
            <span>Prévision Budget</span>
          </li>
          <li onclick="openRapportActiviteGlobal()">
            <span class="option-icon">🗂</span>
            <span>Rapport Global</span>
          </li>
        </ul>
      </div>
    </section>
    <!-- SECTION SITE WEB -->
    <section id="siteweb" class="section">
      <div class="section-header">
        <h2>Site Web</h2>
        <button class="toggle-section-btn" onclick="toggleSection('siteweb')">Masquer</button>
      </div>
      <div class="section-body">
        <p>Accédez aux sites partenaires :</p>
        <ul>
          <li><a href="https://koloral.fr" target="_blank">Koloral.fr</a></li>
          <li><a href="https://hostinger.com" target="_blank">Hostinger</a></li>
        </ul>
      </div>
    </section>
    <!-- SECTION UTILITAIRES -->
    <section id="utilitaires" class="section">
      <div class="section-header">
        <h2>Utilitaires</h2>
        <button class="toggle-section-btn" onclick="toggleSection('utilitaires')">Masquer</button>
      </div>
      <div class="section-body">
        <button onclick="exportAllData()">Exporter données (JSON)</button>
        <button onclick="importAllData()">Importer données (JSON)</button>
        <input type="file" id="import-file" accept="application/json" style="display:none" onchange="handleImport(event)">
        <button onclick="clearAllData()">Tout réinitialiser</button>
        <button onclick="showHelp()">Afficher aide</button>
        <button onclick="viewSummary()">Afficher Synthèse</button>
        <button onclick="backupSection()">Sauvegarder une section</button>
        <button id="toggle-backups-btn" onclick="toggleBackupList()">Afficher sauvegardes</button>
        <div id="backups-list"></div>
        <div id="backup-interface" style="display:none; border: 1px solid var(--border-color); padding: 10px; margin-top: 10px; border-radius: var(--radius); background: var(--bg-color);">
          <h3>Sauvegarder une section</h3>
          <label for="backup-name">Nom de la sauvegarde :</label>
          <input type="text" id="backup-name" placeholder="Nom personnalisé">
          <select id="backup-select" style="width:100%; margin-top:10px; margin-bottom: 10px;">
            <option value="ouvriers">Ouvriers</option>
            <option value="baseouvriers">Base Ouvriers</option>
            <option value="chantiers">Chantiers</option>
            <option value="travauxFinis">Travaux Finis</option>
            <option value="revenus">Revenus</option>
            <option value="depenses">Dépenses</option>
            <option value="depensesPrevues">Dépenses Prévues</option>
            <option value="projets">Projets</option>
          </select>
          <button onclick="performBackup()">Sauvegarder</button>
          <button onclick="toggleBackupInterface()">Annuler</button>
        </div>
      </div>
    </section>
    <div class="spacer"></div>
  </div>
  <footer>
    <p>&copy; 2025 Koloral Sheqiri</p>
  </footer>
  <!-- Modale Rapport Global -->
  <div class="report-modal" id="report-modal">
    <div class="report-content">
      <h2>Rapport Global</h2>
      <div id="report-data"></div>
      <div class="modal-buttons">
        <button onclick="printReport()">Imprimer Rapport</button>
        <button onclick="closeReport()">Fermer</button>
      </div>
    </div>
  </div>
  <!-- Modale Étapes Chantier -->
  <div class="steps-modal" id="steps-modal">
    <div class="steps-content">
      <h2>Modifier les Étapes</h2>
      <div id="steps-modal-content"></div>
      <div class="steps-buttons" style="margin-top:1rem; display:flex; justify-content:space-around;">
        <button onclick="saveChantierSteps()">Sauvegarder</button>
        <button onclick="closeStepsModal()">Annuler</button>
      </div>
    </div>
  </div>
  <!-- Modale Options supplémentaires -->
  <div class="option-modal" id="option-modal">
    <div class="option-content">
      <span class="close-btn" onclick="closeOptionModal()">×</span>
      <h2 id="option-modal-title"></h2>
      <div id="option-modal-body"></div>
    </div>
  </div>
  <div class="spacer"></div>
  <!-- Scripts d'initialisation -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Chargement des données depuis le localStorage
      window.ouvriers = JSON.parse(localStorage.getItem('gestion_ouvriers')) || [];
      window.ouvriers.forEach(function(o) { if(o.paye === undefined) { o.paye = false; } });
      window.baseOuvriers = JSON.parse(localStorage.getItem('baseouvriers')) || [];
      window.chantiers = JSON.parse(localStorage.getItem('gestion_chantiers')) || [];
      window.travauxFinis = JSON.parse(localStorage.getItem('travaux_finiss')) || [];
      window.currentEtapes = [];
      window.revenus = JSON.parse(localStorage.getItem('gestion_revenus')) || [];
      window.depenses = JSON.parse(localStorage.getItem('gestion_depenses')) || [];
      window.depensesPrevues = JSON.parse(localStorage.getItem('gestion_depenses_prevues')) || [];
      window.revenusAttente = [];
      window.achats = [];
      window.groupedAchats = [];
      window.projets = JSON.parse(localStorage.getItem('gestion_projets')) || [];
      
      // Fonctions de sauvegarde
      window.saveOuvriers = function() { localStorage.setItem('gestion_ouvriers', JSON.stringify(window.ouvriers)); };
      window.saveBaseOuvriers = function() { localStorage.setItem('baseouvriers', JSON.stringify(window.baseOuvriers)); };
      window.saveChantiers = function() { localStorage.setItem('gestion_chantiers', JSON.stringify(window.chantiers)); };
      window.saveTravauxFinis = function() { localStorage.setItem('travaux_finiss', JSON.stringify(window.travauxFinis)); };
      window.saveFinance = function() {
        localStorage.setItem('gestion_revenus', JSON.stringify(window.revenus));
        localStorage.setItem('gestion_depenses', JSON.stringify(window.depenses));
        localStorage.setItem('gestion_depenses_prevues', JSON.stringify(window.depensesPrevues));
      };
      window.saveProjets = function() { localStorage.setItem('gestion_projets', JSON.stringify(window.projets)); };
      
      // Fonction pour mettre à jour la liste déroulante des ouvriers
      function populateOuvrierSelect() {
        var select = document.getElementById("ouvrier-select");
        select.innerHTML = "<option value=''>Sélectionner un ouvrier (facultatif)</option>";
        window.ouvriers.forEach(function(o) {
          select.innerHTML += "<option value='" + o.nom + "'>" + o.nom + "</option>";
        });
      }
      
      // Rendu de la liste des ouvriers
      window.renderOuvriers = function() {
        var tbody = document.getElementById("ouvriers-tbody");
        tbody.innerHTML = "";
        window.ouvriers.forEach(function(o, index) {
          var total = (parseFloat(o.tarif) * parseFloat(o.jours)).toFixed(2);
          var tr = document.createElement("tr");
          tr.innerHTML =
            "<td style='text-align:center;'><input type='checkbox' " + (o.paye ? "checked" : "") +
            " onclick='toggleOuvrierPay(" + index + ")'></td>" +
            "<td>" + o.nom + "</td>" +
            "<td>" + parseFloat(o.tarif).toFixed(2) + " €</td>" +
            "<td>" + parseFloat(o.jours).toFixed(1) + "</td>" +
            "<td>" + total + " €</td>" +
            "<td><button class='action-btn' onclick=\"editOuvrier('" + o.nom + "')\">Modifier</button> " +
            "<button class='action-btn' onclick=\"deleteOuvrier('" + o.nom + "')\">Supprimer</button></td>";
          tbody.appendChild(tr);
        });
      };
      window.toggleOuvrierPay = function(index) {
        window.ouvriers[index].paye = !window.ouvriers[index].paye;
        window.saveOuvriers();
        window.renderOuvriers();
        // Mise à jour de la base ouvriers pour refléter le changement
        window.baseOuvriers = window.ouvriers.slice();
        window.saveBaseOuvriers();
        renderBaseOuvriers();
      };
      window.deleteOuvrier = function(nom) {
        if(confirm("Supprimer l'ouvrier " + nom + " ?")) {
          window.ouvriers = window.ouvriers.filter(function(o) {
            return o.nom.toLowerCase() !== nom.toLowerCase();
          });
          window.saveOuvriers();
          window.renderOuvriers();
          populateOuvrierSelect();
          // Mise à jour de la base ouvriers avec la liste actuelle
          window.baseOuvriers = window.ouvriers.slice();
          window.saveBaseOuvriers();
          renderBaseOuvriers();
        }
      };
      window.editOuvrier = function(nom) {
        var index = window.ouvriers.findIndex(function(o) { return o.nom.toLowerCase() === nom.toLowerCase(); });
        if(index !== -1) {
          var newTarif = prompt("Modifier le tarif pour " + nom + " :", window.ouvriers[index].tarif);
          var newJours = prompt("Modifier le nombre de jours pour " + nom + " :", window.ouvriers[index].jours);
          if(newTarif !== null && newJours !== null) {
            window.ouvriers[index].tarif = parseFloat(newTarif) || window.ouvriers[index].tarif;
            window.ouvriers[index].jours = parseFloat(newJours) || window.ouvriers[index].jours;
            window.saveOuvriers();
            window.renderOuvriers();
            populateOuvrierSelect();
            // Mise à jour de la base ouvriers
            window.baseOuvriers = window.ouvriers.slice();
            window.saveBaseOuvriers();
            renderBaseOuvriers();
          }
        }
      };

      // Écouteur pour le formulaire Ouvrier
      document.getElementById("form-ouvrier").addEventListener("submit", function(e) {
        e.preventDefault();
        var nom = document.getElementById("ouvrier-nom").value.trim();
        var tarif = parseFloat(document.getElementById("ouvrier-tarif").value);
        var jours = parseFloat(document.getElementById("ouvrier-jours").value);
        if(nom === "" || isNaN(tarif) || isNaN(jours)) {
          alert("Veuillez remplir tous les champs de l'ouvrier correctement.");
          return;
        }
        var existingIndex = window.ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
        if(existingIndex !== -1){
           window.ouvriers[existingIndex].tarif = tarif;
           window.ouvriers[existingIndex].jours = jours;
        } else {
           window.ouvriers.push({ nom: nom, tarif: tarif, jours: jours, paye: false });
        }
        window.saveOuvriers();
        window.renderOuvriers();
        populateOuvrierSelect();
        // Mise à jour de la base ouvriers
        window.baseOuvriers = window.ouvriers.slice();
        window.saveBaseOuvriers();
        renderBaseOuvriers();
        this.reset();
      });

      // Écouteur pour le formulaire Chantier
      document.getElementById("form-chantier").addEventListener("submit", function(e) {
        e.preventDefault();
        var nom = document.getElementById("chantier-nom").value.trim();
        var duree = parseInt(document.getElementById("chantier-duree").value);
        var prix = parseFloat(document.getElementById("chantier-prix").value);
        var materiel = parseFloat(document.getElementById("chantier-materiel").value);
        var matPayee = document.getElementById("chantier-mat-payee").checked;
        if(nom === "" || isNaN(duree) || isNaN(prix) || isNaN(materiel)) {
          alert("Veuillez remplir tous les champs du chantier correctement.");
          return;
        }
        var etapes = window.currentEtapes || [];
        var chantier = { nom: nom, duree: duree, prix: prix, materiel: materiel, matPayee: matPayee, etapes: etapes, avance: 0 };
        window.chantiers.push(chantier);
        window.saveChantiers();
        renderChantiers();
        this.reset();
        window.currentEtapes = [];
        document.getElementById("etapes-container").innerHTML = "";
        // Mise à jour de la base chantiers
        renderBaseChantiers();
      });

      // Fonction pour rendre la liste des chantiers dans la section Chantier
      function renderChantiers() {
        var tbody = document.getElementById("chantier-tbody");
        tbody.innerHTML = "";
        window.chantiers.forEach(function(c, index) {
          var html = "<tr>";
          html += "<td>" + c.nom + "</td>";
          html += "<td>" + c.duree + " jours</td>";
          html += "<td>" + parseFloat(c.prix).toFixed(2) + " €</td>";
          html += "<td>" + parseFloat(c.materiel).toFixed(2) + " €</td>";
          html += "<td>" + (c.avance || 0) + "%</td>";
          html += "<td><button onclick='openStepsModal(" + index + ")'>Avancer</button> ";
          html += "<button onclick='deleteChantier(" + index + ")'>Supprimer</button></td>";
          html += "</tr>";
          tbody.innerHTML += html;
        });
      }
      // IMPORTANT : rendre renderChantiers globale pour que saveChantierSteps puisse l'appeler
      window.renderChantiers = renderChantiers;

      window.deleteChantier = function(index) {
        if(confirm("Supprimer le chantier " + window.chantiers[index].nom + " ?")) {
          window.chantiers.splice(index,1);
          window.saveChantiers();
          renderChantiers();
          // Mise à jour de la base chantiers
          renderBaseChantiers();
        }
      };
      window.editChantier = function(index) {
        var chantier = window.chantiers[index];
        var newNom = prompt("Modifier le nom du chantier :", chantier.nom);
        var newDuree = prompt("Modifier la durée (jours) :", chantier.duree);
        var newPrix = prompt("Modifier le prix (€) :", chantier.prix);
        var newMateriel = prompt("Modifier le coût des matériaux (€) :", chantier.materiel);
        if(newNom && newDuree && newPrix && newMateriel) {
          chantier.nom = newNom;
          chantier.duree = parseInt(newDuree);
          chantier.prix = parseFloat(newPrix);
          chantier.materiel = parseFloat(newMateriel);
          window.saveChantiers();
          renderChantiers();
          renderBaseChantiers();
        }
      };

      // Écouteur pour le formulaire Revenu
      document.getElementById("form-revenu").addEventListener("submit", function(e) {
        e.preventDefault();
        var desc = document.getElementById("revenu-description").value.trim();
        var montant = parseFloat(document.getElementById("revenu-montant").value);
        var chantier = document.getElementById("revenu-chantier").checked;
        if(desc === "" || isNaN(montant)) {
          alert("Veuillez saisir les informations du revenu.");
          return;
        }
        window.revenus.push({ description: desc, montant: montant, chantier: chantier });
        window.saveFinance();
        renderFinanceSummary();
        renderRevenusList();
        this.reset();
      });
      // Écouteur pour le formulaire Revenu en Attente
      document.getElementById("form-revenu-attente").addEventListener("submit", function(e) {
        e.preventDefault();
        var desc = document.getElementById("revenu-attente-description").value.trim();
        var montant = parseFloat(document.getElementById("revenu-attente-montant").value);
        if(desc === "" || isNaN(montant)) {
          alert("Veuillez saisir les informations du revenu en attente.");
          return;
        }
        window.revenusAttente.push({ description: desc, montant: montant });
        window.saveFinance();
        renderFinanceSummary();
        renderRevenusAttenteList();
        this.reset();
      });
      // Écouteur pour le formulaire Dépense
      document.getElementById("form-depense").addEventListener("submit", function(e) {
        e.preventDefault();
        var desc = document.getElementById("depense-description").value.trim();
        var montant = parseFloat(document.getElementById("depense-montant").value);
        if(desc === "" || isNaN(montant)) {
          alert("Veuillez saisir les informations de la dépense.");
          return;
        }
        window.depenses.push({ description: desc, montant: montant });
        window.saveFinance();
        renderFinanceSummary();
        renderDepensesList();
        this.reset();
      });
      // Écouteur pour le formulaire Dépense Prévue
      document.getElementById("form-depense-prevue").addEventListener("submit", function(e) {
        e.preventDefault();
        var desc = document.getElementById("depense-prevue-description").value.trim();
        var montant = parseFloat(document.getElementById("depense-prevue-montant").value);
        if(desc === "" || isNaN(montant)) {
          alert("Veuillez saisir les informations de la dépense prévue.");
          return;
        }
        window.depensesPrevues.push({ description: desc, montant: montant });
        window.saveFinance();
        renderFinanceSummary();
        renderDepensesPrevuesList();
        this.reset();
      });
      // Écouteur pour le formulaire Projet
      document.getElementById("form-projet").addEventListener("submit", function(e) {
        e.preventDefault();
        var nom = document.getElementById("projet-nom").value.trim();
        var prixVal = document.getElementById("projet-prix").value.trim();
        var dureeVal = document.getElementById("projet-duree").value.trim();
        if(nom === "" || prixVal === "" || dureeVal === ""){
          alert("Veuillez remplir les champs obligatoires du projet.");
          return;
        }
        var prix = parseFloat(prixVal);
        var duree = parseInt(dureeVal);
        var ajoutLien = document.getElementById("projet-ajout-lien").checked;
        var lien = (ajoutLien ? document.getElementById("projet-lien").value.trim() : "");
        var modeInverse = document.getElementById("projet-mode-inverse").checked;
        var mensuel = parseFloat(document.getElementById("projet-mensuel").value) || 0;
        var moisObjectif = parseInt(document.getElementById("projet-mois-objectif").value) || 0;
        var priorite = document.getElementById("projet-priorite").value;
        var projet = { nom: nom, prix: prix, lien: lien, duree: duree, modeInverse: modeInverse, mensuel: mensuel, moisObjectif: moisObjectif, priorite: priorite };
        window.projets.push(projet);
        window.saveProjets();
        window.renderProjets();
        this.reset();
      });

      populateOuvrierSelect();
      window.renderOuvriers();
      renderBaseOuvriers();
      renderChantiers();
      renderBaseChantiers();
      window.renderProjets();
      
      window.refreshAll = function() {
        window.renderOuvriers();
        populateOuvrierSelect();
        // Mise à jour de la base ouvriers à partir des ouvriers actuels
        window.baseOuvriers = window.ouvriers.slice();
        window.saveBaseOuvriers();
        renderBaseOuvriers();
        renderFinanceSummary();
        renderRevenusList();
        renderRevenusAttenteList();
        renderDepensesList();
        renderDepensesPrevuesList();
        renderAchatsTable();
        renderGroupedAchats();
        renderChantiers();
        renderBaseChantiers();
        window.renderProjets();
      };
      window.refreshAll();
    });
  </script>
</body>
</html>
