<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Koloral Sheqiri – Gestion d'Entreprise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ---------- Styles Globaux ---------- */
    body {
      font-family: 'Roboto', sans-serif;
      font-size: 18px;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      color: #333;
      overflow-x: hidden;
    }
    header {
      background: linear-gradient(135deg, #005f73, #0a9396);
      color: #fff;
      text-align: center;
      padding: 1rem;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    header h1 { margin: 0; font-size: 2rem; }
    #refresh-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #fff;
      color: #005f73;
      border: 1px solid #005f73;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      z-index: 1100;
    }
    #nav-dropdown {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1050;
      margin: 0;
      font-size: 1.2rem;
      padding: 12px 18px;
      border: 2px solid #005f73;
      border-radius: 8px;
      background: #fff;
      color: #005f73;
      width: 90%;
      max-width: 400px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D'10'%20height%3D'10'%20xmlns%3D'http%3A//www.w3.org/2000/svg'%3E%3Cpath%20d%3D'M0%200l5%205l5-5z'%20fill%3D'%23005f73'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 10px;
    }
    .quick-menu {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #fff;
      color: #005f73;
      border: 1px solid #005f73;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      z-index: 1200;
    }
    .quick-menu-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #005f73;
      border-radius: 4px;
      display: none;
      z-index: 1200;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .quick-menu-container button {
      display: block;
      padding: 10px 12px;
      border: none;
      background: #fff;
      color: #005f73;
      font-size: 1rem;
      text-align: left;
      width: 100%;
      cursor: pointer;
      border-bottom: 1px solid #005f73;
    }
    .quick-menu-container button:last-child { border-bottom: none; }
    .quick-menu-container button:hover {
      background: #005f73;
      color: #fff;
    }
    #main-content {
      padding: 140px 20px 80px;
      min-height: calc(100vh - 140px);
    }
    .section {
      display: none;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 90%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .section.active { display: block; }
    form input, form select, form button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1.1rem;
    }
    form button {
      background: #005f73;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    form button:hover { background: #0a9396; }
    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td { border: 1px solid #ddd; }
    th, td {
      padding: 12px;
      text-align: left;
      font-size: 1.1rem;
    }
    th { background: #005f73; color: #fff; }
    .action-btn {
      padding: 8px 10px;
      background: #005f73;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 5px;
      font-size: 0.95rem;
      transition: background 0.3s;
    }
    .action-btn:hover { background: #0a9396; }
    .progress-container {
      width: 100%;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 8px;
      height: 20px;
    }
    .progress-bar {
      height: 100%;
      background: #005f73;
      width: 0%;
      border-radius: 4px;
      transition: width 0.3s;
    }
    /* Options Supplémentaires */
    .options-list {
      list-style: none;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .options-list li {
      flex: 1 1 calc(50% - 10px);
      background: #005f73;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      font-weight: bold;
    }
    .options-list li:hover { background: #0a9396; }
    .option-icon { font-size: 1.4rem; }
    footer {
      text-align: center;
      padding: 1rem;
      background: #005f73;
      color: #fff;
      position: fixed;
      width: 100%;
      bottom: 0;
      left: 0;
      z-index: 1000;
    }
    .report-modal, .steps-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }
    .report-content, .steps-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      text-align: center;
    }
    .steps-content { text-align: left; }
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
    }
    .modal-buttons button {
      padding: 10px 16px;
      background: #005f73;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    .modal-buttons button:hover { background: #0a9396; }
    .spacer { height: 60px; }
    @media (max-width: 600px) {
      header h1 { font-size: 1.6rem; }
      #nav-dropdown { width: 95%; }
      .section { margin: 10px; padding: 10px; }
      .options-list li { flex: 1 1 100%; }
    }
  </style>
  <script>
    /* Définition des wrappers pour les options supplémentaires */
    window.calculerMargeBeneficiaire = function() {
      if(typeof window._calculerMargeBeneficiaire === "function") {
        window._calculerMargeBeneficiaire();
      } else {
        alert("Fonction calculerMargeBeneficiaire non disponible.");
      }
    };
    window.previsionTresorerie = function() {
      if(typeof window._previsionTresorerie === "function") {
        window._previsionTresorerie();
      } else {
        alert("Fonction previsionTresorerie non disponible.");
      }
    };
    window.analyserRentabiliteProjet = function() {
      if(typeof window._analyserRentabiliteProjet === "function") {
        window._analyserRentabiliteProjet();
      } else {
        alert("Fonction analyserRentabiliteProjet non disponible.");
      }
    };
    window.genererEcheancier = function() {
      if(typeof window._genererEcheancier === "function") {
        window._genererEcheancier();
      } else {
        alert("Fonction genererEcheancier non disponible.");
      }
    };
    window.comparerCouts = function() {
      if(typeof window._comparerCouts === "function") {
        window._comparerCouts();
      } else {
        alert("Fonction comparerCouts non disponible.");
      }
    };
    window.planifierTaches = function() {
      if(typeof window._planifierTaches === "function") {
        window._planifierTaches();
      } else {
        alert("Fonction planifierTaches non disponible.");
      }
    };
    window.simulerInvestissement = function() {
      if(typeof window._simulerInvestissement === "function") {
        window._simulerInvestissement();
      } else {
        alert("Fonction simulerInvestissement non disponible.");
      }
    };
    window.calculerTVAAvance = function() {
      if(typeof window._calculerTVAAvance === "function") {
        window._calculerTVAAvance();
      } else {
        alert("Fonction calculerTVAAvance non disponible.");
      }
    };
    window.genererRapportPersonnalise = function() {
      if(typeof window._genererRapportPersonnalise === "function") {
        window._genererRapportPersonnalise();
      } else {
        alert("Fonction genererRapportPersonnalise non disponible.");
      }
    };
    window.analyserAvancee = function() {
      if(typeof window._analyserAvancee === "function") {
        window._analyserAvancee();
      } else {
        alert("Fonction analyserAvancee non disponible.");
      }
    };
    window.calculerChiffreAffaires = function() {
      alert("Calcul du chiffre d'affaires en cours de développement.");
    };
    window.afficherHistoriqueTravaux = function() {
      alert("Historique des travaux en cours de développement.");
    };
    
    window.toggleQuickMenu = function() {
      var qm = document.getElementById("quick-menu");
      if(qm) {
        qm.style.display = (qm.style.display === "block") ? "none" : "block";
      }
    };
    window.toggleGroupedAchats = function() {
      var content = document.getElementById("grouped-achats-table");
      if(content) {
        content.style.display = (content.style.display === "block") ? "none" : "block";
      }
    };
  </script>
</head>
<body>
  <!-- Bouton Rafraîchir -->
  <div id="refresh-btn" onclick="refreshAll()">Rafraîchir</div>
  
  <!-- En-tête fixe -->
  <header>
    <h1>Koloral Sheqiri</h1>
    <div class="quick-menu" id="quick-menu-btn" onclick="toggleQuickMenu()">€ Dépenses</div>
    <div class="quick-menu-container" id="quick-menu">
      <button onclick="ajusterDepense(-20)">-20 €</button>
      <button onclick="ajusterDepense(-50)">-50 €</button>
      <button onclick="ajusterDepense(-100)">-100 €</button>
      <button onclick="ajusterDepense(50)">+50 €</button>
      <button onclick="ajusterDepense(100)">+100 €</button>
    </div>
  </header>
  
  <!-- Navigation Dropdown -->
  <select id="nav-dropdown" onchange="showSection(this.value)">
    <option value="ouvriers">Ouvriers</option>
    <option value="baseouvriers">Base Ouvriers</option>
    <option value="chantier">Chantiers</option>
    <option value="basechantier">Base Chantiers</option>
    <option value="finance">Finance</option>
    <option value="projet">Projet</option>
    <option value="plusoptions">Plus d’Options</option>
    <option value="siteweb">Site Web</option>
    <option value="utilitaires">Utilitaires</option>
  </select>
  
  <!-- Contenu Principal -->
  <div id="main-content">
    <!-- Section Ouvriers -->
    <section id="ouvriers" class="section active">
      <h2>Ouvriers</h2>
      <form id="form-ouvrier">
        <select id="ouvrier-select">
          <option value="">Sélectionner un ouvrier (facultatif)</option>
        </select>
        <input type="text" id="ouvrier-nom" placeholder="Nom de l'ouvrier">
        <input type="number" id="ouvrier-tarif" placeholder="Prix à la journée (€)" step="0.01" required>
        <input type="number" id="ouvrier-jours" placeholder="Temps de travail (en jours)" step="0.1" required>
        <button type="submit">Enregistrer / Mettre à jour</button>
      </form>
      <div class="table-container">
        <table id="table-ouvriers">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Prix/jour</th>
              <th>Jours</th>
              <th>Total</th>
              <th>Payé</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
    <!-- Section Base Ouvriers -->
    <section id="baseouvriers" class="section">
      <h2>Base Ouvriers</h2>
      <p>Liste de tous les ouvriers enregistrés.</p>
      <div class="table-container">
        <table id="table-baseouvriers">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Jours Totaux</th>
              <th>Montant Total (€)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
    <!-- Section Chantiers -->
    <section id="chantier" class="section">
      <h2>Chantiers</h2>
      <form id="form-chantier">
        <input type="text" id="chantier-nom" placeholder="Nom du chantier" required>
        <input type="number" id="chantier-duree" placeholder="Durée (en jours)" step="1" required>
        <input type="number" id="chantier-prix" placeholder="Prix du chantier (€)" step="0.01" required>
        <input type="number" id="chantier-materiel" placeholder="Coût des matériaux (€)" step="0.01" required>
        <label><input type="checkbox" id="chantier-mat-payee"> Matériaux payés</label>
        <h3>Étapes du Chantier</h3>
        <div id="etapes-container"></div>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <input type="text" id="etape-input" placeholder="Description de l'étape">
          <button type="button" onclick="addEtape()">Ajouter étape</button>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <button type="submit">Enregistrer chantier</button>
      </form>
      <div class="table-container">
        <table id="table-chantier">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Durée</th>
              <th>Prix</th>
              <th>Matériaux</th>
              <th>Avancement</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
    <!-- Section Base Chantiers -->
    <section id="basechantier" class="section">
      <h2>Base Chantiers</h2>
      <p>Affichage des chantiers actifs et des travaux terminés.</p>
      <h3>Chantiers Actifs</h3>
      <div class="table-container">
        <table id="table-base-chantier-actif">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Durée</th>
              <th>Prix</th>
              <th>Avancement</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <h3>Travaux Terminés</h3>
      <div class="table-container">
        <table id="table-base-chantier-fini">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Durée</th>
              <th>Prix</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
    <!-- Section Finance -->
    <section id="finance" class="section">
      <h2>Finance</h2>
      <!-- Revenus Manuels -->
      <div>
        <h3>Revenus Manuels</h3>
        <form id="form-revenu">
          <input type="text" id="revenu-description" placeholder="Description du revenu" required>
          <input type="number" id="revenu-montant" placeholder="Montant (€)" step="0.01" required>
          <button type="submit">Ajouter revenu</button>
        </form>
        <div id="revenus-list"></div>
      </div>
      <!-- Revenus en Attente -->
      <div>
        <h3>Revenus en Attente</h3>
        <form id="form-revenu-attente">
          <input type="text" id="revenu-attente-description" placeholder="Description du revenu en attente" required>
          <input type="number" id="revenu-attente-montant" placeholder="Montant (€)" step="0.01" required>
          <button type="submit">Ajouter revenu en attente</button>
        </form>
        <div id="revenus-attente-list"></div>
      </div>
      <!-- Dépenses Manuelles -->
      <div>
        <h3>Dépenses Manuelles</h3>
        <form id="form-depense">
          <input type="text" id="depense-description" placeholder="Description de la dépense" required>
          <input type="number" id="depense-montant" placeholder="Montant (€)" step="0.01" required>
          <button type="submit">Ajouter dépense</button>
        </form>
        <div id="depenses-list"></div>
      </div>
      <!-- Dépenses Prévues -->
      <div>
        <h3>Dépenses Prévues</h3>
        <form id="form-depense-prevue">
          <input type="text" id="depense-prevue-description" placeholder="Description de la dépense prévue" required>
          <input type="number" id="depense-prevue-montant" placeholder="Montant prévu (€)" step="0.01" required>
          <button type="submit">Ajouter dépense prévue</button>
        </form>
        <div id="depenses-prevues-list"></div>
      </div>
      <!-- Récapitulatif Finance -->
      <div id="finance-summary">
        <p id="manual-revenus">Revenus manuels : 0 €</p>
        <p id="revenus-attente">Revenus en attente : 0 €</p>
        <p id="manual-depenses">Dépenses manuelles : 0 €</p>
        <p id="depenses-prevues">Dépenses prévues : 0 €</p>
        <p id="global-balance">Solde global : 0 €</p>
      </div>
    </section>
    
    <!-- Section Projet -->
    <section id="projet" class="section">
      <h2>Projet</h2>
      <form id="form-projet">
        <input type="text" id="projet-nom" placeholder="Nom du projet" required>
        <input type="number" id="projet-prix" placeholder="Budget total (€)" step="0.01" required>
        <label>
          <input type="checkbox" id="projet-ajout-lien" onchange="toggleLienProjet()"> Ajouter un lien
        </label>
        <input type="url" id="projet-lien" placeholder="URL du projet" style="display:none;">
        <input type="number" id="projet-duree" placeholder="Durée souhaitée (mois)" step="1" required>
        <label>
          <input type="checkbox" id="projet-mode-inverse"> Mode Inverse (budget mensuel)
        </label>
        <input type="number" id="projet-mensuel" placeholder="Budget mensuel (€)" step="0.01">
        <input type="number" id="projet-mois-objectif" placeholder="Mois jusqu'à l'objectif" step="1">
        <select id="projet-priorite">
          <option value="1">Priorité 1 (Haute)</option>
          <option value="2">Priorité 2</option>
          <option value="3">Priorité 3 (Normale)</option>
          <option value="4">Priorité 4</option>
          <option value="5">Priorité 5 (Basse)</option>
        </select>
        <button type="button" onclick="calculateProjet()">Calculer Projet</button>
      </form>
      <!-- Section Achats & Groupement -->
      <div id="projet-achats">
        <h3>Liste d'Achats</h3>
        <form id="form-achat">
          <input type="text" id="achat-nom" placeholder="Nom de l'article">
          <input type="number" id="achat-prix" placeholder="Prix (€)" step="0.01">
          <input type="number" id="achat-priorite" placeholder="Priorité (1,2,3...)" step="1">
          <button type="button" onclick="ajouterAchat()">Ajouter à la liste</button>
        </form>
        <div class="table-container">
          <table id="table-achats">
            <thead>
              <tr>
                <th>Choix</th>
                <th>Nom</th>
                <th>Prix</th>
                <th>Priorité</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:10px;">
          <input type="text" id="nom-groupe" placeholder="Nom du groupe d'achats">
          <button type="button" onclick="creerGroupeAchats()">Créer Groupe d'Achats</button>
        </div>
        <div class="collapsible-header" onclick="toggleGroupedAchats()">Groupes d'Achats</div>
        <div class="collapsible-content" id="grouped-achats-table"></div>
      </div>
      <div id="projet-resultat"></div>
    </section>
    
    <!-- Section Plus d'Options -->
    <section id="plusoptions" class="section">
      <h2>Plus d'Options</h2>
      <ul class="options-list">
        <li onclick="calculerMargeBeneficiaire()"><span class="option-icon">📊</span><span class="option-label">Marge Bénéf.</span></li>
        <li onclick="previsionTresorerie()"><span class="option-icon">💰</span><span class="option-label">Trésorerie</span></li>
        <li onclick="analyserRentabiliteProjet()"><span class="option-icon">📈</span><span class="option-label">ROI Projet</span></li>
        <li onclick="genererEcheancier()"><span class="option-icon">🗓️</span><span class="option-label">Échéancier</span></li>
        <li onclick="comparerCouts()"><span class="option-icon">⚖️</span><span class="option-label">Comparer Coûts</span></li>
        <li onclick="planifierTaches()"><span class="option-icon">📝</span><span class="option-label">Planifier Tâches</span></li>
        <li onclick="simulerInvestissement()"><span class="option-icon">💹</span><span class="option-label">Investissement</span></li>
        <li onclick="calculerTVAAvance()"><span class="option-icon">🧾</span><span class="option-label">Calcul TVA</span></li>
        <li onclick="genererRapportPersonnalise()"><span class="option-icon">📰</span><span class="option-label">Rapport Perso</span></li>
        <li onclick="analyserAvancee()"><span class="option-icon">🔍</span><span class="option-label">Analyse Avancée</span></li>
        <li onclick="calculerChiffreAffaires()"><span class="option-icon">💵</span><span class="option-label">Chiffre d'Aff.</span></li>
        <li onclick="afficherHistoriqueTravaux()"><span class="option-icon">📚</span><span class="option-label">Hist. Travaux</span></li>
      </ul>
      <div id="plusoptions-output"></div>
    </section>
    
    <!-- Section Site Web -->
    <section id="siteweb" class="section">
      <h2>Site Web</h2>
      <p>Accédez aux sites partenaires :</p>
      <ul>
        <li><a href="https://koloral.fr" target="_blank">Koloral.fr</a></li>
        <li><a href="https://hostinger.com" target="_blank">Hostinger</a></li>
      </ul>
    </section>
    
    <!-- Section Utilitaires -->
    <section id="utilitaires" class="section">
      <h2>Utilitaires</h2>
      <button onclick="exportAllData()">Exporter données (JSON)</button>
      <button onclick="importAllData()">Importer données (JSON)</button>
      <input type="file" id="import-file" accept="application/json" style="display:none" onchange="handleImport(event)">
      <button onclick="clearAllData()">Tout réinitialiser</button>
      <button onclick="showHelp()">Afficher aide</button>
      <button onclick="viewSummary()">Afficher Synthèse</button>
    </section>
    
    <div class="spacer"></div>
  </div>
  
  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Koloral Sheqiri</p>
  </footer>
  
  <!-- Modal Rapport Global -->
  <div class="report-modal" id="report-modal">
    <div class="report-content">
      <h2>Rapport Global</h2>
      <div id="report-data"></div>
      <div class="modal-buttons">
        <button onclick="printReport()">Imprimer Rapport</button>
        <button onclick="closeReport()">Fermer</button>
      </div>
    </div>
  </div>
  
  <!-- Modal Modifier Étapes -->
  <div class="steps-modal" id="steps-modal">
    <div class="steps-content">
      <h2>Modifier les Étapes</h2>
      <div id="steps-modal-content"></div>
      <div class="steps-buttons">
        <button onclick="saveChantierSteps()">Sauvegarder</button>
        <button onclick="closeStepsModal()">Annuler</button>
      </div>
    </div>
  </div>
  
  <div class="spacer"></div>
  
  <!-- Script JavaScript Principal -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      /* ---------- Variables Globales ---------- */
      window.ouvriers = JSON.parse(localStorage.getItem('gestion_ouvriers')) || [];
      window.baseOuvriers = JSON.parse(localStorage.getItem('base_ouvriers')) || [];
      window.chantiers = JSON.parse(localStorage.getItem('gestion_chantiers')) || [];
      window.travauxFinis = JSON.parse(localStorage.getItem('travaux_finiss')) || [];
      window.currentEtapes = [];
      window.revenus = JSON.parse(localStorage.getItem('gestion_revenus')) || [];
      window.depenses = JSON.parse(localStorage.getItem('gestion_depenses')) || [];
      window.depensesPrevues = JSON.parse(localStorage.getItem('gestion_depenses_prevues')) || [];
      window.revenusAttente = [];
      window.achats = [];
      window.groupedAchats = [];
      window.projets = JSON.parse(localStorage.getItem('gestion_projets')) || [];
      
      /* ---------- Fonctions de Sauvegarde ---------- */
      window.saveOuvriers = function() { localStorage.setItem('gestion_ouvriers', JSON.stringify(window.ouvriers)); };
      window.saveBaseOuvriers = function() { localStorage.setItem('base_ouvriers', JSON.stringify(window.baseOuvriers)); };
      window.saveChantiers = function() { localStorage.setItem('gestion_chantiers', JSON.stringify(window.chantiers)); };
      window.saveTravauxFinis = function() { localStorage.setItem('travaux_finiss', JSON.stringify(window.travauxFinis)); };
      window.saveFinance = function() {
        localStorage.setItem('gestion_revenus', JSON.stringify(window.revenus));
        localStorage.setItem('gestion_depenses', JSON.stringify(window.depenses));
        localStorage.setItem('gestion_depenses_prevues', JSON.stringify(window.depensesPrevues));
      };
      window.saveProjets = function() { localStorage.setItem('gestion_projets', JSON.stringify(window.projets)); };

      /* ---------- Navigation ---------- */
      window.showSection = function(sectionId) {
        document.querySelectorAll(".section").forEach(function(sec) { sec.classList.remove("active"); });
        var target = document.getElementById(sectionId);
        if(target) {
          target.classList.add("active");
          window.scrollTo(0,0);
          if(sectionId === "basechantier") renderBaseChantiers();
        }
      };

      /* ---------- Gestion des Ouvriers ---------- */
      function populateOuvrierSelect() {
        var select = document.getElementById("ouvrier-select");
        select.innerHTML = "<option value=''>Sélectionner un ouvrier (facultatif)</option>";
        window.ouvriers.forEach(function(o) {
          select.innerHTML += "<option value='" + o.nom + "'>" + o.nom + "</option>";
        });
      }
      window.renderOuvriers = function() {
        var tbody = document.querySelector("#table-ouvriers tbody");
        tbody.innerHTML = "";
        window.ouvriers.forEach(function(o) {
          var total = o.tarif * o.jours;
          var tr = document.createElement("tr");
          tr.innerHTML = "<td>" + o.nom + "</td>" +
                         "<td>" + o.tarif.toFixed(2) + " €</td>" +
                         "<td>" + o.jours.toFixed(1) + "</td>" +
                         "<td>" + total.toFixed(2) + " €</td>" +
                         "<td><input type='checkbox' " + (o.paye ? "checked" : "") + " onchange=\"toggleOuvrierPay('" + o.nom + "')\"></td>" +
                         "<td><button class='action-btn' onclick=\"editOuvrier('" + o.nom + "')\">Modifier</button> " +
                         "<button class='action-btn' onclick=\"deleteOuvrier('" + o.nom + "')\">Supprimer</button></td>";
          tbody.appendChild(tr);
        });
      };
      window.toggleOuvrierPay = function(nom) {
        var index = window.ouvriers.findIndex(function(o) { return o.nom.toLowerCase() === nom.toLowerCase(); });
        if(index !== -1) {
          window.ouvriers[index].paye = !window.ouvriers[index].paye;
          window.saveOuvriers();
          window.renderOuvriers();
        }
      };
      window.deleteOuvrier = function(nom) {
        if(confirm("Supprimer l'ouvrier " + nom + " ?")) {
          window.ouvriers = window.ouvriers.filter(function(o) { return o.nom.toLowerCase() !== nom.toLowerCase(); });
          window.saveOuvriers();
          window.renderOuvriers();
        }
      };
      window.editOuvrier = function(nom) {
        var index = window.ouvriers.findIndex(function(o) { return o.nom.toLowerCase() === nom.toLowerCase(); });
        if(index !== -1) {
          var newTarif = prompt("Modifier le tarif pour " + nom + " :", window.ouvriers[index].tarif);
          var newJours = prompt("Modifier le nombre de jours pour " + nom + " :", window.ouvriers[index].jours);
          if(newTarif !== null && newJours !== null) {
            window.ouvriers[index].tarif = parseFloat(newTarif) || window.ouvriers[index].tarif;
            window.ouvriers[index].jours = parseFloat(newJours) || window.ouvriers[index].jours;
            window.saveOuvriers();
            window.renderOuvriers();
          }
        }
      };
      document.getElementById("form-ouvrier").addEventListener("submit", function(e) {
        e.preventDefault();
        var nom = document.getElementById("ouvrier-nom").value.trim();
        var select = document.getElementById("ouvrier-select");
        if(select.value && !nom) { nom = select.value; }
        if(nom === "") { alert("Veuillez saisir le nom de l'ouvrier."); return; }
        var tarif = parseFloat(document.getElementById("ouvrier-tarif").value);
        var jours = parseFloat(document.getElementById("ouvrier-jours").value);
        if(isNaN(tarif) || isNaN(jours)) { alert("Veuillez saisir un tarif et un nombre de jours valides."); return; }
        var index = window.ouvriers.findIndex(function(o) { return o.nom.toLowerCase() === nom.toLowerCase(); });
        if(index !== -1) {
          window.ouvriers[index].jours += jours;
          window.ouvriers[index].tarif = tarif;
        } else {
          window.ouvriers.push({ nom: nom, tarif: tarif, jours: jours, paye: false });
          if(!window.baseOuvriers.find(function(o) { return o.nom.toLowerCase() === nom.toLowerCase(); })) {
            window.baseOuvriers.push({ nom: nom, tarif: tarif, jours: jours });
            window.saveBaseOuvriers();
          }
        }
        window.saveOuvriers();
        window.renderOuvriers();
        populateOuvrierSelect();
        this.reset();
      });
      populateOuvrierSelect();
      window.renderOuvriers();
      function renderBaseOuvriers() {
        var tbody = document.querySelector("#table-baseouvriers tbody");
        tbody.innerHTML = "";
        window.baseOuvriers.forEach(function(o) {
          var total = o.tarif * o.jours;
          var tr = document.createElement("tr");
          tr.innerHTML = "<td>" + o.nom + "</td>" +
                         "<td>" + o.jours.toFixed(1) + "</td>" +
                         "<td>" + total.toFixed(2) + " €</td>";
          tbody.appendChild(tr);
        });
      }
      renderBaseOuvriers();
      
      /* ---------- Gestion des Chantiers ---------- */
      window.renderEtapes = function() {
        var container = document.getElementById("etapes-container");
        container.innerHTML = "";
        window.currentEtapes.forEach(function(etape, index) {
          container.innerHTML += "<div style='margin-bottom:5px; border:1px solid #ccc; padding:4px; border-radius:4px;'>" +
            "<label><input type='checkbox' onchange='toggleEtape(" + index + ")' " + (etape.done ? "checked" : "") + "> " + etape.description + "</label></div>";
        });
        var progress = updateChantierProgress(window.currentEtapes);
        document.getElementById("progress-bar").style.width = progress + "%";
      };
      window.addEtape = function() {
        var etapeInput = document.getElementById("etape-input");
        var desc = etapeInput.value.trim();
        if(desc === "") { alert("Veuillez saisir la description de l'étape."); return; }
        window.currentEtapes.push({ description: desc, done: false });
        etapeInput.value = "";
        window.renderEtapes();
      };
      window.toggleEtape = function(index) {
        window.currentEtapes[index].done = !window.currentEtapes[index].done;
        window.renderEtapes();
      };
      function updateChantierProgress(etapes) {
        if(!etapes || etapes.length === 0) return 0;
        var completed = etapes.filter(function(e) { return e.done; }).length;
        return (completed / etapes.length) * 100;
      }
      document.getElementById("form-chantier").addEventListener("submit", function(e) {
        e.preventDefault();
        var nom = document.getElementById("chantier-nom").value.trim();
        var duree = parseFloat(document.getElementById("chantier-duree").value);
        var prix = parseFloat(document.getElementById("chantier-prix").value);
        var materiel = parseFloat(document.getElementById("chantier-materiel").value);
        var matPayee = document.getElementById("chantier-mat-payee").checked;
        if(nom && !isNaN(duree) && !isNaN(prix) && !isNaN(materiel)) {
          var chantier = {
            nom: nom,
            duree: duree,
            prix: prix,
            materiel: materiel,
            matPayee: matPayee,
            workerIds: [],
            etapes: window.currentEtapes.slice(),
            progress: updateChantierProgress(window.currentEtapes)
          };
          window.chantiers.push(chantier);
          window.saveChantiers();
          renderChantiers();
          renderBaseChantiers();
          this.reset();
          window.currentEtapes = [];
          window.renderEtapes();
        } else {
          alert("Veuillez remplir correctement tous les champs du chantier.");
        }
      });
      function renderChantiers() {
        var tbody = document.querySelector("#table-chantier tbody");
        tbody.innerHTML = "";
        window.chantiers.forEach(function(c, idx) {
          var tr = document.createElement("tr");
          tr.innerHTML = "<td>" + c.nom + "</td>" +
                         "<td>" + c.duree + " j</td>" +
                         "<td>" + c.prix.toFixed(2) + " €</td>" +
                         "<td>" + c.materiel.toFixed(2) + " €</td>" +
                         "<td>" + c.progress.toFixed(0) + " %</td>" +
                         "<td><button class='action-btn' onclick='editChantier(" + idx + ")'>Modifier</button> " +
                         "<button class='action-btn' onclick='deleteChantier(" + idx + ")'>Supprimer</button> " +
                         "<button class='action-btn' onclick='editChantierSteps(" + idx + ")'>Modifier Étapes</button> " +
                         "<button class='action-btn' onclick='markChantierTermine(" + idx + ")'>Terminer</button></td>";
          tbody.appendChild(tr);
        });
      }
      window.editChantier = function(index) {
        var chantier = window.chantiers[index];
        var newNom = prompt("Modifier le nom du chantier :", chantier.nom);
        if(newNom !== null) { chantier.nom = newNom.trim() || chantier.nom; }
        window.saveChantiers();
        renderChantiers();
        renderBaseChantiers();
      };
      window.deleteChantier = function(index) {
        if(confirm("Supprimer le chantier " + window.chantiers[index].nom + " ?")) {
          window.chantiers.splice(index, 1);
          window.saveChantiers();
          renderChantiers();
          renderBaseChantiers();
        }
      };
      window.markChantierTermine = function(index) {
        if(confirm("Marquer le chantier '" + window.chantiers[index].nom + "' comme terminé ?")) {
          window.travauxFinis.push(window.chantiers[index]);
          window.saveTravauxFinis();
          window.chantiers.splice(index, 1);
          window.saveChantiers();
          renderChantiers();
          renderBaseChantiers();
          alert("Chantier terminé enregistré !");
        }
      };
      window.editChantierSteps = function(idx) {
        window.currentEditingChantier = idx;
        window.currentEtapesModal = window.chantiers[idx].etapes.slice();
        showStepsModal();
      };
      var currentEditingChantier = null;
      var currentEtapesModal = [];
      function showStepsModal() {
        populateStepsModal();
        document.getElementById("steps-modal").style.display = "flex";
      }
      function populateStepsModal() {
        var content = document.getElementById("steps-modal-content");
        content.innerHTML = "";
        currentEtapesModal.forEach(function(etape, i) {
          content.innerHTML += "<div style='margin-bottom:5px;'>" +
            "<label><input type='checkbox' onchange='toggleModalEtape(" + i + ")' " + (etape.done ? "checked" : "") + "> " + etape.description + "</label>" +
            "</div>";
        });
      }
      window.toggleModalEtape = function(i) {
        currentEtapesModal[i].done = !currentEtapesModal[i].done;
        populateStepsModal();
      };
      window.saveChantierSteps = function() {
        if(currentEditingChantier !== null) {
          window.chantiers[currentEditingChantier].etapes = currentEtapesModal.slice();
          window.chantiers[currentEditingChantier].progress = updateChantierProgress(currentEtapesModal);
          window.saveChantiers();
          renderChantiers();
          renderBaseChantiers();
          closeStepsModal();
        }
      };
      function closeStepsModal() {
        document.getElementById("steps-modal").style.display = "none";
        currentEditingChantier = null;
      }
      function renderBaseChantiers() {
        var tbodyActif = document.querySelector("#table-base-chantier-actif tbody");
        tbodyActif.innerHTML = "";
        window.chantiers.forEach(function(c) {
          var tr = document.createElement("tr");
          tr.innerHTML = "<td>" + c.nom + "</td>" +
                         "<td>" + c.duree + " j</td>" +
                         "<td>" + c.prix.toFixed(2) + " €</td>" +
                         "<td>" + c.progress.toFixed(0) + " %</td>" +
                         "<td><button class='action-btn' onclick=\"markChantierTermineFromBase('" + c.nom + "')\">Terminer</button></td>";
          tbodyActif.appendChild(tr);
        });
        var tbodyFini = document.querySelector("#table-base-chantier-fini tbody");
        tbodyFini.innerHTML = "";
        window.travauxFinis.forEach(function(c) {
          var tr = document.createElement("tr");
          tr.innerHTML = "<td>" + c.nom + "</td>" +
                         "<td>" + c.duree + " j</td>" +
                         "<td>" + c.prix.toFixed(2) + " €</td>";
          tbodyFini.appendChild(tr);
        });
      }
      window.markChantierTermineFromBase = function(nom) {
        var index = window.chantiers.findIndex(function(c) { return c.nom.toLowerCase() === nom.toLowerCase(); });
        if(index !== -1) {
          window.markChantierTermine(index);
          renderBaseChantiers();
        }
      };
      
      /* ---------- Options Supplémentaires ---------- */
      window._calculerMargeBeneficiaire = function() {
        var nom = prompt("Entrez le nom du chantier pour calculer la marge :");
        if(!nom) return;
        var chantier = window.chantiers.find(function(c) { return c.nom.toLowerCase() === nom.toLowerCase(); });
        if(!chantier) { alert("Chantier non trouvé."); return; }
        var coutOuvriers = 0;
        if(chantier.workerIds && chantier.duree) {
          chantier.workerIds.forEach(function(name) {
            var worker = window.ouvriers.find(function(o) { return o.nom.toLowerCase() === name.toLowerCase(); });
            if(worker) { coutOuvriers += worker.tarif * chantier.duree; }
          });
        }
        var coutMateriel = chantier.matPayee ? 0 : chantier.materiel;
        var coutTotal = (chantier.prix * 0.22) + coutOuvriers + coutMateriel;
        var marge = ((chantier.prix - coutTotal) / chantier.prix) * 100;
        document.getElementById("plusoptions-output").innerText = "Marge bénéficiaire du chantier '" + chantier.nom + "' : " + marge.toFixed(2) + " %";
      };
      window._previsionTresorerie = function() {
        var mois = parseInt(prompt("Sur combien de mois projeter la trésorerie ?"));
        if(isNaN(mois) || mois <= 0) { alert("Valeur invalide."); return; }
        var soldeText = document.getElementById("global-balance").innerText;
        var solde = parseFloat(soldeText.replace(/[^\d.-]/g, ""));
        var projection = solde * mois;
        document.getElementById("plusoptions-output").innerText = "Projection sur " + mois + " mois : " + projection.toFixed(2) + " €";
      };
      window._analyserRentabiliteProjet = function() {
        var nom = prompt("Entrez le nom du projet à analyser :");
        if(!nom) return;
        var projet = window.projets.find(function(p) { return p.nom.toLowerCase() === nom.toLowerCase(); });
        if(!projet) { alert("Projet non trouvé."); return; }
        var revenuEstime = parseFloat(prompt("Revenu estimé pour ce projet (€) :"));
        if(isNaN(revenuEstime)) { alert("Valeur invalide."); return; }
        var roi = ((revenuEstime - projet.prix) / projet.prix) * 100;
        document.getElementById("plusoptions-output").innerText = "ROI pour le projet '" + projet.nom + "' : " + roi.toFixed(2) + " %";
      };
      window._genererEcheancier = function() {
        var montantTotal = parseFloat(prompt("Montant total (€) :"));
        var mois = parseInt(prompt("Répartir sur combien de mois ?"));
        if(isNaN(montantTotal) || isNaN(mois) || mois <= 0) { alert("Valeurs invalides."); return; }
        var montantMensuel = montantTotal / mois;
        var echeancier = "Échéancier :\n";
        var date = new Date();
        for(var i = 1; i <= mois; i++) {
          date.setMonth(date.getMonth() + 1);
          echeancier += "Mois " + i + " (" + date.toLocaleDateString() + ") : " + montantMensuel.toFixed(2) + " €\n";
        }
        document.getElementById("plusoptions-output").innerText = echeancier;
      };
      window._comparerCouts = function() {
        var nom1 = prompt("Entrez le nom du premier chantier :");
        var nom2 = prompt("Entrez le nom du deuxième chantier :");
        if(!nom1 || !nom2) return;
        var chantier1 = window.chantiers.find(function(c) { return c.nom.toLowerCase() === nom1.toLowerCase(); });
        var chantier2 = window.chantiers.find(function(c) { return c.nom.toLowerCase() === nom2.toLowerCase(); });
        if(!chantier1 || !chantier2) { alert("Un des chantiers est introuvable."); return; }
        var cout1 = chantier1.prix + chantier1.materiel;
        var cout2 = chantier2.prix + chantier2.materiel;
        var message = "Comparaison :\n" +
                      chantier1.nom + " : " + cout1.toFixed(2) + " €\n" +
                      chantier2.nom + " : " + cout2.toFixed(2) + " €\n";
        message += (cout1 < cout2) ? chantier1.nom + " est moins cher." : (cout2 < cout1) ? chantier2.nom + " est moins cher." : "Les deux ont le même coût.";
        document.getElementById("plusoptions-output").innerText = message;
      };
      window._planifierTaches = function() {
        var nb = parseInt(prompt("Nombre de tâches à planifier :"));
        if(isNaN(nb) || nb <= 0) { alert("Nombre invalide."); return; }
        var taches = [];
        for(var i = 0; i < nb; i++) {
          var tache = prompt("Tâche " + (i+1) + " :");
          var dateLimite = prompt("Date limite (AAAA-MM-JJ) pour la tâche " + (i+1) + " :");
          if(tache && dateLimite) { taches.push({ tache: tache, dateLimite: dateLimite }); }
        }
        taches.sort(function(a, b) { return new Date(a.dateLimite) - new Date(b.dateLimite); });
        var message = "Tâches planifiées :\n";
        taches.forEach(function(t, i) { message += (i+1) + ". " + t.tache + " (avant " + t.dateLimite + ")\n"; });
        document.getElementById("plusoptions-output").innerText = message;
      };
      window._simulerInvestissement = function() {
        var principal = parseFloat(prompt("Montant investi initialement (€) :"));
        var taux = parseFloat(prompt("Taux d'intérêt annuel (%) :"));
        var annees = parseInt(prompt("Durée de l'investissement (années) :"));
        if(isNaN(principal) || isNaN(taux) || isNaN(annees)) { alert("Valeurs invalides."); return; }
        var montantFinal = principal * Math.pow((1 + taux/100), annees);
        document.getElementById("plusoptions-output").innerText = "Après " + annees + " ans, " + principal.toFixed(2) + " € à " + taux + "% donnera " + montantFinal.toFixed(2) + " €.";
      };
      window._calculerTVAAvance = function() {
        var montant = parseFloat(prompt("Montant hors taxe (€) :"));
        var taux = parseFloat(prompt("Taux de TVA (%) :"));
        if(isNaN(montant) || isNaN(taux)) { alert("Valeurs invalides."); return; }
        var tva = montant * (taux/100);
        document.getElementById("plusoptions-output").innerText = "TVA à " + taux + "% sur " + montant.toFixed(2) + " € = " + tva.toFixed(2) + " € (Total TTC = " + (montant+tva).toFixed(2) + " €)";
      };
      window._genererRapportPersonnalise = function() {
        var dateDebut = prompt("Date de début (AAAA-MM-JJ) :");
        var dateFin = prompt("Date de fin (AAAA-MM-JJ) :");
        if(!dateDebut || !dateFin) { alert("Dates invalides."); return; }
        document.getElementById("plusoptions-output").innerText = "Rapport pour la période du " + dateDebut + " au " + dateFin + ".";
      };
      window._analyserAvancee = function() {
        alert("Analyse avancée en cours de développement…");
      };
      
      /* ---------- Importation / Exportation / Utilitaires ---------- */
      window.exportAllData = function() {
        var allData = {
          ouvriers: window.ouvriers,
          baseOuvriers: window.baseOuvriers,
          chantiers: window.chantiers,
          revenus: window.revenus,
          revenusAttente: window.revenusAttente,
          depenses: window.depenses,
          depensesPrevues: window.depensesPrevues,
          projets: window.projets,
          travauxFinis: window.travauxFinis,
          achats: window.achats,
          groupedAchats: window.groupedAchats
        };
        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
        var dlAnchorElem = document.createElement("a");
        dlAnchorElem.setAttribute("href", dataStr);
        dlAnchorElem.setAttribute("download", "donnees_entreprise.json");
        dlAnchorElem.click();
      };
      window.importAllData = function() {
        document.getElementById("import-file").click();
      };
      window.handleImport = function(event) {
        var file = event.target.files[0];
        if(!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
          try {
            var importedData = JSON.parse(e.target.result);
            if(importedData.ouvriers) {
              window.ouvriers = importedData.ouvriers;
              window.saveOuvriers();
              window.renderOuvriers();
              populateOuvrierSelect();
            }
            if(importedData.baseOuvriers) {
              window.baseOuvriers = importedData.baseOuvriers;
              window.saveBaseOuvriers();
              renderBaseOuvriers();
            }
            if(importedData.chantiers) {
              window.chantiers = importedData.chantiers;
              window.saveChantiers();
              renderChantiers();
              renderBaseChantiers();
            }
            if(importedData.revenus) { window.revenus = importedData.revenus; }
            if(importedData.depenses) { window.depenses = importedData.depenses; }
            if(importedData.projets) {
              window.projets = importedData.projets;
              window.saveProjets();
              window.renderProjets();
            }
            if(importedData.travauxFinis) {
              window.travauxFinis = importedData.travauxFinis;
              window.saveTravauxFinis();
            }
            if(importedData.achats) { window.achats = importedData.achats; window.renderAchats(); }
            if(importedData.groupedAchats) { window.groupedAchats = importedData.groupedAchats; renderGroupedAchats(); }
            renderFinanceSummary();
            alert("Importation réussie !");
          } catch(error) {
            alert("Erreur lors de l'importation des données.");
          }
        };
        reader.readAsText(file);
      };
      window.clearAllData = function() {
        if(confirm("Tout réinitialiser ? Cette action effacera toutes vos données.")) { localStorage.clear(); location.reload(); }
      };
      window.showHelp = function() {
        alert("Utilitaires :\n1. Exporter données\n2. Importer données\n3. Réinitialiser toutes les données\n4. Afficher Synthèse\n5. Autres options...");
      };
      window.viewSummary = function() { generateReport(); };
      function generateReport() {
        var reportHTML = "<h3>Rapport Global</h3>";
        reportHTML += "<h4>Ouvriers</h4><ul>";
        window.ouvriers.forEach(function(o) { reportHTML += "<li>" + o.nom + " – Tarif: " + o.tarif + " €, Jours: " + o.jours + ", Total: " + (o.tarif * o.jours).toFixed(2) + " €</li>"; });
        reportHTML += "</ul><h4>Chantiers Actifs</h4><ul>";
        window.chantiers.forEach(function(c) { reportHTML += "<li>" + c.nom + " – Durée: " + c.duree + " j, Prix: " + c.prix + " €</li>"; });
        reportHTML += "</ul><h4>Travaux Terminés</h4><ul>";
        window.travauxFinis.forEach(function(c) { reportHTML += "<li>" + c.nom + " – Durée: " + c.duree + " j, Prix: " + c.prix + " €</li>"; });
        reportHTML += "</ul><h4>Projets</h4><ul>";
        window.projets.forEach(function(p) { reportHTML += "<li>" + p.nom + " – Budget: " + p.prix + ", Délai: " + p.duree + " mois</li>"; });
        reportHTML += "</ul><h4>Finance</h4>";
        reportHTML += "<p>" + document.getElementById("manual-revenus").innerText + "</p>";
        reportHTML += "<p>" + document.getElementById("revenus-attente").innerText + "</p>";
        reportHTML += "<p>" + document.getElementById("manual-depenses").innerText + "</p>";
        reportHTML += "<p>" + document.getElementById("depenses-prevues").innerText + "</p>";
        reportHTML += "<p>" + document.getElementById("global-balance").innerText + "</p>";
        document.getElementById("report-data").innerHTML = reportHTML;
        document.getElementById("report-modal").style.display = "flex";
      }
      window.closeReport = function() { document.getElementById("report-modal").style.display = "none"; };
      window.printReport = function() {
        var printContent = document.getElementById("report-data").innerHTML;
        var originalContent = document.body.innerHTML;
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        location.reload();
      };
      window.downloadReportCSV = function() {
        var csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Type,Description,Montant\n";
        window.revenus.forEach(function(r) { csvContent += "Revenu," + r.description + "," + r.amount + "\n"; });
        window.revenusAttente.forEach(function(r) { csvContent += "Revenu en attente," + r.description + "," + r.amount + "\n"; });
        window.depenses.forEach(function(d) { csvContent += "Dépense," + d.description + "," + d.amount + "\n"; });
        window.depensesPrevues.forEach(function(d) { csvContent += "Dépense prévue," + d.description + "," + d.amount + "\n"; });
        window.ouvriers.forEach(function(o) {
          var total = o.tarif * o.jours;
          csvContent += "Ouvrier," + o.nom + " – Tarif: " + o.tarif + ", Total: " + total.toFixed(2) + "\n";
        });
        window.chantiers.forEach(function(c) { csvContent += "Chantier," + c.nom + " – Durée: " + c.duree + " j, " + c.prix + "\n"; });
        window.projets.forEach(function(p) { csvContent += "Projet," + p.nom + " – Budget: " + p.prix + ", Délai: " + p.duree + " mois\n"; });
        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "rapport_global.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
      
      /* ---------- Définition des Fonctions Globales pour être appelées depuis le HTML ---------- */
      window.refreshAll = function() {
        window.renderOuvriers();
        populateOuvrierSelect();
        renderBaseOuvriers();
        renderChantiers();
        renderBaseChantiers();
        renderFinanceSummary();
      };
      // On appelle refreshAll pour initialiser les vues
      window.refreshAll();
    });
  </script>
</body>
</html>
