<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Koloral Sheqiri - Gestion d'Entreprise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Logo & script progressier (pour affichage de logo par exemple) -->
  <link rel="manifest" href="https://progressier.app/VcIlgfTcnkCBYCcm7COM/progressier.json"/>
  <script defer src="https://progressier.app/VcIlgfTcnkCBYCcm7COM/script.js"></script>
  <!-- Manifest de l'application -->
  <link rel="manifest" href="manifest.json">
  <style>
    /* Palette : Bleu clair (#ADD8E6), Blanc, Noir */
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFFFFF;
      color: #000;
    }
    header {
      background-color: #000;
      color: #FFF;
      text-align: center;
      padding: 1em;
      position: relative;
      border-bottom: 2px solid #000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    header h1 {
      margin: 0;
      font-size: 1.8em;
    }
    /* Bouton personnel */
    .personal-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #FFF;
      color: #000;
      border: 1px solid #000;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .personal-menu {
      position: absolute;
      top: 45px;
      right: 10px;
      background-color: #FFF;
      border: 1px solid #000;
      border-radius: 4px;
      display: none;
      z-index: 10;
    }
    .personal-menu a {
      display: block;
      padding: 8px 12px;
      text-decoration: none;
      color: #000;
      border-bottom: 1px solid #000;
      font-size: 0.9em;
    }
    .personal-menu a:last-child { border-bottom: none; }
    .personal-menu a:hover {
      background-color: #000;
      color: #FFF;
    }
    .container {
      max-width: 700px;
      margin: 20px auto;
      background-color: #ADD8E6;
      padding: 20px;
      border: 2px solid #000;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    nav {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #000;
    }
    nav button {
      flex: 1;
      padding: 12px;
      background-color: #FFF;
      border: 1px solid #000;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 1em;
    }
    nav button.active,
    nav button:hover {
      background-color: #000;
      color: #FFF;
    }
    section { display: none; animation: fadeIn 0.5s; }
    section.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    form {
      margin: 10px 0;
    }
    form input, form select, form textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #000;
      border-radius: 4px;
      font-size: 0.95em;
      background-color: #FFF;
    }
    form button {
      padding: 10px;
      background-color: #000;
      color: #FFF;
      border: 1px solid #000;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
      margin-top: 6px;
    }
    form button:hover { background-color: #ADD8E6; color: #000; }
    /* Pour les tableaux, on les encapsule dans un conteneur défilant */
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td { border: 1px solid #000; }
    th, td {
      padding: 8px;
      text-align: left;
      font-size: 0.9em;
      background-color: #FFF;
    }
    th { background-color: #000; color: #FFF; }
    .action-btn {
      margin-right: 5px;
      padding: 6px 8px;
      background-color: #000;
      color: #FFF;
      border: 1px solid #000;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85em;
    }
    .action-btn:hover { background-color: #ADD8E6; color: #000; }
    /* Progress Bar pour les chantiers */
    .progress-container {
      width: 100%;
      background-color: #DDD;
      border: 1px solid #000;
      border-radius: 4px;
      margin-top: 8px;
      height: 18px;
    }
    .progress-bar {
      height: 100%;
      background-color: #000;
      width: 0%;
      border-radius: 4px;
      transition: width 0.3s;
    }
    /* Modal Rapport */
    .report-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .report-content {
      background-color: #FFF;
      padding: 20px;
      border-radius: 8px;
      max-height: 80%;
      overflow-y: auto;
      width: 90%;
      max-width: 800px;
      color: #000;
      border: 2px solid #000;
    }
    .close-report {
      float: right;
      cursor: pointer;
      font-size: 1.5em;
    }
    .extra-btn {
      margin: 5px 0;
      padding: 10px;
      background-color: #000;
      color: #FFF;
      border: 1px solid #000;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s;
    }
    .extra-btn:hover { background-color: #ADD8E6; color: #000; }
    /* Module Projet */
    #section-projet { padding: 10px 0; }
    #form-projet {
      border: 1px solid #000;
      padding: 10px;
      border-radius: 4px;
      background-color: #FFF;
      margin-bottom: 10px;
    }
    #form-projet input, #form-projet select {
      margin-bottom: 8px;
    }
    #projet-list table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #projet-list th, #projet-list td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <header>
    <h1>Koloral Sheqiri</h1>
    <button class="personal-btn" id="personal-btn">Menu Perso</button>
    <div class="personal-menu" id="personal-menu">
      <a href="https://koloral.fr" target="_blank">Koloral.fr</a>
      <a href="https://hostinger.com" target="_blank">Hostinger</a>
    </div>
  </header>
  <div class="container">
    <!-- Navigation principale -->
    <nav>
      <button id="tab-ouvriers" class="active">Ouvriers</button>
      <button id="tab-chantier">Chantiers</button>
      <button id="tab-finance">Finance</button>
      <button id="tab-projet">Projet</button>
      <button id="tab-utilitaires">Utilitaires</button>
    </nav>

    <!-- Module Ouvriers -->
    <section id="section-ouvriers" class="active">
      <h2>Ouvriers</h2>
      <form id="form-ouvrier">
        <select id="ouvrier-select">
          <option value="">Sélectionner un ouvrier (facultatif)</option>
        </select>
        <input type="text" id="ouvrier-nom" placeholder="Nom de l'ouvrier">
        <input type="number" id="ouvrier-tarif" placeholder="Prix à la journée (€)" step="0.01" required>
        <input type="number" id="ouvrier-jours" placeholder="Temps de travail (en jours)" step="0.1" required>
        <button type="submit">Enregistrer / Mettre à jour</button>
      </form>
      <div class="table-container">
        <table id="table-ouvriers">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Prix/jour</th>
              <th>Jours total</th>
              <th>Total</th>
              <th>Paiement</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="extra-btn" onclick="sortOuvriersByTotal()">Trier par Total</button>
      <button class="extra-btn" onclick="resetOuvriers()">Réinitialiser Ouvriers</button>
    </section>

    <!-- Module Chantiers -->
    <section id="section-chantier">
      <h2>Chantiers</h2>
      <form id="form-chantier">
        <input type="text" id="chantier-nom" placeholder="Nom du chantier" required>
        <input type="number" id="chantier-duree" placeholder="Durée (en jours)" step="1" required>
        <input type="number" id="chantier-prix" placeholder="Prix du chantier (€)" step="0.01" required>
        <input type="number" id="chantier-materiel" placeholder="Coût des matériaux (€)" step="0.01" required>
        <label><input type="checkbox" id="chantier-mat-payee"> Matériaux payés</label>
        <h3>Étapes du Chantier</h3>
        <div id="etapes-container"></div>
        <div style="display:flex; gap:5px; margin-top:8px;">
          <input type="text" id="etape-input" placeholder="Description de l'étape">
          <button type="button" onclick="addEtape()">Ajouter étape</button>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <button type="submit">Enregistrer chantier</button>
      </form>
      <div class="table-container">
        <table id="table-chantier">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Durée</th>
              <th>Prix</th>
              <th>Matériaux</th>
              <th>Avancement</th>
              <th>Coût ouvriers</th>
              <th>Bénéf. final</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="extra-btn" onclick="resetChantiers()">Réinitialiser Chantiers</button>
      <button class="extra-btn" onclick="editChantierSteps()">Modifier étapes (post-enregistrement)</button>
    </section>

    <!-- Module Finance -->
    <section id="section-finance">
      <h2>Finance</h2>
      <div>
        <h3>Revenus Manuels</h3>
        <form id="form-revenu">
          <input type="text" id="revenu-description" placeholder="Description du revenu" required>
          <input type="number" id="revenu-montant" placeholder="Montant (€)" step="0.01" required>
          <button type="submit">Ajouter revenu</button>
        </form>
      </div>
      <div>
        <h3>Dépenses Manuelles</h3>
        <form id="form-depense">
          <input type="text" id="depense-description" placeholder="Description de la dépense" required>
          <input type="number" id="depense-montant" placeholder="Montant (€)" step="0.01" required>
          <button type="submit">Ajouter dépense</button>
        </form>
      </div>
      <div id="finance-summary">
        <p id="manual-revenus">Revenus manuels : 0 €</p>
        <p id="manual-depenses">Dépenses manuelles : 0 €</p>
        <p id="auto-ouvriers">Dépenses ouvriers (non payés) : 0 €</p>
        <p id="auto-materiel">Dépenses matériaux (non payés) : 0 €</p>
        <p id="global-balance">Solde global : 0 €</p>
      </div>
      <button class="extra-btn" onclick="resetFinance()">Réinitialiser Finance</button>
      <button class="extra-btn" onclick="exportFinanceJSON()">Exporter Finance JSON</button>
      <button class="extra-btn" onclick="generateReport()">Générer Rapport</button>
      <button class="extra-btn" onclick="downloadReportCSV()">Télécharger Rapport CSV</button>
    </section>

    <!-- Module Projet -->
    <section id="section-projet">
      <h2>Projet</h2>
      <form id="form-projet">
        <input type="text" id="projet-nom" placeholder="Nom du projet" required>
        <input type="number" id="projet-prix" placeholder="Budget total (€)" step="0.01" required>
        <label>
          <input type="checkbox" id="projet-ajout-lien" onchange="toggleLienProjet()"> Ajouter un lien
        </label>
        <input type="url" id="projet-lien" placeholder="URL du projet" style="display:none;">
        <input type="number" id="projet-duree" placeholder="Durée souhaitée (mois)" step="1" required>
        <label>
          <input type="checkbox" id="projet-mode-inverse"> Mode Inverse (entrer montant mensuel)
        </label>
        <input type="number" id="projet-mensuel" placeholder="Budget mensuel (€)" step="0.01">
        <select id="projet-priorite">
          <option value="1">Priorité 1 (Haute)</option>
          <option value="2">Priorité 2</option>
          <option value="3">Priorité 3 (Normale)</option>
          <option value="4">Priorité 4</option>
          <option value="5">Priorité 5 (Basse)</option>
        </select>
        <button type="button" onclick="calculateProjet()">Calculer Projet</button>
      </form>
      <div id="projet-resultat" style="margin-top:10px; border:1px solid #000; padding:10px; border-radius:4px; background-color:#FFF;"></div>
      <h3>Suivi Mensuel</h3>
      <div id="projet-suivi"></div>
      <button class="extra-btn" onclick="resetProjets()">Réinitialiser Projets</button>
    </section>

    <!-- Module Utilitaires -->
    <section id="section-utilitaires">
      <h2>Utilitaires</h2>
      <button class="extra-btn" onclick="exportAllData()">Exporter données (JSON)</button>
      <button class="extra-btn" onclick="importAllData()">Importer données (JSON)</button>
      <input type="file" id="import-file" accept="application/json" style="display:none" onchange="handleImport(event)">
      <button class="extra-btn" onclick="clearAllData()">Tout réinitialiser</button>
      <button class="extra-btn" onclick="showHelp()">Afficher aide</button>
      <button class="extra-btn" onclick="viewSummary()">Afficher Synthèse</button>
    </section>
  </div>

  <!-- Modal Rapport -->
  <div id="report-modal" class="report-modal">
    <div class="report-content">
      <span class="close-report" onclick="closeReport()">&times;</span>
      <h2>Rapport Global</h2>
      <div id="report-data"></div>
      <button class="extra-btn" onclick="printReport()">Imprimer Rapport</button>
    </div>
  </div>

  <script>
    // Navigation entre modules
    function setActiveTab(tab) {
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('section-' + tab).classList.add('active');
      if(tab === 'chantier') { populateChantierWorkers(); }
      if(tab === 'ouvriers') { populateOuvrierSelect(); }
    }
    ['ouvriers', 'chantier', 'finance', 'projet', 'utilitaires'].forEach(t => {
      document.getElementById('tab-' + t).addEventListener('click', () => setActiveTab(t));
    });

    // Menu personnel
    const personalBtn = document.getElementById('personal-btn');
    const personalMenu = document.getElementById('personal-menu');
    personalBtn.addEventListener('click', () => {
      personalMenu.style.display = (personalMenu.style.display === "block") ? "none" : "block";
    });
    document.addEventListener('click', function(e) {
      if (!personalBtn.contains(e.target) && !personalMenu.contains(e.target)) {
        personalMenu.style.display = "none";
      }
    });

    // Stockage Local
    const STORAGE_WORKERS = 'gestion_ouvriers';
    const STORAGE_CHANTIERS = 'gestion_chantiers';
    const STORAGE_REVENUS = 'gestion_revenus';
    const STORAGE_DEPENSES = 'gestion_depenses';
    const STORAGE_PROJETS = 'gestion_projets';

    /* Module Ouvriers */
    let ouvriers = JSON.parse(localStorage.getItem(STORAGE_WORKERS)) || [];
    function saveOuvriers() { localStorage.setItem(STORAGE_WORKERS, JSON.stringify(ouvriers)); }
    function renderOuvriers() {
      const tbody = document.querySelector('#table-ouvriers tbody');
      tbody.innerHTML = '';
      ouvriers.forEach(o => {
        const total = o.tarif * o.jours;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${o.nom}</td>
                        <td>${o.tarif.toFixed(2)} €</td>
                        <td>${o.jours.toFixed(1)}</td>
                        <td>${total.toFixed(2)} €</td>
                        <td><input type="checkbox" ${o.paye ? 'checked' : ''} onchange="toggleOuvrierPay('${o.nom}')"></td>
                        <td>
                          <button class="action-btn" onclick="editOuvrier('${o.nom}')">Modifier</button>
                          <button class="action-btn" onclick="deleteOuvrier('${o.nom}')">Supprimer</button>
                        </td>`;
        tbody.appendChild(tr);
      });
    }
    function toggleOuvrierPay(nom) {
      const index = ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
      if (index !== -1) {
        ouvriers[index].paye = !ouvriers[index].paye;
        saveOuvriers();
        renderOuvriers();
        renderFinanceSummary();
      }
    }
    function deleteOuvrier(nom) {
      if (confirm("Supprimer l'ouvrier " + nom + " ?")) {
        ouvriers = ouvriers.filter(o => o.nom.toLowerCase() !== nom.toLowerCase());
        saveOuvriers();
        renderOuvriers();
        populateOuvrierSelect();
        renderFinanceSummary();
      }
    }
    function editOuvrier(nom) {
      const index = ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
      if (index !== -1) {
        const newTarif = prompt("Modifier le tarif journalier pour " + nom + " :", ouvriers[index].tarif);
        const newJours = prompt("Modifier le nombre de jours pour " + nom + " :", ouvriers[index].jours);
        if (newTarif !== null && newJours !== null) {
          ouvriers[index].tarif = parseFloat(newTarif) || ouvriers[index].tarif;
          ouvriers[index].jours = parseFloat(newJours) || ouvriers[index].jours;
          saveOuvriers();
          renderOuvriers();
          renderFinanceSummary();
        }
      }
    }
    document.getElementById('form-ouvrier').addEventListener('submit', function(e) {
      e.preventDefault();
      let nom = document.getElementById('ouvrier-nom').value.trim();
      const select = document.getElementById('ouvrier-select');
      if (select.value && !nom) { nom = select.value; }
      const tarif = parseFloat(document.getElementById('ouvrier-tarif').value);
      const jours = parseFloat(document.getElementById('ouvrier-jours').value);
      if (nom && !isNaN(tarif) && !isNaN(jours)) {
        const index = ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
        if (index !== -1) {
          ouvriers[index].jours += jours;
          ouvriers[index].tarif = tarif;
        } else {
          ouvriers.push({ nom, tarif, jours, paye: false });
        }
        saveOuvriers();
        renderOuvriers();
        populateOuvrierSelect();
        this.reset();
      }
    });
    renderOuvriers();
    function populateOuvrierSelect() {
      const select = document.getElementById('ouvrier-select');
      select.innerHTML = '<option value="">Sélectionner un ouvrier (facultatif)</option>';
      ouvriers.forEach(o => {
        select.innerHTML += `<option value="${o.nom}">${o.nom}</option>`;
      });
    }
    populateOuvrierSelect();

    /* Module Chantiers */
    let chantiers = JSON.parse(localStorage.getItem(STORAGE_CHANTIERS)) || [];
    function saveChantiers() { localStorage.setItem(STORAGE_CHANTIERS, JSON.stringify(chantiers)); }
    function renderChantiers() {
      const tbody = document.querySelector('#table-chantier tbody');
      tbody.innerHTML = '';
      chantiers.forEach((c, idx) => {
        let coutOuvriers = 0;
        if (c.workerIds && c.duree) {
          c.workerIds.forEach(name => {
            const worker = ouvriers.find(o => o.nom === name);
            if (worker) { coutOuvriers += worker.tarif * c.duree; }
          });
        }
        const coutMateriel = c.matPayee ? 0 : c.materiel;
        const benef = c.prix - (c.prix * 0.22) - coutOuvriers - coutMateriel;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.nom}</td>
                        <td>${c.duree} j</td>
                        <td>${c.prix.toFixed(2)} €</td>
                        <td>${c.materiel.toFixed(2)} €</td>
                        <td>${c.progress.toFixed(0)} %</td>
                        <td>${coutOuvriers.toFixed(2)} €</td>
                        <td>${benef.toFixed(2)} €</td>
                        <td>
                          <button class="action-btn" onclick="editChantier(${idx})">Modifier</button>
                          <button class="action-btn" onclick="deleteChantier(${idx})">Supprimer</button>
                          <button class="action-btn" onclick="editChantierSteps(${idx})">Modifier étapes</button>
                        </td>`;
        tbody.appendChild(tr);
      });
    }
    // Modification des étapes d'un chantier déjà enregistré
    function editChantierSteps(idx) {
      const chantier = chantiers[idx];
      const newEtapes = prompt("Modifier les étapes (séparez par des virgules) :", chantier.etapes.map(e => e.description).join(", "));
      if (newEtapes !== null) {
        const etapeArr = newEtapes.split(",").map(s => s.trim()).filter(s => s !== "");
        chantier.etapes = etapeArr.map(desc => ({ description: desc, done: false }));
        chantier.progress = updateChantierProgress(chantier.etapes);
        saveChantiers();
        renderChantiers();
      }
    }
    // Pour la création d'un chantier
    let currentEtapes = [];
    function addEtape() {
      const etapeInput = document.getElementById('etape-input');
      const desc = etapeInput.value.trim();
      if (desc === "") return;
      currentEtapes.push({ description: desc, done: false });
      etapeInput.value = "";
      renderEtapes();
    }
    function renderEtapes() {
      const container = document.getElementById('etapes-container');
      container.innerHTML = "";
      currentEtapes.forEach((etape, index) => {
        container.innerHTML += `<div style="margin-bottom:5px; border:1px solid #000; padding:4px; border-radius:4px;">
          <label>
            <input type="checkbox" onchange="toggleEtape(${index})" ${etape.done ? "checked" : ""}>
            ${etape.description}
          </label>
        </div>`;
      });
      const progress = updateChantierProgress(currentEtapes);
      document.getElementById('progress-bar').style.width = progress + "%";
    }
    function toggleEtape(index) {
      currentEtapes[index].done = !currentEtapes[index].done;
      renderEtapes();
    }
    function updateChantierProgress(etapes) {
      if (!etapes || etapes.length === 0) return 0;
      const completed = etapes.filter(e => e.done).length;
      return (completed / etapes.length) * 100;
    }
    document.getElementById('form-chantier').addEventListener('submit', function(e) {
      e.preventDefault();
      const nom = document.getElementById('chantier-nom').value.trim();
      const duree = parseFloat(document.getElementById('chantier-duree').value);
      const prix = parseFloat(document.getElementById('chantier-prix').value);
      const materiel = parseFloat(document.getElementById('chantier-materiel').value);
      const matPayee = document.getElementById('chantier-mat-payee').checked;
      const workerCheckboxes = document.querySelectorAll('#chantier-workers input[type="checkbox"]');
      let selectedWorkerIds = [];
      workerCheckboxes.forEach(cb => { if (cb.checked) selectedWorkerIds.push(cb.value); });
      if (nom && !isNaN(duree) && !isNaN(prix) && !isNaN(materiel)) {
        const chantier = {
          nom,
          duree,
          prix,
          materiel,
          matPayee,
          workerIds: selectedWorkerIds,
          etapes: currentEtapes.slice(),
          progress: updateChantierProgress(currentEtapes)
        };
        chantiers.push(chantier);
        saveChantiers();
        renderChantiers();
        this.reset();
        currentEtapes = [];
        renderEtapes();
        populateChantierWorkers();
      }
    });
    function editChantier(index) {
      const chantier = chantiers[index];
      const newNom = prompt("Modifier le nom du chantier :", chantier.nom);
      if (newNom !== null) { chantier.nom = newNom.trim() || chantier.nom; }
      const newDuree = prompt("Modifier la durée (jours) :", chantier.duree);
      if (newDuree !== null) { chantier.duree = parseFloat(newDuree) || chantier.duree; }
      const newPrix = prompt("Modifier le prix du chantier (€) :", chantier.prix);
      if (newPrix !== null) { chantier.prix = parseFloat(newPrix) || chantier.prix; }
      const newMateriel = prompt("Modifier le coût des matériaux (€) :", chantier.materiel);
      if (newMateriel !== null) { chantier.materiel = parseFloat(newMateriel) || chantier.materiel; }
      chantier.progress = updateChantierProgress(chantier.etapes);
      saveChantiers();
      renderChantiers();
    }
    function deleteChantier(index) {
      if (confirm("Supprimer le chantier " + chantiers[index].nom + " ?")) {
        chantiers.splice(index, 1);
        saveChantiers();
        renderChantiers();
      }
    }
    function resetChantiers() {
      if (confirm("Réinitialiser tous les chantiers ?")) {
        chantiers = [];
        saveChantiers();
        renderChantiers();
      }
    }
    function populateChantierWorkers() {
      const container = document.getElementById('chantier-workers');
      container.innerHTML = '<p>Sélectionnez les ouvriers affectés :</p>';
      ouvriers.forEach(o => {
        container.innerHTML += `<label style="margin-right:10px;">
                                  <input type="checkbox" value="${o.nom}"> ${o.nom}
                                </label>`;
      });
    }
    renderChantiers();

    /* Module Finance */
    let revenus = JSON.parse(localStorage.getItem(STORAGE_REVENUS)) || [];
    let depenses = JSON.parse(localStorage.getItem(STORAGE_DEPENSES)) || [];
    function saveFinance() {
      localStorage.setItem(STORAGE_REVENUS, JSON.stringify(revenus));
      localStorage.setItem(STORAGE_DEPENSES, JSON.stringify(depenses));
    }
    function renderFinanceSummary() {
      const totalRevenus = revenus.reduce((sum, r) => sum + r.amount, 0);
      const totalDepensesManuelles = depenses.reduce((sum, d) => sum + d.amount, 0);
      const autoOuvriers = ouvriers.filter(o => !o.paye).reduce((sum, o) => sum + (o.tarif * o.jours), 0);
      const autoMateriel = chantiers.reduce((sum, c) => sum + (c.matPayee ? 0 : c.materiel), 0);
      const totalDepenses = totalDepensesManuelles + autoOuvriers + autoMateriel;
      const net = totalRevenus - totalDepenses;
      document.getElementById('manual-revenus').innerText = "Revenus manuels : " + totalRevenus.toFixed(2) + " €";
      document.getElementById('manual-depenses').innerText = "Dépenses manuelles : " + totalDepensesManuelles.toFixed(2) + " €";
      document.getElementById('auto-ouvriers').innerText = "Dépenses ouvriers (non payés) : " + autoOuvriers.toFixed(2) + " €";
      document.getElementById('auto-materiel').innerText = "Dépenses matériaux (non payés) : " + autoMateriel.toFixed(2) + " €";
      document.getElementById('global-balance').innerText = "Solde global : " + net.toFixed(2) + " €";
    }
    document.getElementById('form-revenu').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('revenu-description').value.trim();
      const amount = parseFloat(document.getElementById('revenu-montant').value);
      if (description && !isNaN(amount)) {
        revenus.push({ description, amount });
        saveFinance();
        renderFinanceSummary();
        this.reset();
      }
    });
    document.getElementById('form-depense').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('depense-description').value.trim();
      const amount = parseFloat(document.getElementById('depense-montant').value);
      if (description && !isNaN(amount)) {
        depenses.push({ description, amount });
        saveFinance();
        renderFinanceSummary();
        this.reset();
      }
    });
    renderFinanceSummary();

    /* Module Projet */
    let projets = JSON.parse(localStorage.getItem(STORAGE_PROJETS)) || [];
    function saveProjets() { localStorage.setItem(STORAGE_PROJETS, JSON.stringify(projets)); }
    function renderProjets() {
      const container = document.getElementById('projet-resultat');
      if (projets.length === 0) {
        container.innerHTML = "<p>Aucun projet enregistré.</p>";
      } else {
        let html = "<table id='projet-list'><thead><tr><th>Nom</th><th>Budget (€)</th><th>Lien</th><th>Délai (mois)</th><th>Mode</th><th>Calcul</th><th>Priorité</th><th>Actions</th></tr></thead><tbody>";
        projets.forEach((p, idx) => {
          html += `<tr>
            <td>${p.nom}</td>
            <td>${p.prix.toFixed(2)}</td>
            <td>${p.lien ? `<a href="${p.lien}" target="_blank">Lien</a>` : "-"}</td>
            <td>${p.duree} mois</td>
            <td>${p.mode}</td>
            <td>${p.calcul}</td>
            <td>${p.priorite}</td>
            <td>
              <button class="action-btn" onclick="editProjet(${idx})">Modifier</button>
              <button class="action-btn" onclick="deleteProjet(${idx})">Supprimer</button>
            </td>
          </tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }
    }
    function toggleLienProjet() {
      const check = document.getElementById('projet-ajout-lien').checked;
      document.getElementById('projet-lien').style.display = check ? "block" : "none";
    }
    function calculateProjet() {
      const nom = document.getElementById('projet-nom').value.trim();
      const prix = parseFloat(document.getElementById('projet-prix').value);
      const duree = parseInt(document.getElementById('projet-duree').value);
      const mode = document.getElementById('projet-mode-inverse').checked ? "Inverse" : "Direct";
      const mensuel = parseFloat(document.getElementById('projet-mensuel').value);
      const priorite = document.getElementById('projet-priorite').value;
      if (nom && !isNaN(prix) && !isNaN(duree)) {
        let calcul = "";
        if (mode === "Direct") {
          const budgetMensuel = prix / duree;
          calcul = "Budget mensuel requis : " + budgetMensuel.toFixed(2) + " €";
        } else {
          if (!isNaN(mensuel) && mensuel > 0) {
            const mois = Math.ceil(prix / mensuel);
            calcul = "Durée estimée : " + mois + " mois";
          } else {
            calcul = "Montant mensuel invalide";
          }
        }
        const lien = document.getElementById('projet-lien').value.trim();
        const projet = {
          nom,
          prix,
          duree,
          lien: lien || null,
          mode,
          calcul,
          priorite,
          suivi: [] // Suivi mensuel (fonctionnalité à étendre)
        };
        projets.push(projet);
        saveProjets();
        renderProjets();
        document.getElementById('form-projet').reset();
        document.getElementById('projet-lien').style.display = "none";
      } else {
        alert("Veuillez remplir correctement les champs du projet.");
      }
    }
    function editProjet(idx) {
      const projet = projets[idx];
      const newNom = prompt("Modifier le nom du projet :", projet.nom);
      if (newNom !== null) { projet.nom = newNom.trim() || projet.nom; }
      const newPrix = prompt("Modifier le budget total (€) :", projet.prix);
      if (newPrix !== null) { projet.prix = parseFloat(newPrix) || projet.prix; }
      const newDuree = prompt("Modifier le délai souhaité (mois) :", projet.duree);
      if (newDuree !== null) { projet.duree = parseInt(newDuree) || projet.duree; }
      const newPriorite = prompt("Modifier la priorité (1 à 5) :", projet.priorite);
      if (newPriorite !== null) { projet.priorite = newPriorite || projet.priorite; }
      saveProjets();
      renderProjets();
    }
    function deleteProjet(idx) {
      if (confirm("Supprimer le projet " + projets[idx].nom + " ?")) {
        projets.splice(idx, 1);
        saveProjets();
        renderProjets();
      }
    }
    function resetProjets() {
      if (confirm("Réinitialiser tous les projets ?")) {
        projets = [];
        saveProjets();
        renderProjets();
      }
    }
    renderProjets();

    /* Module Utilitaires */
    function exportAllData() {
      const allData = { ouvriers, chantiers, revenus, depenses, projets };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
      const dlAnchorElem = document.createElement('a');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "donnees_entreprise.json");
      dlAnchorElem.click();
    }
    function importAllData() {
      document.getElementById('import-file').click();
    }
    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (importedData.ouvriers) { ouvriers = importedData.ouvriers; saveOuvriers(); renderOuvriers(); populateOuvrierSelect(); }
          if (importedData.chantiers) { chantiers = importedData.chantiers; saveChantiers(); renderChantiers(); }
          if (importedData.revenus) { revenus = importedData.revenus; }
          if (importedData.depenses) { depenses = importedData.depenses; }
          if (importedData.projets) { projets = importedData.projets; saveProjets(); renderProjets(); }
          renderFinanceSummary();
          alert("Importation réussie !");
        } catch (error) {
          alert("Erreur lors de l'importation des données.");
        }
      };
      reader.readAsText(file);
    }
    function clearAllData() {
      if (confirm("Tout réinitialiser ? Cette action effacera toutes vos données.")) {
        localStorage.clear();
        location.reload();
      }
    }
    function showHelp() {
      alert("Utilitaires :\n1. Exporter données : Exportez vos données en JSON.\n2. Importer données : Importez un fichier JSON.\n3. Tout réinitialiser : Effacez toutes vos données.\n4. Afficher Synthèse : Affichez le rapport global.\n5. Mode Synthétique : Affichez un résumé rapide.");
    }
    function viewSummary() {
      generateReport();
    }

    /* Module Finance */
    let revenusArr = JSON.parse(localStorage.getItem(STORAGE_REVENUS)) || [];
    let depensesArr = JSON.parse(localStorage.getItem(STORAGE_DEPENSES)) || [];
    function saveFinance() {
      localStorage.setItem(STORAGE_REVENUS, JSON.stringify(revenusArr));
      localStorage.setItem(STORAGE_DEPENSES, JSON.stringify(depensesArr));
    }
    function renderFinanceSummary() {
      const totalRevenus = revenusArr.reduce((sum, r) => sum + r.amount, 0);
      const totalDepensesManuelles = depensesArr.reduce((sum, d) => sum + d.amount, 0);
      const autoOuvriers = ouvriers.filter(o => !o.paye).reduce((sum, o) => sum + (o.tarif * o.jours), 0);
      const autoMateriel = chantiers.reduce((sum, c) => sum + (c.matPayee ? 0 : c.materiel), 0);
      const totalDepenses = totalDepensesManuelles + autoOuvriers + autoMateriel;
      const net = totalRevenus - totalDepenses;
      document.getElementById('manual-revenus').innerText = "Revenus manuels : " + totalRevenus.toFixed(2) + " €";
      document.getElementById('manual-depenses').innerText = "Dépenses manuelles : " + totalDepensesManuelles.toFixed(2) + " €";
      document.getElementById('auto-ouvriers').innerText = "Dépenses ouvriers (non payés) : " + autoOuvriers.toFixed(2) + " €";
      document.getElementById('auto-materiel').innerText = "Dépenses matériaux (non payés) : " + autoMateriel.toFixed(2) + " €";
      document.getElementById('global-balance').innerText = "Solde global : " + net.toFixed(2) + " €";
    }
    document.getElementById('form-revenu').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('revenu-description').value.trim();
      const amount = parseFloat(document.getElementById('revenu-montant').value);
      if (description && !isNaN(amount)) {
        revenusArr.push({ description, amount });
        saveFinance();
        renderFinanceSummary();
        this.reset();
      }
    });
    document.getElementById('form-depense').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('depense-description').value.trim();
      const amount = parseFloat(document.getElementById('depense-montant').value);
      if (description && !isNaN(amount)) {
        depensesArr.push({ description, amount });
        saveFinance();
        renderFinanceSummary();
        this.reset();
      }
    });
    renderFinanceSummary();

    /* Service Worker */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => console.log('Service Worker enregistré:', registration))
        .catch(error => console.error('Erreur Service Worker:', error));
    }
    
    // Fonction de génération de rapport synthétique (affichage dans modal)
    function generateReport() {
      let reportHTML = "<h3>Rapport Global</h3>";
      reportHTML += "<h4>Ouvriers</h4><ul>";
      ouvriers.forEach(o => {
        reportHTML += `<li>${o.nom} - Tarif: ${o.tarif} €, Jours: ${o.jours}, Total: ${(o.tarif * o.jours).toFixed(2)} €, Paiement: ${o.paye ? "Payé" : "Non payé"}</li>`;
      });
      reportHTML += "</ul><h4>Chantiers</h4><ul>";
      chantiers.forEach(c => {
        reportHTML += `<li>${c.nom} - Durée: ${c.duree} j, Prix: ${c.prix} €, Matériaux: ${c.materiel} €, Avancement: ${c.progress.toFixed(0)} %, Ouvriers: ${c.workerIds.join(", ") || "Aucun"}</li>`;
      });
      reportHTML += "</ul><h4>Projets</h4><ul>";
      projets.forEach(p => {
        reportHTML += `<li>${p.nom} - Budget: ${p.prix} €, Délai: ${p.duree} mois, Mode: ${p.mode}, Calcul: ${p.calcul}, Priorité: ${p.priorite}</li>`;
      });
      reportHTML += "</ul><h4>Finance</h4>";
      reportHTML += `<p>${document.getElementById('manual-revenus').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('manual-depenses').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('auto-ouvriers').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('auto-materiel').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('global-balance').innerText}</p>`;
      document.getElementById('report-data').innerHTML = reportHTML;
      document.getElementById('report-modal').style.display = "flex";
    }
    function closeReport() {
      document.getElementById('report-modal').style.display = "none";
    }
    function printReport() {
      const printContent = document.getElementById('report-data').innerHTML;
      const originalContent = document.body.innerHTML;
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      location.reload();
    }
    function downloadReportCSV() {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Type,Description,Montant\n";
      revenusArr.forEach(r => { csvContent += `Revenu,${r.description},${r.amount}\n`; });
      depensesArr.forEach(d => { csvContent += `Dépense,${d.description},${d.amount}\n`; });
      ouvriers.forEach(o => {
        const total = o.tarif * o.jours;
        csvContent += `Ouvrier,${o.nom} - Tarif: ${o.tarif},Total: ${total.toFixed(2)}\n`;
      });
      chantiers.forEach(c => {
        csvContent += `Chantier,${c.nom} - Durée: ${c.duree} j,${c.prix}\n`;
      });
      projets.forEach(p => {
        csvContent += `Projet,${p.nom} - Budget: ${p.prix},Délai: ${p.duree} mois\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "rapport_global.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>

