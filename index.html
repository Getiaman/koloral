<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Koloral Sheqiri ‚Äì Gestion d'Entreprise (Version Finale)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root {
      --bg-color: #ffffff;
      --main-bg: #f9f9f9;
      --primary-color: #0071e3;
      --accent-color: #ff2d55;
      --text-color: #1d1d1f;
      --subtext-color: #6e6e73;
      --border-color: #e5e5ea;
      --radius: 8px;
      --transition: 0.2s ease;
      --header-height: 60px;
      --dropdown-height: 50px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--main-bg);
      color: var(--text-color);
      font-family: sans-serif;
      font-size: 15px;
      line-height: 1.5;
      overflow-x: hidden;
    }
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: var(--bg-color);
      height: var(--header-height);
      padding: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      z-index: 1200;
    }
    header h1 { font-size: 1.6rem; color: var(--primary-color); }
    #nav-dropdown {
      position: fixed;
      top: var(--header-height);
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 360px;
      padding: 0.6rem 0.8rem;
      font-size: 0.95rem;
      border: 1px solid var(--primary-color);
      border-radius: var(--radius);
      background: var(--bg-color);
      color: var(--primary-color);
      z-index: 1150;
      outline: none;
      appearance: none;
    }
    #main-content {
      margin: 0 auto;
      max-width: 1200px;
      padding-top: calc(var(--header-height) + var(--dropdown-height) + 20px);
      padding-bottom: 3rem;
    }
    .section {
      background: var(--bg-color);
      border-radius: var(--radius);
      margin: 1rem auto;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      padding: 1rem;
      display: none;
    }
    .section.active { display: block; }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .section-header h2 { font-size: 1.3rem; }
    .toggle-section-btn {
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
      transition: background var(--transition);
    }
    .toggle-section-btn:hover { background: var(--accent-color); }
    #refresh-btn,
    .quick-menu {
      position: fixed;
      background: var(--bg-color);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      transition: background var(--transition);
      z-index: 1300;
      font-size: 0.9rem;
    }
    #refresh-btn { top: 0.8rem; left: 0.8rem; }
    .quick-menu { top: 0.8rem; right: 0.8rem; }
    #refresh-btn:hover, .quick-menu:hover {
      background: var(--primary-color);
      color: var(--bg-color);
    }
    .quick-menu-container {
      position: fixed;
      top: 100px;
      right: 0.8rem;
      background: var(--bg-color);
      border: 1px solid var(--primary-color);
      border-radius: var(--radius);
      display: none;
      width: 180px;
      z-index: 1400;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    form input, form select, form button {
      width: 100%;
      padding: 0.65rem;
      margin: 0.65rem 0;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background: var(--main-bg);
      color: var(--text-color);
      transition: border-color var(--transition);
    }
    form input:focus, form select:focus {
      border-color: var(--primary-color);
      outline: none;
    }
    form button {
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      cursor: pointer;
      transition: background var(--transition);
      font-weight: 500;
      margin-top: 0.5rem;
    }
    form button:hover { background: var(--accent-color); }
    .table-container { overflow-x: auto; margin: 0.8rem 0; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    table, th, td { border: 1px solid var(--border-color); }
    th, td { padding: 0.65rem; text-align: left; }
    th { background: var(--primary-color); color: var(--bg-color); white-space: nowrap; }
    .action-btn {
      padding: 0.35rem 0.6rem;
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      border-radius: var(--radius);
      font-size: 0.85rem;
      cursor: pointer;
      margin-right: 0.4rem;
      transition: background var(--transition);
    }
    .action-btn:hover { background: var(--accent-color); }
    .voir-plus-btn {
      display: block;
      width: fit-content;
      margin: 0.8rem auto;
      padding: 0.45rem 0.8rem;
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background var(--transition);
      font-size: 0.9rem;
    }
    .voir-plus-btn:hover { background: var(--accent-color); }
    /* Cartes bancaires en flip 3D */
    .accounts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      justify-content: center;
      align-items: start;
      margin-bottom: 1rem;
    }
    .account-card {
      width: 180px;
      height: 110px;
      perspective: 1000px;
      cursor: pointer;
      border-radius: var(--radius);
      position: relative;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
      border-radius: inherit;
    }
    .account-card.flip .card-inner { transform: rotateY(180deg); }
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: inherit;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      backface-visibility: hidden;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 8px;
    }
    .card-back { transform: rotateY(180deg); }
    .principal .card-front, .principal .card-back {
      background: linear-gradient(135deg, #0071e3, #0353a4);
      color: #fff;
    }
    .secondaire .card-front, .secondaire .card-back {
      background: #fff;
      color: #0071e3;
      border: 2px solid #0071e3;
    }
    .card-front .account-name { font-size: 1.0rem; font-weight: bold; margin-bottom: 5px; }
    .card-front .balance { font-size: 0.9rem; font-weight: 600; }
    .card-front .type-label { font-size: 0.75rem; opacity: 0.9; margin-top: 3px; }
    .card-back button { display: inline-block; padding: 5px 8px; margin: 5px; font-size: 0.8rem; cursor: pointer; }
    footer {
      background: var(--bg-color);
      color: var(--subtext-color);
      text-align: center;
      padding: 0.8rem;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      border-top: 1px solid var(--border-color);
      font-size: 0.85rem;
      z-index: 1200;
    }
    .option-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1600;
    }
    .option-content {
      background: var(--bg-color);
      border-radius: var(--radius);
      padding: 1.2rem;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      text-align: center;
    }
    .close-btn {
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      color: var(--primary-color);
    }
    .options-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 0.8rem;
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }
    .options-list li {
      background: var(--primary-color);
      color: var(--bg-color);
      padding: 0.8rem;
      border-radius: var(--radius);
      text-align: center;
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background var(--transition);
    }
    .options-list li:hover { background: var(--accent-color); }
    .option-icon { font-size: 1.5rem; margin-bottom: 0.4rem; }
    .report-modal,
    .steps-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }
    .report-content,
    .steps-content {
      background: var(--bg-color);
      border-radius: var(--radius);
      padding: 1.2rem;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      color: var(--text-color);
      position: relative;
    }
    .modal-buttons {
      margin-top: 1rem;
      display: flex;
      justify-content: space-around;
    }
    .modal-buttons button { 
      background: var(--primary-color);
      color: var(--bg-color);
      border: none;
      cursor: pointer;
      transition: background var(--transition);
      font-weight: 500;
      margin-top: 0.5rem;
    }
    .modal-buttons button:hover { background: var(--accent-color); }
    .spacer { height: 60px; }
    #backups-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      padding: 5px;
    }
    #predicted-fortune {
      margin: 1rem 0;
      padding: 0.5rem;
      background: #eaf7ff;
      border: 1px solid #b3e5ff;
      border-radius: var(--radius);
      text-align: center;
      font-weight: 500;
    }
    .collapsible-header {
      margin-top: 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--primary-color);
    }
    .collapsible-content {
      display: none;
      margin-top: 10px;
    }
    /* Pagination ‚Äì boutons centr√©s et 3x plus petits */
    .pagination {
      text-align: center;
      margin: 10px auto;
    }
    .pagination button {
      border: none;
      background: #f2f2f2;
      color: #0071e3;
      border-radius: 9999px;
      padding: 0.1rem 0.3rem;
      margin: 0 2px;
      cursor: pointer;
      transition: background var(--transition);
      font-size: 0.7rem;
    }
    .pagination button:hover { background: #ddd; }
    .pagination button.active { background: #0071e3; color: #fff; }
    .pagination .arrow { font-weight: normal; }
    /* Pour √©viter le d√©bordement du tableau Projet sur mobile */
    #details-projet { overflow-x: auto; }
  </style>
</head>
<body>
  <div id="refresh-btn" onclick="refreshAll()">Rafra√Æchir</div>
  <header>
    <h1>Koloral Sheqiri</h1>
    <div class="quick-menu" onclick="toggleQuickMenu()">‚Ç¨ Finance</div>
    <div class="quick-menu-container" id="quick-menu"></div>
  </header>
  <select id="nav-dropdown" onchange="showSection(this.value)">
    <option value="comptebancaire">Compte Bancaire</option>
    <option value="finance">Finance</option>
    <option value="ouvriers">Ouvriers</option>
    <option value="baseouvriers">Base Ouvriers</option>
    <option value="chantier">Chantiers</option>
    <option value="basechantier">Base Chantiers</option>
    <option value="collaboration">Collaboration</option>
    <option value="projet">Projet</option>
    <option value="plusoptions">Options Suppl√©mentaires</option>
    <option value="utilitaires">Utilitaires</option>
  </select>
  <div id="main-content">
    <!-- SECTION COMPTE BANCAIRE -->
    <section class="section active" id="comptebancaire">
      <div class="section-header">
        <h2>Compte Bancaire</h2>
        <button class="toggle-section-btn" onclick="toggleSection('comptebancaire')">Masquer</button>
      </div>
      <p>G√©rez vos comptes. Vous pouvez cr√©er de nouveaux comptes, faire des virements ou des d√©penses.</p>
      
    
    
    <div class="accounts-container" id="accounts-grid"></div>
    
    <!-- Formulaire de cr√©ation de compte bancaire -->
    <p>Cr√©er un nouveau compte bancaire (principal ou secondaire) :</p>
    <form id="form-new-account">
      <input id="new-account-name" placeholder="Nom du compte" required type="text"/>
      <select id="new-account-type">
        <option value="principal">Principal</option>
        <option value="secondaire">Secondaire</option>
      </select>
      <button type="submit">Cr√©er ce compte</button>
    </form>
     <!-- Les cartes bancaires -->
    
    <button id="adjust-finance-btn" onclick="openAdjustModal()" 
    style="display:block; margin: 10px auto; padding:10px; background:#0071e3; color:#fff; 
    border:none; border-radius:5px; cursor:pointer; font-size: 16px; width: 200px;">
    Ajuster</button>
    
    <div id="bank-notification-container" style="text-align: center; margin-top: 15px;">
    
      <span id="bank-notification-icon" style="cursor: pointer; font-size: 28px; color: #0071e3; display: block;">‚ùì</span>
      
    <div id="bank-notification" style="display: none;
     background: #ffcc00; padding: 10px; border-radius: 5px; color: #333; width: 80%; margin: auto; text-align: center;">
    
      <span id="bank-notification-icon" style="cursor: pointer; font-size: 24px; color: #0071e3;">‚ùì</span>
      
    <div id="bank-notification" style="display: none;
     position: absolute; top: 30px; left: 0; background: #ffcc00; padding: 10px; border-radius: 5px; color: #333; width: 250px;">
     style="display:none; text-align:center; padding:10px; margin-top:10px; border-radius:5px; background:#ffcc00; color:#333; margin-bottom:10px;"></div>
      <button id="adjust-finance-btn" onclick="openAdjustModal()" style="display:none; padding:8px; margin-bottom:10px; background:#0071e3; color:#fff; border:none; border-radius:5px; cursor:pointer;">Ajuster</button>
      
    <div class="accounts-container" id="accounts-grid"></div>
    
    <!-- Formulaire de cr√©ation de compte bancaire -->
    <p>Cr√©er un nouveau compte bancaire (principal ou secondaire) :</p>
    <form id="form-new-account">
      <input id="new-account-name" placeholder="Nom du compte" required type="text"/>
      <select id="new-account-type">
        <option value="principal">Principal</option>
        <option value="secondaire">Secondaire</option>
      </select>
      <button type="submit">Cr√©er ce compte</button>
    </form>
    
      <p>Cr√©er un nouveau compte bancaire (principal ou secondaire) :</p>
      <form id="form-new-account">
        <input id="new-account-name" placeholder="Nom du compte" required type="text"/>
        <select id="new-account-type">
          <option value="principal">Principal</option>
          <option value="secondaire">Secondaire</option>
        </select>
        <button type="submit">Cr√©er ce compte</button>
      </form>
      <button style="margin-top:10px; padding:10px; background:#ff3b30; color:#fff; border:none; border-radius:5px; cursor:pointer; width:100%;" onclick="deleteBankAccount()">Supprimer un compte</button>
    
</section>

    <!-- SECTION FINANCE -->
    <section class="section" id="finance">
      <div class="section-header">
        <h2>Finance</h2>
        <button class="toggle-section-btn" onclick="toggleSection('finance')">Masquer</button>
      </div>
      <div>
        <h3>Revenus Manuels</h3>
        <form id="form-revenu">
          <input id="revenu-description" placeholder="Description du revenu" required type="text"/>
          <input id="revenu-montant" placeholder="Montant (‚Ç¨)" required step="0.01" type="number"/>
          <label><input id="revenu-chantier" type="checkbox"/> Revenu li√© au chantier</label>
          <button type="submit">Ajouter revenu</button>
        </form>
        <div id="revenus-list"></div>
        <h3>Revenus en Attente</h3>
        <form id="form-revenu-attente">
          <input id="revenu-attente-description" placeholder="Description du revenu en attente" required type="text"/>
          <input id="revenu-attente-montant" placeholder="Montant (‚Ç¨)" required step="0.01" type="number"/>
          <button type="submit">Ajouter revenu en attente</button>
        </form>
        <div id="revenus-attente-list"></div>
        <button class="voir-plus-btn" onclick="convertCheckedRevenusAttenteToManuelles()">Convertir revenus en attente coch√©s en manuels</button>
        <h3>D√©penses Manuelles</h3>
        <form id="form-depense">
          <input id="depense-description" placeholder="Description de la d√©pense" required type="text"/>
          <input id="depense-montant" placeholder="Montant (‚Ç¨)" required step="0.01" type="number"/>
          <button type="submit">Ajouter d√©pense</button>
        </form>
        <div id="depenses-list"></div>
        <h3>D√©penses Pr√©vues</h3>
        <form id="form-depense-prevue">
          <input id="depense-prevue-description" placeholder="Description" required type="text"/>
          <input id="depense-prevue-montant" placeholder="Montant pr√©vu (‚Ç¨)" required step="0.01" type="number"/>
          <button type="submit">Ajouter d√©pense pr√©vue</button>
        </form>
        <div id="depenses-prevues-list"></div>
        <button class="voir-plus-btn" onclick="convertCheckedDepensesPrevuesToManuelles()">Convertir d√©penses coch√©es en manuelles</button>
        <div id="predicted-fortune"></div>
        <div id="finance-summary"></div>
        <div id="finance-options">
          <label><input id="appliquer-urssaf" onchange="renderFinanceSummary()" type="checkbox"/> Appliquer -22% Urssaf sur revenus chantier</label>
        </div>
      </div>
    </section>

    <!-- SECTION OUVRIERS -->
    <section class="section" id="ouvriers">
      <div class="section-header">
        <h2>Ouvriers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('ouvriers')">Masquer</button>
      </div>
      <div>
        <form id="form-ouvrier">
          <select id="ouvrier-nom-dropdown" onchange="selectOuvrier()">
            <option value="">-- S√©lectionner un ouvrier --</option>
          </select>
          <input id="ouvrier-nom" placeholder="Nom de l'ouvrier" required type="text"/>
          <input id="ouvrier-tarif" placeholder="Prix √† la journ√©e (‚Ç¨)" required step="0.01" type="number"/>
          <input id="ouvrier-jours" placeholder="Temps de travail (en jours)" required step="0.1" type="number"/>
          <button type="submit">Enregistrer / Mettre √† jour</button>
        </form>
        <div class="table-container">
          <table id="table-ouvriers">
            <thead>
              <tr>
                <th>Pay√©</th>
                <th>Nom</th>
                <th>Prix/jour</th>
                <th>Jours</th>
                <th>Total Gain</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ouvriers-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECTION BASE OUVRIERS -->
    <section class="section" id="baseouvriers">
      <div class="section-header">
        <h2>Base Ouvriers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('baseouvriers')">Masquer</button>
      </div>
      <div>
        <div id="baseouvriers-unpaid"></div>
        <div id="baseouvriers-paid"></div>
      </div>
    </section>

    <!-- SECTION CHANTIER -->
    <section class="section" id="chantier">
      <div class="section-header">
        <h2>Chantiers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('chantier')">Masquer</button>
      </div>
      <div>
        <form id="form-chantier">
          <input id="chantier-nom" placeholder="Nom du chantier" required type="text"/>
          <input id="chantier-duree" placeholder="Dur√©e (jours)" required step="1" type="number"/>
          <input id="chantier-prix" placeholder="Prix du chantier (‚Ç¨)" required step="0.01" type="number"/>
          <input id="chantier-materiel" placeholder="Co√ªt des mat√©riaux (‚Ç¨)" required step="0.01" type="number"/>
          <label><input id="chantier-mat-payee" type="checkbox"/> Mat√©riaux pay√©s</label>
          <div id="etapes-container"></div>
          <input id="etape-input" placeholder="Description de l'√©tape" type="text"/>
          <button id="btnAddEtape" type="button" onclick="if(document.getElementById('etape-input').value.trim()!==''){ currentEtapes.unshift(document.getElementById('etape-input').value.trim()); document.getElementById('etape-input').value=''; renderEtapesList(); }">Ajouter √©tape</button>
          <button type="submit">Enregistrer chantier</button>
        </form>
        <div class="table-container">
          <table id="table-chantier">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Dur√©e</th>
                <th>Prix</th>
                <th>Mat√©riaux</th>
                <th>Avancement</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="chantier-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECTION BASE CHANTIER -->
    <section class="section" id="basechantier">
      <div class="section-header">
        <h2>Base Chantiers</h2>
        <button class="toggle-section-btn" onclick="toggleSection('basechantier')">Masquer</button>
      </div>
      <div>
        <h3>Chantiers Actifs</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th>Dur√©e</th>
                <th>Prix</th>
                <th>Avancement</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="basechantier-actif-tbody"></tbody>
          </table>
        </div>
        <h3>Travaux Termin√©s</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th>Dur√©e</th>
                <th>Prix</th>
              </tr>
            </thead>
            <tbody id="basechantier-fini-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECTION COLLABORATION -->
    <section class="section" id="collaboration">
      <div class="section-header">
        <h2>Collaboration</h2>
        <button class="toggle-section-btn" onclick="toggleSection('collaboration')">Masquer</button>
      </div>
      <div>
        <form id="form-collaboration">
          <label for="collab-chantier">S√©lectionnez un chantier :</label>
          <!-- Seuls les chantiers en cours (avance < 100) sont propos√©s -->
          <select id="collab-chantier" required></select>
          <label for="collab-moi">Mes jours travaill√©s :</label>
          <input id="collab-moi" placeholder="Nombre de jours" required step="0.1" type="number"/>
          <div id="collab-list"></div>
          <button id="btnAddCollaborateur" type="button" onclick="CollaborationModule.addCollaboratorRow()">Ajouter collaborateur</button>
          <button id="btnCalcCollab" type="button" onclick="CollaborationModule.calculate()">Calculer r√©partition</button>
        </form>
        <div class="table-container" style="margin-top:20px;">
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th>Jours</th>
                <th>Part (‚Ç¨)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="collab-result-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECTION PROJET -->
    <section class="section" id="projet">
      <div class="section-header">
        <h2>Projet</h2>
        <button class="toggle-section-btn" onclick="toggleSection('projet')">Masquer</button>
      </div>
      <div>
        <form id="form-projet">
          <input id="projet-nom" placeholder="Nom du projet" required type="text"/>
          <input id="projet-prix" placeholder="Budget total (‚Ç¨)" required step="0.01" type="number"/>
          <label><input id="projet-ajout-lien" type="checkbox"/> Ajouter un lien</label>
          <input id="projet-lien" placeholder="URL du projet" style="display:none;" type="url"/>
          <input id="projet-duree" placeholder="Dur√©e souhait√©e (mois)" required step="1" type="number"/>
          <label><input id="projet-mode-inverse" type="checkbox"/> Mode Inverse (budget mensuel)</label>
          <input id="projet-mensuel" placeholder="Budget mensuel (‚Ç¨)" step="0.01" type="number"/>
          <input id="projet-mois-objectif" placeholder="Mois jusqu'√† l'objectif" step="1" type="number"/>
          <select id="projet-priorite">
            <option value="1">Priorit√© 1 (Haute)</option>
            <option value="2">Priorit√© 2</option>
            <option value="3">Priorit√© 3 (Normale)</option>
            <option value="4">Priorit√© 4</option>
            <option value="5">Priorit√© 5 (Basse)</option>
          </select>
          <button id="btnCalculateProjet" type="button" onclick="calculateProjet()">Calculer Projet</button>
          <button type="submit">Enregistrer Projet</button>
        </form>
        <div id="details-projet" style="overflow-x:auto;"></div>
        <!-- Bouton r√©cap de progression de tous les projets -->
        <button id="btnShowAllProgress" type="button" onclick="showAllProjectsRecap()">Afficher R√©cap Progression</button>
        <!-- Modale r√©cap pour tous les projets -->
        <div id="project-progress-modal-all" class="option-modal">
          <div class="option-content">
            <span class="close-btn" onclick="closeAllProjectsRecap()">√ó</span>
            <h2>R√©cap de la Progression</h2>
            <div id="all-projects-recap"></div>
            <button onclick="saveProjectProgress()">Sauvegarder progression</button>
          </div>
        </div>
        <!-- Modale pour un projet unique -->
        <div id="project-progress-modal-single" class="option-modal">
          <div class="option-content">
            <span class="close-btn" onclick="closeSingleProjectModal()">√ó</span>
            <h2 id="proj-single-title"></h2>
            <div id="proj-single-container"></div>
            <button onclick="saveSingleProjectProgress()">Sauvegarder progression</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SECTION OPTIONS SUPPL√âMENTAIRES -->
    <section class="section" id="plusoptions">
      <div class="section-header">
        <h2>Options Suppl√©mentaires</h2>
        <button class="toggle-section-btn" onclick="toggleSection('plusoptions')">Masquer</button>
      </div>
      <div>
        <ul class="options-list" id="options-list"></ul>
      </div>
    </section>

    <!-- SECTION UTILITAIRES -->
    

<section class="section" id="utilitaires">
  <div class="section-header">
    <h2>Utilitaires</h2>
    <button class="toggle-section-btn" onclick="toggleSection('utilitaires')">Masquer</button>
  </div>
  <div class="utilities-container">
<div class="utility-card" id="bank-management">
    <h3>Gestion des Comptes Bancaires</h3>
    <button class="ios-button reset-btn" onclick="resetAllBankAccounts()">üîÑ R√©initialiser toutes les cartes</button>
    <button class="ios-button reset-btn" onclick="resetSpecificBankAccount()">üîÑ R√©initialiser une carte pr√©cise</button>
    <button class="ios-button reset-btn" onclick="resetBankingSection()">üîÑ R√©initialiser toute la section</button>
    <button class="ios-button reset-btn" onclick="deleteSpecificBankAccount()">üóëÔ∏è Supprimer une carte</button>
</div>

    
    <div class="utility-card">
      <h3>Gestion des donn√©es</h3>
      <button class="ios-button export-btn" onclick="exportAllData()">üì§ Exporter les donn√©es</button>
      <button class="ios-button import-btn" onclick="document.getElementById('import-file').click()">üì• Importer des donn√©es</button>
      <input accept="application/json" id="import-file" style="display:none;" type="file" onchange="importAllData(event)"/>
    </div>
    
    <div class="utility-card">
      <h3>Sauvegarde et r√©initialisation</h3>
<div class="utility-card">
    <h3 onclick="toggleBankSettings()" style="cursor:pointer;">‚öôÔ∏è Param√®tres Bancaires ‚ñº</h3>
    <div id="bank-settings" style="display:none;">
        <button class="ios-button reset-btn" onclick="resetAllBankAccounts()">üîÑ R√©initialiser toutes les cartes</button>
        <button class="ios-button reset-btn" onclick="resetSpecificBankAccount()">üîÑ R√©initialiser une carte pr√©cise</button>
        <button class="ios-button reset-btn" onclick="resetBankingSection()">üîÑ R√©initialiser toute la section</button>
        <button class="ios-button reset-btn" onclick="deleteSpecificBankAccount()">üóëÔ∏è Supprimer une carte</button>
    </div>
</div>

<script>
function toggleBankSettings() {
    var settings = document.getElementById("bank-settings");
    settings.style.display = (settings.style.display === "none") ? "block" : "none";
}
</script>

      <button class="ios-button save-btn" onclick="showSaveSectionModal()">üíæ Sauvegarder une section</button>
      <button class="ios-button reset-btn" onclick="showResetSectionModal()">üîÑ R√©initialiser une section</button>
      <button class="ios-button show-backups-btn" onclick="toggleBackupList()">üìÅ Voir les sauvegardes</button>
    </div>

    <div class="utility-card">
      <h3>Planification et historique</h3>
      <button class="ios-button history-btn" onclick="showHistory()">üìú Historique</button>
      <button class="ios-button schedule-btn" onclick="showScheduleBackupModal()">‚è≥ Planifier une sauvegarde</button>
      <button class="ios-button reset-all-btn" onclick="resetAllData()">üõë R√©initialiser tout</button>
    </div>

    <div id="backups-list" class="backup-table-container" style="display:none;"></div>
    
  </div>
</section>

<style>
  .utilities-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    padding: 20px;
  }

  .utility-card {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.3s ease;
  }

  .utility-card:hover {
    transform: scale(1.02);
  }

  .utility-card h3 {
    font-size: 18px;
    margin-bottom: 10px;
    color: #0071e3;
  }

  .ios-button {
    display: block;
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.1s ease;
  }

  .ios-button:hover {
    transform: scale(1.05);
  }

  .export-btn { background: #007aff; color: white; }
  .export-btn:hover { background: #005ecb; }

  .import-btn { background: #34c759; color: white; }
  .import-btn:hover { background: #28a745; }

  .save-btn { background: #ff9500; color: white; }
  .save-btn:hover { background: #cc7a00; }

  .reset-btn { background: #ff3b30; color: white; }
  .reset-btn:hover { background: #c62828; }

  .show-backups-btn { background: #5856d6; color: white; }
  .show-backups-btn:hover { background: #3c3cad; }

  .history-btn { background: #af52de; color: white; }
  .history-btn:hover { background: #8e44ad; }

  .schedule-btn { background: #ffcc00; color: black; }
  .schedule-btn:hover { background: #d4a700; }

  .reset-all-btn { background: #1c1c1e; color: white; }
  .reset-all-btn:hover { background: #000000; }

  .backup-table-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    background: #f9f9f9;
  }
</style>


    <div class="spacer"></div>
  </div>

  <footer>
    <p>¬© 2025 Koloral Sheqiri</p>
  </footer>

  <!-- MODALE DE RAPPORT -->
  <div class="report-modal" id="report-modal">
    <div class="report-content">
      <h2>Rapport Global</h2>
      <div id="report-data"></div>
      <div class="modal-buttons">
        <button id="btnPrintReport" onclick="printReport()">Imprimer Rapport</button>
        <button id="btnCloseReport" onclick="closeReport()">Fermer</button>
      
    </div>
    <button id="adjust-finance-btn" onclick="openAdjustModal()" style="display:block; margin-top:10px; padding:8px; background:#0071e3; color:#fff; border:none; border-radius:5px; cursor:pointer;">Ajuster</button>
    </div>
    
  </div>

  <!-- MODALE √âTAPES (pour les chantiers) -->
  <div class="steps-modal" id="steps-modal">
    <div class="steps-content">
      <h2>Modifier les √âtapes</h2>
      <div id="steps-modal-content"></div>
      <div class="modal-buttons">
        <button id="btnSaveChantierSteps" onclick="(function(){ 
          let p = calculateProgress(window.chantiers[window.currentChantierIndex].completedSteps);
          window.chantiers[window.currentChantierIndex].avance = p; 
          alert('Progression sauvegard√©e : ' + p + ' %'); 
          closeStepsModal(); 
          renderChantiers(); 
          renderBaseChantiers(); 
        })()">Sauvegarder</button>
        <button id="btnCloseStepsModal" onclick="closeStepsModal()">Annuler</button>
      
    </div>
    <button id="adjust-finance-btn" onclick="openAdjustModal()" style="display:block; margin-top:10px; padding:8px; background:#0071e3; color:#fff; border:none; border-radius:5px; cursor:pointer;">Ajuster</button>
    </div>
    
  </div>

  <!-- MODALE OPTIONS -->
  <div class="option-modal" id="option-modal">
    <div class="option-content">
      <span class="close-btn" id="option-close-btn" onclick="document.getElementById('option-modal').style.display='none'">√ó</span>
      <h2 id="option-modal-title"></h2>
      <div id="option-modal-body">
    </div>
    <button id="adjust-finance-btn" onclick="openAdjustModal()" style="display:block; margin-top:10px; padding:8px; background:#0071e3; color:#fff; border:none; border-radius:5px; cursor:pointer;">Ajuster</button>
    </div>
    
  </div>

  <div class="spacer"></div>

  <!-- MODALE AJUSTEMENT BALANCE -->
  <div id="adjustment-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:1500;">
    <div class="adjustment-content" style="background:#fff; padding:20px; border-radius:10px; text-align:center; width:90%; max-width:400px;">
      <h2>Ajuster la Balance</h2>
      <p id="adjust-amount-display">Diff√©rence √† ajuster : 0.00 ‚Ç¨</p>
      <select id="adjust-account"></select>
      <input id="adjust-value" placeholder="Montant √† ajuster" step="0.01" type="number" style="width:100%; padding:10px; margin-top:10px; border:1px solid #ddd; border-radius:5px;"/>
      <div class="adjustment-buttons" style="display:flex; justify-content:space-around; margin-top:15px;">
        <button class="save-btn" onclick="applyAdjustment()" style="padding:10px 15px; background:#0071e3; color:#fff; border:none; border-radius:5px; cursor:pointer;">Sauvegarder</button>
        <button class="cancel-btn" onclick="closeAdjustModal()" style="padding:10px 15px; background:#ccc; border:none; border-radius:5px; cursor:pointer;">Annuler</button>
      
    </div>
    <button id="adjust-finance-btn" onclick="openAdjustModal()" style="display:block; margin-top:10px; padding:8px; background:#0071e3; color:#fff; border:none; border-radius:5px; cursor:pointer;">Ajuster</button>
    </div>
    
  </div>

  <script>
    /* ------------------------------
       Pagination G√©n√©rique (5 r√©sultats par page)
       Boutons centr√©s et 3x plus petits
    ------------------------------ */
    function applyPaginationToTable(tbodyId) {
      let tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      let rows = Array.from(tbody.querySelectorAll("tr"));
      let rowsPerPage = 5;
      let totalPages = Math.ceil(rows.length / rowsPerPage);
      
      // Supprimer le conteneur de pagination existant (s'il existe)
      let existing = document.getElementById(tbodyId + "-pagination");
      if(existing) existing.remove();
      
      let paginationDiv = document.createElement("div");
      paginationDiv.id = tbodyId + "-pagination";
      paginationDiv.className = "pagination";
      
      let currentPage = 1;
      function showPage(page) {
        currentPage = page;
        rows.forEach((row, index) => {
          row.style.display = (index >= (page-1)*rowsPerPage && index < page*rowsPerPage) ? "" : "none";
        });
        Array.from(paginationDiv.querySelectorAll("button.page-btn")).forEach((btn, idx) => {
          btn.classList.remove("active");
          if ((idx+1) === currentPage) btn.classList.add("active");
        });
        prevBtn.disabled = (currentPage === 1);
        nextBtn.disabled = (currentPage === totalPages);
      }
      
      let prevBtn = document.createElement("button");
      prevBtn.innerHTML = "‚Üê";
      prevBtn.className = "arrow";
      prevBtn.onclick = function() { if (currentPage > 1) showPage(currentPage - 1); };
      paginationDiv.appendChild(prevBtn);
      
      for (let i = 1; i <= totalPages; i++) {
        let btn = document.createElement("button");
        btn.innerHTML = i;
        btn.className = "page-btn";
        btn.onclick = function() { showPage(i); };
        paginationDiv.appendChild(btn);
      }
      
      let nextBtn = document.createElement("button");
      nextBtn.innerHTML = "‚Üí";
      nextBtn.className = "arrow";
      nextBtn.onclick = function() { if (currentPage < totalPages) showPage(currentPage + 1); };
      paginationDiv.appendChild(nextBtn);
      
      tbody.parentNode.insertBefore(paginationDiv, tbody.nextSibling);
      showPage(1);
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Fonctions de Base & Gestion des Sections
    ------------------------------ */
    function toggleQuickMenu() {
      var qm = document.getElementById("quick-menu");
      qm.style.display = (qm.style.display === "block") ? "none" : "block";
    }
    function showSection(sectionId) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      let target = document.getElementById(sectionId);
      if (target) target.classList.add("active");
    }
    function toggleSection(sectionId) {
      let sec = document.getElementById(sectionId);
      if (sec) sec.classList.toggle("active");
    }
    document.getElementById("quick-menu").innerHTML =
      "<button onclick='ajusterFinance(-20)'>-20 ‚Ç¨</button>" +
      "<button onclick='ajusterFinance(-50)'>-50 ‚Ç¨</button>" +
      "<button onclick='ajusterFinance(-100)'>-100 ‚Ç¨</button>" +
      "<button onclick='ajusterFinance(50)'>+50 ‚Ç¨</button>" +
      "<button onclick='ajusterFinance(100)'>+100 ‚Ç¨</button>";
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Variables Globales
    ------------------------------ */
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
window.bankAccounts = [
      { id: "creditAgricole", name: "Cr√©dit Agricole", balance: 0, type: "principal" },
      { id: "shine", name: "Shine", balance: 0, type: "principal" },
      { id: "liquide", name: "Liquide", balance: 0, type: "principal" },
      { id: "livretA", name: "Livret A", balance: 0, type: "secondaire" },
      { id: "livretLEP", name: "Livret LEP", balance: 0, type: "secondaire" },
      { id: "compteDepot", name: "Compte D√©p√¥t", balance: 0, type: "secondaire" }
    ];
    window.bankNotifications = [];
    window.revenus = [];
    window.depenses = [];
    window.depensesPrevues = [];
    window.revenusAttente = [];
    window.ouvriers = [];
    window.baseOuvriers = [];
    window.chantiers = [];
    window.travauxFinis = [];
    window.projets = [];
    window.achats = [];
    window.groupedAchats = [];
    window.collaborations = {};
    window.oldResultFinal = 0;
    window.currentEtapes = [];
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Gestion des Comptes (Flip 3D)
    ------------------------------ */
    function renderBankAccounts() {
      let container = document.getElementById("accounts-grid");
      if (!container) return;
      container.innerHTML = "";
      window.bankAccounts.forEach(ac => {
        let card = document.createElement("div");
        card.classList.add("account-card");
        card.classList.add(ac.type === "principal" ? "principal" : "secondaire");
        let cardInner = document.createElement("div");
        cardInner.classList.add("card-inner");
        let cardFront = document.createElement("div");
        cardFront.classList.add("card-front");
        let h3 = document.createElement("div");
        h3.className = "account-name";
        h3.textContent = ac.name;
        let bal = document.createElement("div");
        bal.className = "balance";
        bal.textContent = ac.balance.toFixed(2) + " ‚Ç¨";
        let lbl = document.createElement("div");
        lbl.className = "type-label";
        lbl.textContent = (ac.type === "principal") ? "Compte Principal" : "Compte Secondaire";
        cardFront.append(h3, bal, lbl);
        let cardBack = document.createElement("div");
        cardBack.classList.add("card-back");
        // Ajout des boutons "Virement" et "D√©pense" sur le verso
        let btnVirement = document.createElement("button");
        btnVirement.textContent = "Virement";
        btnVirement.style.margin = "5px";
        btnVirement.onclick = function(e) {
          e.stopPropagation();
          handleVirement(ac.id);
        };
        let btnDepense = document.createElement("button");
        btnDepense.textContent = "D√©pense";
        btnDepense.style.margin = "5px";
        btnDepense.onclick = function(e) {
          e.stopPropagation();
          handleDepense(ac.id);
        };
        cardBack.appendChild(btnVirement);
        cardBack.appendChild(btnDepense);
        cardInner.append(cardFront, cardBack);
        card.appendChild(cardInner);
        card.addEventListener("click", () => { card.classList.toggle("flip"); });
        container.appendChild(card);
      });
    }
    function handleVirement(fromId) {
      let amount = parseFloat(prompt("Montant du virement :"));
      if (isNaN(amount) || amount <= 0) return;
      let fromAcc = window.bankAccounts.find(a => a.id === fromId);
      if (!fromAcc) { alert("Compte introuvable."); return; }
      if (fromAcc.balance < amount) { alert("Solde insuffisant."); return; }
      let toId = prompt("ID du compte destinataire :");
      if (!toId || toId === fromId) { alert("Compte destinataire invalide."); return; }
      let toAcc = window.bankAccounts.find(a => a.id === toId);
      if (!toAcc) { alert("Compte destinataire introuvable."); return; }
      fromAcc.balance -= amount;
      toAcc.balance += amount;
      let notif = document.getElementById("bank-notification");
      if(notif) {
        notif.style.display = "block";
        notif.textContent = `Virement de ${amount.toFixed(2)} ‚Ç¨ vers ${toAcc.name}.`;
      }
      renderBankAccounts(); checkFinanceBalance();
    }
    function handleDepense(fromId) {
      let amount = parseFloat(prompt("Montant de la d√©pense :"));
      if (isNaN(amount) || amount <= 0) return;
      let fromAcc = window.bankAccounts.find(a => a.id === fromId);
      if (!fromAcc) { alert("Compte introuvable."); return; }
      if (fromAcc.balance < amount) { alert("Solde insuffisant."); return; }
      fromAcc.balance -= amount;
      let notif = document.getElementById("bank-notification");
      if(notif) {
        notif.style.display = "block";
        notif.textContent = `D√©pense de ${amount.toFixed(2)} ‚Ç¨ sur ${fromAcc.name}.`;
      }
      renderBankAccounts(); checkFinanceBalance();
    }
    function createBankAccount(e) {
      e.preventDefault();
      let name = document.getElementById("new-account-name").value.trim();
      let type = document.getElementById("new-account-type").value;
      if (!name) return;
      let newId = "compte" + Date.now();
      let newAcc = { id: newId, name: name, balance: 0, type: (type === "principal" ? "principal" : "secondaire") };
      window.bankAccounts.push(newAcc);
      e.target.reset();
      alert("Nouveau compte cr√©√© : " + name);
      renderBankAccounts(); checkFinanceBalance();
    }
    function deleteBankAccount() {
      let accountId = prompt("Entrez l'ID du compte √† supprimer :");
      let idx = window.bankAccounts.findIndex(acc => acc.id === accountId);
      if (idx === -1) { alert("Compte introuvable."); return; }
      if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[idx].name + " ?")) {
        window.bankAccounts.splice(idx, 1);
        saveBankAccounts();
        renderBankAccounts(); checkFinanceBalance();
        alert("Compte supprim√© avec succ√®s.");
      }
    }
    function saveBankAccounts() {
      localStorage.setItem("bankAccounts", JSON.stringify(window.bankAccounts));
    }
    function loadBankAccounts() {
      let stored = localStorage.getItem("bankAccounts");
      if (stored) { window.bankAccounts = JSON.parse(stored); }
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Gestion des Revenus & D√©penses
    ------------------------------ */
    function depositRevenueToBank(index) {
      let rev = window.revenus[index];
      if (!rev) return;
      let accId = prompt("ID du compte destinataire :");
      if (!accId) return;
      let acc = window.bankAccounts.find(a => a.id === accId);
      if (!acc) { alert("Compte introuvable."); return; }
      acc.balance += rev.montant;
      let notif = document.getElementById("bank-notification");
      if(notif) {
        notif.style.display = "block";
        notif.textContent = `Vous avez d√©pos√© ${rev.montant.toFixed(2)} ‚Ç¨ sur ${acc.name}.`;
      }
      renderBankAccounts(); checkFinanceBalance();
    }
    function renderRevenusList() {
      let container = document.getElementById("revenus-list");
      if (!container) return;
      if (window.revenus.length === 0) {
        container.innerHTML = "<p>Aucun revenu manuel.</p>";
        return;
      }
      let html = "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Description</th><th>Montant (‚Ç¨)</th><th>Chantier</th><th>Action</th></tr></thead><tbody id='revenus-list-tbody'>";
      window.revenus.forEach((r, i) => {
        html += `<tr>
          <td>${r.description}</td>
          <td style='text-align:right;'>${r.montant.toFixed(2)}</td>
          <td>${r.chantier ? "Oui" : "Non"}</td>
          <td><button onclick='depositRevenueToBank(${i})'>D√©poser</button></td>
        </tr>`;
      });
      html += "</tbody></table>";
      container.innerHTML = html;
      applyPaginationToTable("revenus-list-tbody");
    }
    function renderRevenusAttenteList() {
      let container = document.getElementById("revenus-attente-list");
      if (!container) return;
      if (window.revenusAttente.length === 0) {
        container.innerHTML = "<p>Aucun revenu en attente.</p>";
        return;
      }
      let html = "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Description</th><th>Montant (‚Ç¨)</th><th>Appliqu√©e</th></tr></thead><tbody id='revenus-attente-list-tbody'>";
      window.revenusAttente.forEach((r, i) => {
        if(r.applique === undefined) r.applique = false;
        html += `<tr>
          <td>${r.description}</td>
          <td style='text-align:right;'>${r.montant.toFixed(2)}</td>
          <td style='text-align:center;'><input type='checkbox' onchange='toggleRevenuAttente(${i}, this.checked)' ${r.applique ? "checked" : ""}></td>
        </tr>`;
      });
      html += "</tbody></table>";
      container.innerHTML = html;
      applyPaginationToTable("revenus-attente-list-tbody");
    }
    function toggleRevenuAttente(i, checked) {
      window.revenusAttente[i].applique = checked;
      renderRevenusAttenteList();
      renderFinanceSummary();
    }
    function renderDepensesList() {
      let container = document.getElementById("depenses-list");
      if (!container) return;
      if (window.depenses.length === 0) {
        container.innerHTML = "<p>Aucune d√©pense manuelle.</p>";
        return;
      }
      let html = "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Description</th><th>Montant (‚Ç¨)</th></tr></thead><tbody id='depenses-list-tbody'>";
      window.depenses.forEach(d => {
        html += `<tr>
          <td>${d.description}</td>
          <td style='text-align:right;'>${d.montant.toFixed(2)}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      container.innerHTML = html;
      applyPaginationToTable("depenses-list-tbody");
    }
    function renderDepensesPrevuesList() {
      let container = document.getElementById("depenses-prevues-list");
      if (!container) return;
      if (window.depensesPrevues.length === 0) {
        container.innerHTML = "<p>Aucune d√©pense pr√©vue.</p>";
        return;
      }
      let html = "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Description</th><th>Montant (‚Ç¨)</th><th>Appliqu√©e</th></tr></thead><tbody id='depenses-prevues-list-tbody'>";
      window.depensesPrevues.forEach((dp, i) => {
        if (dp.applique === undefined) dp.applique = false;
        html += `<tr>
          <td>${dp.description}</td>
          <td style='text-align:right;'>${dp.montant.toFixed(2)}</td>
          <td style='text-align:center;'><input type='checkbox' onchange='toggleDepensePrevue(${i}, this.checked)' ${dp.applique ? "checked" : ""}></td>
        </tr>`;
      });
      html += "</tbody></table>";
      container.innerHTML = html;
      applyPaginationToTable("depenses-prevues-list-tbody");
    }
    function toggleDepensePrevue(i, checked) {
      window.depensesPrevues[i].applique = checked;
      renderDepensesPrevuesList();
      renderPredictedFortune();
      renderFinanceSummary();
    }
    function convertCheckedDepensesPrevuesToManuelles() {
      let selected = window.depensesPrevues.filter(d => d.applique);
      if (selected.length === 0) { alert("Aucune d√©pense pr√©vue coch√©e."); return; }
      window.depensesPrevues = window.depensesPrevues.filter(d => !d.applique);
      selected.forEach(d => { window.depenses.unshift({ description: d.description, montant: d.montant }); });
      saveFinance();
      renderDepensesPrevuesList();
      renderDepensesList();
      renderPredictedFortune();
      renderFinanceSummary();
      alert("Conversion effectu√©e.");
    }
    function convertCheckedRevenusAttenteToManuelles() {
      let selected = window.revenusAttente.filter(r => r.applique);
      if (selected.length === 0) { alert("Aucun revenu en attente coch√©."); return; }
      window.revenusAttente = window.revenusAttente.filter(r => !r.applique);
      selected.forEach(r => { window.revenus.unshift({ description: r.description, montant: r.montant, chantier: false }); });
      saveFinance();
      renderRevenusAttenteList();
      renderRevenusList();
      renderFinanceSummary();
      alert("Conversion effectu√©e.");
    }
    function renderPredictedFortune() {
      let container = document.getElementById("predicted-fortune");
      if (!container) return;
      let totalPrev = window.depensesPrevues.reduce((s, d) => s + parseFloat(d.montant), 0);
      let revTotal = window.revenus.reduce((s, r) => s + r.montant, 0) + window.revenusAttente.reduce((s, r) => s + r.montant, 0);
      let depTotal = window.depenses.reduce((s, d) => s + d.montant, 0);
      let gains = window.ouvriers.reduce((s, o) => s + (o.paye ? o.tarif * o.jours : 0), 0);
      let predicted = revTotal - (depTotal + totalPrev + gains);
      container.innerHTML = "<strong>Fortune pr√©visionnelle : " + predicted.toFixed(2) + " ‚Ç¨</strong>";
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Finance Summary & Notification ¬±100‚Ç¨
    ------------------------------ */
    function renderFinanceSummary() {
      let appliquerUrssaf = document.getElementById("appliquer-urssaf").checked;
      let revNonChantier = window.revenus.filter(r => !r.chantier).reduce((s, r) => s + r.montant, 0);
      let revChantierBrut = window.revenus.filter(r => r.chantier).reduce((s, r) => s + r.montant, 0);
      let urssaf = revChantierBrut * 0.22;
      let revChantierNet = appliquerUrssaf ? (revChantierBrut * 0.78) : revChantierBrut;
      let zaqat = revChantierBrut * 0.025;
      let revenuSousTraitant = revChantierBrut - (urssaf + zaqat);
      let revAttente = window.revenusAttente.reduce((s, r) => s + r.montant, 0);
      let totalRevenusAvecAttente = revNonChantier + revChantierNet + revAttente;
      let depManuelles = window.depenses.reduce((s, d) => s + d.montant, 0);
      let depPrevues = window.depensesPrevues.filter(d => d.applique).reduce((s, d) => s + d.montant, 0);
      let resultatFinal = (revNonChantier + revChantierNet) - depManuelles;
      let rows = [];
      rows.push("<tr><td>Revenus non‚Äëchantier</td><td style='text-align:right;'>" + revNonChantier.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr><td>Revenus chantier (bruts)</td><td style='text-align:right;'>" + revChantierBrut.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr><td>Total d√ª √† l‚ÄôUrssaf (22%)</td><td style='text-align:right;'>" + urssaf.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr><td>Zaqat (2,5%)</td><td style='text-align:right;'>" + zaqat.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr><td>Revenu en sous‚Äëtraitance</td><td style='text-align:right;'>" + revenuSousTraitant.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr><td>Total Revenus (avec revenus en attente)</td><td style='text-align:right;'>" + totalRevenusAvecAttente.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr><td>D√©penses manuelles</td><td style='text-align:right;'>" + depManuelles.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr><td>D√©penses pr√©vues appliqu√©es</td><td style='text-align:right;'>" + depPrevues.toFixed(2) + " ‚Ç¨</td></tr>");
      rows.push("<tr style='font-weight:bold;'><td>R√©sultat final</td><td style='text-align:right;'>" + resultatFinal.toFixed(2) + " ‚Ç¨</td></tr>");
      let finalRow = rows.pop();
      let extraRows = rows.join("");
      let html = "<h3>R√©sum√© Financier</h3><table style='width:100%; border-collapse:collapse;'>";
      html += "<tbody id='finance-summary-tbody-extra' style='display:none;'>" + extraRows + "</tbody>";
      html += "<tbody id='finance-summary-tbody-final'>" + finalRow + "</tbody>";
      html += "</table>";
      html += "<button id='toggle-finance-summary' onclick='toggleFinanceSummary()'>Afficher d√©tails ‚Üì</button>";
      document.getElementById("finance-summary").innerHTML = html;
      
      // Notification si une diff√©rence existe
      let diff = resultatFinal - window.oldResultFinal;
      let notif = document.getElementById("bank-notification");
      if (diff !== 0) {
        notif.style.display = "block";
        if (diff > 0) {
          notif.innerHTML = `Le r√©sultat final a augment√© de +${diff.toFixed(2)} ‚Ç¨.`;
        } else {
          notif.innerHTML = `Le r√©sultat final a diminu√© de ${diff.toFixed(2)} ‚Ç¨.`;
        }
        // Bouton "Ajuster"
        let btn = document.createElement("button");
        btn.textContent = "Ajuster";
        btn.style.marginLeft = "10px";
        btn.style.fontSize = "0.8rem";
        btn.onclick = function() { openAdjustFromNotification(diff); };
        notif.appendChild(btn);
        // Bouton "0‚Ç¨" pour r√©initialiser la diff√©rence
        let btnReset = document.createElement("button");
        btnReset.textContent = "0‚Ç¨";
        btnReset.style.marginLeft = "10px";
        btnReset.style.fontSize = "0.8rem";
        btnReset.onclick = function() {
            window.oldResultFinal = resultatFinal;
            notif.innerHTML = "";
            notif.style.display = "none";
        };
        notif.appendChild(btnReset);
        // Bouton "Recalculer" pour recalculer la diff√©rence
        let btnRecalc = document.createElement("button");
        btnRecalc.textContent = "Recalculer";
        btnRecalc.style.marginLeft = "10px";
        btnRecalc.style.fontSize = "0.8rem";
        btnRecalc.onclick = function() { checkFinanceBalance(); };
        notif.appendChild(btnRecalc);
      } else {
        notif.style.display = "none";
      }
      window.oldResultFinal = resultatFinal;
    }
    function toggleFinanceSummary() {
      let extra = document.getElementById("finance-summary-tbody-extra");
      let btn = document.getElementById("toggle-finance-summary");
      if (extra.style.display === "none") {
        extra.style.display = "";
        btn.textContent = "Masquer d√©tails ‚Üë";
      } else {
        extra.style.display = "none";
        btn.textContent = "Afficher d√©tails ‚Üì";
      }
    }
    function openAdjustFromNotification(diff) {
      let maxAmt = Math.abs(diff);
      let amountStr = prompt(`Il reste ${maxAmt.toFixed(2)} ‚Ç¨ √† ajuster. Entrez le montant √† ajuster (max ${maxAmt.toFixed(2)} ‚Ç¨) :`);
      let amt = parseFloat(amountStr);
      if(isNaN(amt) || amt <= 0 || amt > maxAmt) {
        alert("Montant invalide.");
        return;
      }
      let accountList = window.bankAccounts.map(acc => `${acc.id} (${acc.name} : ${acc.balance.toFixed(2)} ‚Ç¨)`).join("\n");
      let accId = prompt("S√©lectionnez le compte par son ID :\n" + accountList);
      let acc = window.bankAccounts.find(a => a.id === accId);
      if(!acc) {
        alert("Compte introuvable.");
        return;
      }
      if(diff > 0) {
        acc.balance += amt;
      } else {
        if(acc.balance < amt) {
          alert("Solde insuffisant sur ce compte.");
          return;
        }
        acc.balance -= amt;
      }
      saveBankAccounts();
      alert(`Ajustement de ${amt.toFixed(2)} ‚Ç¨ effectu√© sur ${acc.name}.`);
      renderBankAccounts();
      checkFinanceBalance();
    }
    function ajusterFinance(montant) {
      if (montant > 0) {
        window.revenus.unshift({ description: "Revenu rapide (" + montant + " ‚Ç¨)", montant: montant, chantier: false });
        alert("Revenu de " + montant + " ‚Ç¨ enregistr√©.");
      } else {
        let dep = Math.abs(montant);
        window.depenses.unshift({ description: "D√©pense rapide (" + dep + " ‚Ç¨)", montant: dep });
        alert("D√©pense de " + dep + " ‚Ç¨ enregistr√©e.");
      }
      saveFinance();
      renderFinanceSummary();
      renderRevenusList();
      renderDepensesList();
    }
    function saveFinance() {
      localStorage.setItem("gestion_revenus", JSON.stringify(window.revenus));
      localStorage.setItem("gestion_depenses", JSON.stringify(window.depenses));
      localStorage.setItem("gestion_depenses_prevues", JSON.stringify(window.depensesPrevues));
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       OUVRIERS
    ------------------------------ */
    function selectOuvrier() {
      let sel = document.getElementById("ouvrier-nom-dropdown").value;
      if (sel) document.getElementById("ouvrier-nom").value = sel;
    }
    function renderOuvriers() {
      let tbody = document.getElementById("ouvriers-tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      let map = {};
      window.ouvriers.forEach(o => {
        let key = o.nom + (o.paye ? "_paye" : "_nonpaye");
        if (!map[key]) { map[key] = { nom: o.nom, paye: o.paye, details: [] }; }
        let exist = map[key].details.find(d => d.tarif === o.tarif);
        if (exist) { exist.jours += o.jours; }
        else { map[key].details.push({ tarif: o.tarif, jours: o.jours }); }
      });
      Object.values(map).forEach(entry => {
        let total = 0;
        entry.details.forEach(d => { total += d.tarif * d.jours; });
        let totalStr = total.toFixed(2) + " ‚Ç¨";
        let tarifsHTML = "";
        if (entry.details.length === 1) {
          tarifsHTML = entry.details[0].tarif.toFixed(2) + " ‚Ç¨";
        } else {
          let uid = "tarif-details-" + entry.nom + (entry.paye ? "-paye" : "-nonpaye");
          tarifsHTML = `<button onclick="toggleTarifDetails('${uid}')">D√©tails</button>`;
          tarifsHTML += `<div id="${uid}" style="display:none; font-size:0.8rem; margin-top:5px;">`;
          entry.details.forEach(d => {
            tarifsHTML += `Tarif: ${d.tarif.toFixed(2)} ‚Ç¨ / Jours: ${d.jours} <br>`;
          });
          tarifsHTML += `</div>`;
        }
        let totalJours = entry.details.reduce((acc, d) => acc + d.jours, 0);
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td style='text-align:center;'>
            <input type='checkbox' onclick='toggleOuvrierPay("${entry.nom}", ${entry.paye})' ${entry.paye ? "checked" : ""}>
          </td>
          <td>${entry.nom}</td>
          <td>${tarifsHTML}</td>
          <td>${totalJours.toFixed(1)}</td>
          <td>${totalStr}</td>
          <td>
            <button class='action-btn' onclick='editOuvrier("${entry.nom}", ${entry.paye})'>Modifier</button>
            <button class='action-btn' onclick='deleteOuvrier("${entry.nom}", ${entry.paye})'>Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      applyPaginationToTable("ouvriers-tbody");
    }
    function toggleTarifDetails(id) {
      let div = document.getElementById(id);
      if (div) { div.style.display = (div.style.display === "none") ? "block" : "none"; }
    }
    function toggleOuvrierPay(nom, wasPaye) {
      window.ouvriers.forEach(o => { if (o.nom === nom && o.paye === wasPaye) { o.paye = !wasPaye; } });
      renderOuvriers();
      renderBaseOuvriers();
    }
    function editOuvrier(nom, isPaye) {
      let subset = window.ouvriers.filter(o => o.nom === nom && o.paye === isPaye);
      if (subset.length === 0) return;
      let o = subset[0];
      let newTarif = prompt("Nouveau tarif pour " + o.nom, o.tarif);
      let newJours = prompt("Nouveau nombre de jours pour " + o.nom, o.jours);
      if (newTarif !== null && newJours !== null) {
        o.tarif = parseFloat(newTarif) || o.tarif;
        o.jours = parseFloat(newJours) || o.jours;
        renderOuvriers();
      }
    }
    function deleteOuvrier(nom, isPaye) {
      if (!confirm("Supprimer l'ouvrier " + nom + " ?")) return;
      window.ouvriers = window.ouvriers.filter(o => !(o.nom === nom && o.paye === isPaye));
      renderOuvriers();
      renderBaseOuvriers();
    }
    function saveOuvriers() { localStorage.setItem("gestion_ouvriers", JSON.stringify(window.ouvriers)); }
    function saveBaseOuvriers() { localStorage.setItem("baseouvriers", JSON.stringify(window.baseOuvriers)); }
    function renderBaseOuvriers() {
      let unpaidContainer = document.getElementById("baseouvriers-unpaid");
      let paidContainer = document.getElementById("baseouvriers-paid");
      if (!unpaidContainer || !paidContainer) return;
      let unpaid = window.ouvriers.filter(o => !o.paye);
      let paid = window.ouvriers.filter(o => o.paye);
      let htmlUnpaid = "<h3>Ouvriers Impay√©s</h3>";
      if (unpaid.length === 0) htmlUnpaid += "<p>Aucun ouvrier impay√©.</p>";
      else {
        let total = 0;
        htmlUnpaid += "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Nom</th><th>Tarif</th><th>Jours</th><th>Total (‚Ç¨)</th></tr></thead><tbody id='baseouvriers-unpaid-tbody'>";
        unpaid.forEach(o => {
          let t = (o.tarif * o.jours).toFixed(2);
          total += parseFloat(t);
          htmlUnpaid += `<tr>
            <td>${o.nom}</td>
            <td>${o.tarif.toFixed(2)} ‚Ç¨</td>
            <td>${o.jours}</td>
            <td>${t} ‚Ç¨</td>
          </tr>`;
        });
        htmlUnpaid += `</tbody></table><p>Total impay√©: ${total.toFixed(2)} ‚Ç¨</p>`;
      }
      unpaidContainer.innerHTML = htmlUnpaid;
      applyPaginationToTable("baseouvriers-unpaid-tbody");
      
      let htmlPaid = "<h3>Ouvriers Pay√©s</h3>";
      if (paid.length === 0) htmlPaid += "<p>Aucun ouvrier pay√©.</p>";
      else {
        let total = 0;
        htmlPaid += "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Nom</th><th>Tarif</th><th>Jours</th><th>Total (‚Ç¨)</th></tr></thead><tbody id='baseouvriers-paid-tbody'>";
        paid.forEach(o => {
          let t = (o.tarif * o.jours).toFixed(2);
          total += parseFloat(t);
          htmlPaid += `<tr>
            <td>${o.nom}</td>
            <td>${o.tarif.toFixed(2)} ‚Ç¨</td>
            <td>${o.jours}</td>
            <td>${t} ‚Ç¨</td>
          </tr>`;
        });
        htmlPaid += `</tbody></table><p>Total pay√©: ${total.toFixed(2)} ‚Ç¨</p>`;
      }
      paidContainer.innerHTML = htmlPaid;
      applyPaginationToTable("baseouvriers-paid-tbody");
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       CHANTIERS & BASE CHANTIERS
    ------------------------------ */
    function saveChantiers() { localStorage.setItem("gestion_chantiers", JSON.stringify(window.chantiers)); }
    function saveTravauxFinis() { localStorage.setItem("travaux_finiss", JSON.stringify(window.travauxFinis)); }
    function renderChantiers() {
      let tbody = document.getElementById("chantier-tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      window.chantiers.forEach(c => {
        if(!c.etapes) { c.etapes = []; }
        let idx = window.chantiers.indexOf(c);
        tbody.innerHTML += `<tr>
          <td>${c.nom}</td>
          <td>${c.duree} jours</td>
          <td>${parseFloat(c.prix).toFixed(2)} ‚Ç¨</td>
          <td>${parseFloat(c.materiel).toFixed(2)} ‚Ç¨</td>
          <td>${(c.avance || 0)}%</td>
          <td>
            <button onclick='openStepsModal(${idx})'>Avancement</button>
            <button onclick='deleteChantier(${idx})'>Supprimer</button>
          </td>
        </tr>`;
      });
      applyPaginationToTable("chantier-tbody");
    }
    function deleteChantier(index) {
      if (confirm("Supprimer le chantier " + window.chantiers[index].nom + " ?")) {
        window.chantiers.splice(index, 1);
        saveChantiers();
        renderChantiers();
        renderBaseChantiers();
      }
    }
    function renderBaseChantiers() {
      let actTbody = document.getElementById("basechantier-actif-tbody");
      let finiTbody = document.getElementById("basechantier-fini-tbody");
      if (!actTbody || !finiTbody) return;
      actTbody.innerHTML = "";
      finiTbody.innerHTML = "";
      window.chantiers.forEach(c => {
        let idx = window.chantiers.indexOf(c);
        actTbody.innerHTML += `<tr>
          <td>${c.nom}</td>
          <td>${c.duree} jours</td>
          <td>${parseFloat(c.prix).toFixed(2)} ‚Ç¨</td>
          <td>${(c.avance || 0)}%</td>
          <td>
            <button onclick='openStepsModal(${idx})'>Avancement</button>
            <button onclick='finishChantier(${idx})'>Terminer</button>
          </td>
        </tr>`;
      });
      window.travauxFinis.forEach(c => {
        finiTbody.innerHTML += `<tr>
          <td>${c.nom}</td>
          <td>${c.duree} jours</td>
          <td>${parseFloat(c.prix).toFixed(2)} ‚Ç¨</td>
        </tr>`;
      });
      applyPaginationToTable("basechantier-actif-tbody");
      applyPaginationToTable("basechantier-fini-tbody");
    }
    function finishChantier(index) {
      if (!confirm("Terminer le chantier " + window.chantiers[index].nom + " ?")) return;
      let ch = window.chantiers.splice(index, 1)[0];
      ch.avance = 100;
      window.travauxFinis.unshift(ch);
      saveChantiers(); saveTravauxFinis();
      renderChantiers(); renderBaseChantiers();
    }
    var currentEtapes = [];
    function renderEtapesList() {
      let c = document.getElementById("etapes-container");
      if (!c) return;
      c.innerHTML = "";
      if (currentEtapes.length === 0) { c.innerHTML = "<p>Aucune √©tape.</p>"; return; }
      let ul = document.createElement("ul");
      currentEtapes.forEach((et, i) => {
        let li = document.createElement("li");
        li.textContent = et;
        li.onclick = function () { if (confirm("Supprimer cette √©tape ?")) { currentEtapes.splice(i, 1); renderEtapesList(); } };
        ul.appendChild(li);
      });
      c.appendChild(ul);
    }
    function openStepsModal(index) {
      window.currentChantierIndex = index;
      let ch = window.chantiers[index];
      if(!ch.etapes) { ch.etapes = []; }
      if (!ch.completedSteps || ch.completedSteps.length !== ch.etapes.length) {
        ch.completedSteps = [];
        for (let i = 0; i < ch.etapes.length; i++) { ch.completedSteps.push(false); }
      }
      let prog = calculateProgress(ch.completedSteps);
      let ctn = document.getElementById("steps-modal-content");
      ctn.innerHTML = "<h2>Avancement : " + ch.nom + "</h2><ul style='list-style:none; padding:0;'>";
      for (let i = 0; i < ch.etapes.length; i++) {
        ctn.innerHTML += `<li><label><input type='checkbox' onchange='updateChantierStep(${i}, this.checked)' ${ch.completedSteps[i] ? "checked" : ""}> ${ch.etapes[i]}</label></li>`;
      }
      ctn.innerHTML += `</ul><p id='progress-percentage'>Progression : ${prog} %</p>
      <button id='btnSauvegarderSteps' onclick="(function(){ let p = calculateProgress(ch.completedSteps); ch.avance = p; alert('Progression sauvegard√©e : ' + p + ' %'); closeStepsModal(); renderChantiers(); renderBaseChantiers(); })()">Sauvegarder</button>
      <button id='btnTerminerChantier' onclick="(function(){ finishChantier(${index}); closeStepsModal(); })()" style="display:${prog===100?"inline-block":"none"};">Terminer</button>`;
      document.getElementById("steps-modal").style.display = "flex";
    }
    function updateChantierStep(i, checked) {
      let ch = window.chantiers[window.currentChantierIndex];
      ch.completedSteps[i] = checked;
      let p = calculateProgress(ch.completedSteps);
      let el = document.getElementById("progress-percentage");
      if (el) el.textContent = "Progression : " + p + " %";
      let b = document.getElementById("btnTerminerChantier");
      if (b) b.style.display = (p === 100 ? "inline-block" : "none");
    }
    function calculateProgress(arr) {
      return Math.round((arr.filter(x => x).length / arr.length) * 100);
    }
    function closeStepsModal() {
      document.getElementById("steps-modal").style.display = "none";
    }
    document.getElementById("btnAddEtape").addEventListener("click", function () {
      let input = document.getElementById("etape-input");
      let val = input.value.trim();
      if (val === "") return;
      currentEtapes.unshift(val);
      input.value = "";
      renderEtapesList();
    });
    document.getElementById("form-chantier").addEventListener("submit", function (e) {
      e.preventDefault();
      let nom = document.getElementById("chantier-nom").value.trim();
      let duree = parseInt(document.getElementById("chantier-duree").value);
      let prix = parseFloat(document.getElementById("chantier-prix").value);
      let mat = parseFloat(document.getElementById("chantier-materiel").value);
      let payee = document.getElementById("chantier-mat-payee").checked;
      if (!nom || isNaN(duree) || isNaN(prix) || isNaN(mat)) return;
      let ch = { nom: nom, duree: duree, prix: prix, materiel: mat, matPayee: payee, etapes: currentEtapes.slice(), avance: 0 };
      ch.completedSteps = Array(ch.etapes.length).fill(false);
      window.chantiers.unshift(ch);
      saveChantiers();
      renderChantiers();
      this.reset();
      currentEtapes = [];
      renderEtapesList();
      renderBaseChantiers();
    });
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       PROJETS & GESTION DE L'AVANCEMENT
    ------------------------------ */
    function saveProjets() { localStorage.setItem("gestion_projets", JSON.stringify(window.projets)); }
    function renderProjets() {
      let container = document.getElementById("details-projet");
      if (!container) return;
      if (window.projets.length === 0) {
        container.innerHTML = "<p>Aucun projet enregistr√©.</p>";
        return;
      }
      let html = "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Nom</th><th>Budget</th><th>Dur√©e</th><th>Lien</th><th>Priorit√©</th><th>Avancement</th><th>Actions</th></tr></thead><tbody id='details-projet-tbody'>";
      window.projets.forEach(p => {
        let idx = window.projets.indexOf(p);
        let checkedCount = p.progress.filter(x => x).length;
        let percent = Math.round((checkedCount / p.duree) * 100);
        html += `<tr>
          <td>${p.nom}</td>
          <td>${parseFloat(p.prix).toFixed(2)} ‚Ç¨</td>
          <td>${p.duree} mois</td>
          <td>${p.lien ? ("<a href='" + p.lien + "' target='_blank'>Voir</a>") : ""}</td>
          <td>${p.priorite}</td>
          <td>${percent}%</td>
          <td>
            <button onclick='openSingleProjectProgress(${idx})'>Avancement</button>
            <button onclick='editProjet(${idx})'>Modifier</button>
            <button onclick='deleteProjet(${idx})'>Supprimer</button>
          </td>
        </tr>`;
      });
      html += "</tbody></table>";
      container.innerHTML = html;
      applyPaginationToTable("details-projet-tbody");
    }
    function deleteProjet(index) {
      if (!confirm("Supprimer le projet " + window.projets[index].nom + " ?")) return;
      window.projets.splice(index, 1);
      saveProjets();
      renderProjets();
    }
    function editProjet(index) {
      let p = window.projets[index];
      let newNom = prompt("Nom du projet :", p.nom);
      let newPrix = prompt("Budget total (‚Ç¨) :", p.prix);
      let newDuree = prompt("Dur√©e (mois) :", p.duree);
      if (newNom && newPrix && newDuree) {
        p.nom = newNom;
        p.prix = parseFloat(newPrix);
        p.duree = parseInt(newDuree);
        p.progress = Array(p.duree).fill(false);
        saveProjets();
        renderProjets();
      }
    }
    function toggleLienProjet() {
      let c = document.getElementById("projet-ajout-lien");
      let l = document.getElementById("projet-lien");
      l.style.display = (c.checked ? "block" : "none");
    }
    function calculateProjet() {
      let nom = document.getElementById("projet-nom").value.trim();
      let prixVal = document.getElementById("projet-prix").value.trim();
      let dureeVal = document.getElementById("projet-duree").value.trim();
      let modeInverse = document.getElementById("projet-mode-inverse").checked;
      let mensuel = parseFloat(document.getElementById("projet-mensuel").value) || 0;
      let moisObjectif = parseInt(document.getElementById("projet-mois-objectif").value) || 0;
      if (!nom || !prixVal || !dureeVal) return;
      let prix = parseFloat(prixVal);
      let duree = parseInt(dureeVal);
      if (modeInverse) {
        if (isNaN(mensuel) || mensuel <= 0) return;
        let totalBudget = mensuel * duree;
        alert("Mode inverse activ√©. Budget mensuel : " + mensuel.toFixed(2) + " ‚Ç¨ . Total : " + totalBudget.toFixed(2) + " ‚Ç¨ . Mois objectif : " + (moisObjectif || 'N/A'));
      } else {
        if (isNaN(prix) || prix <= 0) return;
        let monthlyBudget = prix / duree;
        alert("Mode normal. Budget total : " + prix.toFixed(2) + " ‚Ç¨ . Budget mensuel : " + monthlyBudget.toFixed(2) + " ‚Ç¨ . Mois objectif : " + (moisObjectif || 'N/A'));
      }
    }
    document.getElementById("form-projet").addEventListener("submit", function (e) {
      e.preventDefault();
      let nom = document.getElementById("projet-nom").value.trim();
      let prixVal = document.getElementById("projet-prix").value.trim();
      let dureeVal = document.getElementById("projet-duree").value.trim();
      if (!nom || !prixVal || !dureeVal) return;
      let prix = parseFloat(prixVal);
      let duree = parseInt(dureeVal);
      let ajoutLien = document.getElementById("projet-ajout-lien").checked;
      let lien = (ajoutLien ? document.getElementById("projet-lien").value.trim() : "");
      let modeInverse = document.getElementById("projet-mode-inverse").checked;
      let mensuel = parseFloat(document.getElementById("projet-mensuel").value) || 0;
      let moisObjectif = parseInt(document.getElementById("projet-mois-objectif").value) || 0;
      let priorite = document.getElementById("projet-priorite").value;
      let proj = { nom: nom, prix: prix, lien: lien, duree: duree, modeInverse: modeInverse, mensuel: mensuel, moisObjectif: moisObjectif, priorite: priorite, progress: [] };
      for (let i = 0; i < duree; i++) { proj.progress.push(false); }
      window.projets.unshift(proj);
      saveProjets();
      renderProjets();
      this.reset();
    });
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Gestion de la Progression des Projets
         - Pour un projet unique
         - Bouton "Avancement" dans le tableau appelle openSingleProjectProgress()
    ------------------------------ */
    function openSingleProjectProgress(index) {
      let proj = window.projets[index];
      if (!proj) return;
      document.getElementById("proj-single-title").textContent = "Avancement pour " + proj.nom;
      let container = document.getElementById("proj-single-container");
      container.innerHTML = "";
      for (let i = 0; i < proj.duree; i++) {
        let cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = `proj-${index}-month-${i}`;
        cb.checked = proj.progress[i];
        cb.onchange = function() { proj.progress[i] = cb.checked; renderProjets(); }
        let label = document.createElement("label");
        label.htmlFor = cb.id;
        label.textContent = `Mois ${i+1}`;
        container.appendChild(cb);
        container.appendChild(label);
        container.appendChild(document.createElement("br"));
      }
      document.getElementById("project-progress-modal-single").style.display = "flex";
    }
    function saveSingleProjectProgress() {
      alert("Progression sauvegard√©e pour ce projet.");
      closeSingleProjectModal();
      renderProjets();
    }
    function closeSingleProjectModal() {
      document.getElementById("project-progress-modal-single").style.display = "none";
    }
    function showAllProjectsRecap() {
      let container = document.getElementById("all-projects-recap");
      container.innerHTML = "";
      if(window.projets.length === 0) {
        container.innerHTML = "<p>Aucun projet enregistr√©.</p>";
      } else {
        window.projets.forEach(proj => {
          let checkedCount = proj.progress.filter(x => x).length;
          let percent = Math.round((checkedCount / proj.duree) * 100);
          container.innerHTML += `<p style="margin:10px 0;"><strong>${proj.nom}</strong> ‚Äî ${percent}% (${checkedCount}/${proj.duree})</p>`;
        });
      }
      document.getElementById("project-progress-modal-all").style.display = "flex";
    }
    function closeAllProjectsRecap() {
      document.getElementById("project-progress-modal-all").style.display = "none";
    }
    function saveProjectProgress() {
      alert("Progression sauvegard√©e pour tous les projets.");
      closeAllProjectsRecap();
      renderProjets();
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       ACHATS
    ------------------------------ */
    function ajouterAchat() {
      let nom = document.getElementById("achat-nom").value.trim();
      let prix = parseFloat(document.getElementById("achat-prix").value);
      let prio = parseInt(document.getElementById("achat-priorite").value);
      if (!nom || isNaN(prix) || isNaN(prio)) return;
      let a = { nom: nom, prix: prix, priorite: prio, selected: false, done: false };
      window.achats.unshift(a);
      renderAchatsTable();
      saveAchatsProgress();
      document.getElementById("form-achat").reset();
    }
    function renderAchatsTable() {
      let tbody = document.getElementById("achats-tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      window.achats.forEach(a => {
        tbody.innerHTML += `<tr>
          <td style='text-align:center;'><input type='checkbox' onchange='toggleAchatSelection(${window.achats.indexOf(a)}, this.checked)' ${a.selected ? "checked" : ""}></td>
          <td>${a.nom}</td>
          <td style='text-align:right;'>${a.prix.toFixed(2)} ‚Ç¨</td>
          <td style='text-align:right;'>${a.priorite}</td>
          <td style='text-align:center;'>
            <input type='checkbox' onchange='toggleAchatDone(${window.achats.indexOf(a)}, this.checked)' ${a.done ? "checked" : ""}>
            <button onclick='supprimerAchat(${window.achats.indexOf(a)})'>Supprimer</button>
          </td>
        </tr>`;
      });
      applyPaginationToTable("achats-tbody");
      saveAchatsProgress();
    }
    function toggleAchatSelection(index, checked) {
      window.achats[index].selected = checked;
    }
    function toggleAchatDone(index, checked) {
      window.achats[index].done = checked;
      renderAchatsTable();
    }
    function supprimerAchat(index) {
      if (confirm("Supprimer cet achat ?")) {
        window.achats.splice(index, 1);
        renderAchatsTable();
      }
    }
    function creerGroupeAchats() {
      let gn = document.getElementById("nom-groupe").value.trim();
      if (!gn) return;
      let sel = window.achats.filter(a => a.selected);
      if (sel.length === 0) { alert("Aucun achat s√©lectionn√©."); return; }
      let grp = { nom: gn, achats: JSON.parse(JSON.stringify(sel)) };
      window.groupedAchats.unshift(grp);
      window.achats.forEach(a => { if (a.selected) a.selected = false; });
      renderAchatsTable();
      renderGroupedAchats();
      document.getElementById("nom-groupe").value = "";
    }
    function renderGroupedAchats() {
      let c = document.getElementById("grouped-achats-table");
      if (!c) return;
      c.innerHTML = "";
      if (window.groupedAchats.length === 0) { c.innerHTML = "<p>Aucun groupe cr√©√©.</p>"; return; }
      window.groupedAchats.forEach(g => {
        c.innerHTML += `<div style="border:1px solid #ccc; padding:5px; margin-bottom:5px;">
          <h4>${g.nom}</h4>
          <ul>`;
        g.achats.forEach(a => {
          c.innerHTML += `<li>${a.nom} - ${a.prix.toFixed(2)} ‚Ç¨ (Priorit√©: ${a.priorite})</li>`;
        });
        c.innerHTML += `</ul></div>`;
      });
    }
    function toggleGroupedAchats() {
      let c = document.getElementById("grouped-achats-table");
      if (!c) return;
      c.style.display = (c.style.display === "block") ? "none" : "block";
    }
    function saveAchatsProgress() {
      let total = window.achats.length;
      if (total === 0) return;
      let doneCount = window.achats.filter(a => a.done).length;
      let percent = Math.round((doneCount / total) * 100);
      document.getElementById("achats-progress-text").textContent = "Progression de la liste d'achats : " + percent + "%";
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       OPTIONS SUPPL√âMENTAIRES
    ------------------------------ */
    document.getElementById("options-list").innerHTML =
      "<li onclick='openMargeBenef()'><span class='option-icon'>üí∞</span><span>Marge B√©n√©fice</span></li>" +
      "<li onclick='openTresorerie()'><span class='option-icon'>üè¶</span><span>Tr√©sorier</span></li>" +
      "<li onclick='openComparatifBenefice()'><span class='option-icon'>‚öñÔ∏è</span><span>Comparatif B√©n√©fice</span></li>" +
      "<li onclick='openPlanificationTache()'><span class='option-icon'>üìù</span><span>Planif. T√¢ches</span></li>" +
      "<li onclick='openRapportTresorerieMensuel()'><span class='option-icon'>üìÖ</span><span>Rapport Tr√©sorerie</span></li>" +
      "<li onclick='openAnalyseAvancee()'><span class='option-icon'>üìà</span><span>Analyse Avanc√©e</span></li>" +
      "<li onclick='openChiffreAffaires()'><span class='option-icon'>üíπ</span><span>Chiffre d‚ÄôAffaires</span></li>" +
      "<li onclick='openHistoriqueChantiers()'><span class='option-icon'>üìú</span><span>Hist. Chantiers</span></li>" +
      "<li onclick='openGestionFournisseurs()'><span class='option-icon'>üè∑Ô∏è</span><span>Fournisseurs</span></li>" +
      "<li onclick='openStatsProductivite()'><span class='option-icon'>üìä</span><span>Stats Prod.</span></li>" +
      "<li onclick='openPrevisionBudget()'><span class='option-icon'>üîÆ</span><span>Pr√©vision Budget</span></li>" +
      "<li onclick='openRapportActiviteGlobal()'><span class='option-icon'>üóÇ</span><span>Rapport Global</span></li>";
    function openMargeBenef() {
      if (window.chantiers.length === 0) { showOptionModal("Marge B√©n√©fice", "<p>Aucun chantier enregistr√©.</p>"); return; }
      let html = "<p>Chantier :</p><select id='chantier-select-marge'>";
      window.chantiers.forEach((c, i) => { html += "<option value='" + i + "'>" + c.nom + "</option>"; });
      html += "</select><button onclick='calculerMarge()'>Calculer</button><div id='result-marge'></div>";
      showOptionModal("Marge B√©n√©fice", html);
    }
    function calculerMarge() {
      let i = document.getElementById("chantier-select-marge").value;
      let c = window.chantiers[i];
      if (!c) return;
      let benef = (c.prix * 0.78) - (c.materiel || 0);
      document.getElementById("result-marge").innerHTML = "<p>B√©n√©fice pour " + c.nom + " : " + benef.toFixed(2) + " ‚Ç¨</p>";
    }
    function openTresorerie() {
      let rev = window.revenus.reduce((s, r) => s + r.montant, 0) + window.revenusAttente.reduce((s, r) => s + r.montant, 0);
      let dep = window.depenses.reduce((s, d) => s + d.montant, 0) + window.depensesPrevues.filter(d => d.applique).reduce((s, d) => s + d.montant, 0);
      let gains = window.ouvriers.reduce((s, o) => s + (o.paye ? o.tarif * o.jours : 0), 0);
      let bal = rev - (dep + gains);
      showOptionModal("Tr√©sorier", "<p>Capital personnel : " + bal.toFixed(2) + " ‚Ç¨</p>");
    }
    function openComparatifBenefice() {
      if (window.chantiers.length < 2) { showOptionModal("Comparatif B√©n√©fice", "<p>Il faut au moins 2 chantiers.</p>"); return; }
      let html = "<p>Chantier 1 : <select id='chantier1'>";
      window.chantiers.forEach((c, i) => { html += "<option value='" + i + "'>" + c.nom + "</option>"; });
      html += "</select><br>Chantier 2 : <select id='chantier2'>";
      window.chantiers.forEach((c, i) => { html += "<option value='" + i + "'>" + c.nom + "</option>"; });
      html += "</select><br><button onclick='comparatifChantiers()'>Comparer</button><div id='result-comparatif'></div>";
      showOptionModal("Comparatif B√©n√©fice", html);
    }
    function comparatifChantiers() {
      let i1 = document.getElementById("chantier1").value;
      let i2 = document.getElementById("chantier2").value;
      let c1 = window.chantiers[i1], c2 = window.chantiers[i2];
      if (!c1 || !c2) return;
      let b1 = (c1.prix * 0.78) - (c1.materiel || 0);
      let b2 = (c2.prix * 0.78) - (c2.materiel || 0);
      let diff = Math.abs(b1 - b2);
      document.getElementById("result-comparatif").innerHTML = "<p>" + c1.nom + " : " + b1.toFixed(2) + " ‚Ç¨<br>" + c2.nom + " : " + b2.toFixed(2) + " ‚Ç¨<br>Diff√©rence : " + diff.toFixed(2) + " ‚Ç¨</p>";
    }
    function openPlanificationTache() {
      let html = "<p>Ajouter une t√¢che :</p><input type='text' id='new-task'><button onclick='addTask()'>Ajouter</button><div id='tasks-list'></div>";
      showOptionModal("Planification T√¢ches", html);
      renderTasks();
    }
    window.taches = [];
    function addTask() {
      let t = document.getElementById("new-task").value.trim();
      if (t !== "") { window.taches.push(t); document.getElementById("new-task").value = ""; renderTasks(); }
    }
    function renderTasks() {
      let d = document.getElementById("tasks-list");
      if (!d) return;
      let html = "<ul>";
      window.taches.forEach((ts, i) => { html += "<li>" + ts + " <button onclick='editTask(" + i + ")'>Modifier</button> <button onclick='removeTask(" + i + ")'>Supprimer</button></li>"; });
      html += "</ul>";
      d.innerHTML = html;
    }
    function removeTask(i) { window.taches.splice(i, 1); renderTasks(); }
    function editTask(i) {
      let n = prompt("Modifier la t√¢che :", window.taches[i]);
      if (n !== null && n.trim() !== "") { window.taches[i] = n.trim(); renderTasks(); }
    }
    function openRapportTresorerieMensuel() { showOptionModal("Rapport Tr√©sorerie", "<p>Fonction simplifi√©e. Aucune donn√©e mensuelle disponible.</p>"); }
    function openAnalyseAvancee() {
      let rev = window.revenus.reduce((s, r) => s + r.montant, 0) + window.revenusAttente.reduce((s, r) => s + r.montant, 0);
      let dep = window.depenses.reduce((s, d) => s + d.montant, 0) + window.depensesPrevues.filter(d => d.applique).reduce((s, d) => s + d.montant, 0);
      let gains = window.ouvriers.reduce((s, o) => s + (o.paye ? o.tarif * o.jours : 0), 0);
      let bal = rev - (dep + gains);
      let old = bal * (0.8 + Math.random() * 0.4);
      let diff = ((bal - old) / old * 100).toFixed(2);
      let h = "<table style='width:100%; border-collapse:collapse;'><thead><tr><th>Solde pass√©</th><th>Solde actuel</th><th>Variation (%)</th></tr></thead><tbody><tr><td style='text-align:right;'>" + old.toFixed(2) + " ‚Ç¨</td><td style='text-align:right;'>" + bal.toFixed(2) + " ‚Ç¨</td><td style='text-align:right;'>" + diff + " %</td></tr></tbody></table>";
      showOptionModal("Analyse Avanc√©e", h);
    }
    function openChiffreAffaires() {
      let rev = window.revenus.reduce((s, r) => s + r.montant, 0);
      showOptionModal("Chiffre d‚ÄôAffaires", "<p>Total : " + rev.toFixed(2) + " ‚Ç¨</p>");
    }
    function openHistoriqueChantiers() {
      if (window.travauxFinis.length === 0) { showOptionModal("Historique Chantiers", "<p>Aucun chantier termin√©.</p>"); return; }
      let h = "<ul>";
      window.travauxFinis.forEach(c => { h += "<li>" + c.nom + " (" + c.duree + " jours, " + parseFloat(c.prix).toFixed(2) + " ‚Ç¨)</li>"; });
      h += "</ul>";
      showOptionModal("Historique Chantiers", h);
    }
    function openGestionFournisseurs() {
      if (!window.fournisseurs) window.fournisseurs = [];
      let html = "<p>Ajouter un fournisseur :</p><input type='text' id='fournisseur-nom'><button onclick='addFournisseur()'>Ajouter</button><div id='fournisseurs-list'></div>";
      showOptionModal("Fournisseurs", html);
      renderFournisseurs();
    }
    window.fournisseurs = [];
    function addFournisseur() {
      let n = document.getElementById("fournisseur-nom").value.trim();
      if (n !== "") { window.fournisseurs.push(n); document.getElementById("fournisseur-nom").value = ""; renderFournisseurs(); }
    }
    function renderFournisseurs() {
      let d = document.getElementById("fournisseurs-list");
      if (!d) return;
      let h = "<ul>";
      window.fournisseurs.forEach((f, i) => { h += "<li>" + f + " <button onclick='removeFournisseur(" + i + ")'>Supprimer</button></li>"; });
      h += "</ul>";
      d.innerHTML = h;
    }
    function removeFournisseur(i) { window.fournisseurs.splice(i, 1); renderFournisseurs(); }
    function openStatsProductivite() {
      let totalW = window.ouvriers.length;
      let totalJ = window.ouvriers.reduce((s, o) => s + o.jours, 0);
      let avg = totalW ? (totalJ / totalW).toFixed(2) : 0;
      let h = "<p>Ouvriers : " + totalW + "</p><p>Jours totaux : " + totalJ.toFixed(2) + "</p><p>Moyenne jours/ouvrier : " + avg + "</p>";
      showOptionModal("Stats Productivit√©", h);
    }
    function openPrevisionBudget() {
      let monthlyRev = window.revenus.reduce((s, r) => s + r.montant, 0) / 12;
      let monthlyDep = window.depenses.reduce((s, d) => s + d.montant, 0) / 12;
      let forecast = monthlyRev - monthlyDep;
      let h = "<p>Revenus mensuels moyens : " + monthlyRev.toFixed(2) + " ‚Ç¨</p><p>D√©penses mensuelles moyennes : " + monthlyDep.toFixed(2) + " ‚Ç¨</p><p>Budget pr√©visionnel : " + forecast.toFixed(2) + " ‚Ç¨</p>";
      showOptionModal("Pr√©vision Budget", h);
    }
    function openRapportActiviteGlobal() {
      let w = window.ouvriers.length;
      let c = window.chantiers.length;
      let p = window.projets.length;
      let h = "<p>Ouvriers : " + w + "</p><p>Chantiers actifs : " + c + "</p><p>Projets : " + p + "</p>";
      showOptionModal("Rapport Global", h);
    }
    function showOptionModal(t, c) {
      document.getElementById("option-modal-title").textContent = t;
      document.getElementById("option-modal-body").innerHTML = c;
      document.getElementById("option-modal").style.display = "flex";
    }
    document.getElementById("option-close-btn").onclick = function () { document.getElementById("option-modal").style.display = "none"; };
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Export / Import / Clear All / Backups
    ------------------------------ */
    function exportAllData() {
      let data = {
        ouvriers: JSON.parse(localStorage.getItem("gestion_ouvriers") || "[]"),
        baseOuvriers: JSON.parse(localStorage.getItem("baseouvriers") || "[]"),
        chantiers: JSON.parse(localStorage.getItem("gestion_chantiers") || "[]"),
        travauxFinis: JSON.parse(localStorage.getItem("travaux_finiss") || "[]"),
        revenus: JSON.parse(localStorage.getItem("gestion_revenus") || "[]"),
        depenses: JSON.parse(localStorage.getItem("gestion_depenses") || "[]"),
        depensesPrevues: JSON.parse(localStorage.getItem("gestion_depenses_prevues") || "[]"),
        projets: JSON.parse(localStorage.getItem("gestion_projets") || "[]"),
        collaborations: JSON.parse(localStorage.getItem("gestion_collaborations") || "[]")
      };
      let blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.style.display = "none";
      a.href = url;
      a.download = "export_data_" + (new Date().toISOString().split("T")[0]) + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function importAllData() { document.getElementById("import-file").click(); }
    function handleImport(e) {
      let f = e.target.files[0];
      if (!f) return;
      let r = new FileReader();
      r.onload = function (evt) {
        try {
          let d = JSON.parse(evt.target.result);
          if (d.ouvriers) localStorage.setItem("gestion_ouvriers", JSON.stringify(d.ouvriers));
          if (d.baseOuvriers) localStorage.setItem("baseouvriers", JSON.stringify(d.baseOuvriers));
          if (d.chantiers) localStorage.setItem("gestion_chantiers", JSON.stringify(d.chantiers));
          if (d.travauxFinis) localStorage.setItem("travaux_finiss", JSON.stringify(d.travauxFinis));
          if (d.revenus) localStorage.setItem("gestion_revenus", JSON.stringify(d.revenus));
          if (d.depenses) localStorage.setItem("gestion_depenses", JSON.stringify(d.depenses));
          if (d.depensesPrevues) localStorage.setItem("gestion_depenses_prevues", JSON.stringify(d.depensesPrevues));
          if (d.projets) localStorage.setItem("gestion_projets", JSON.stringify(d.projets));
          if (d.collaborations) localStorage.setItem("gestion_collaborations", JSON.stringify(d.collaborations));
          alert("Import r√©ussi !");
          location.reload();
        } catch (er) { alert("Erreur import : " + er); }
      };
      r.readAsText(f);
    }
    function clearAllData() {
      if (!confirm("R√©initialiser toutes les donn√©es ?")) return;
      localStorage.removeItem("gestion_ouvriers");
      localStorage.removeItem("baseouvriers");
      localStorage.removeItem("gestion_chantiers");
      localStorage.removeItem("travaux_finiss");
      localStorage.removeItem("gestion_revenus");
      localStorage.removeItem("gestion_depenses");
      localStorage.removeItem("gestion_depenses_prevues");
      localStorage.removeItem("gestion_projets");
      localStorage.removeItem("gestion_collaborations");
      alert("Toutes les donn√©es ont √©t√© r√©initialis√©es.");
      location.reload();
    }
    function showHelp() {
      alert("Aide :\n- Exporter/Importer : JSON complet.\n- Tout r√©initialiser : supprime toutes les donn√©es.\n- Sauvegarder une section : export partiel.\n- Afficher Synth√®se : aper√ßu.\n- Ouvriers, Chantiers, Projets, Finance, etc. : g√©r√©s via localStorage.");
    }
    function viewSummary() {
      let ouv = JSON.parse(localStorage.getItem("gestion_ouvriers") || "[]").length;
      let rev = JSON.parse(localStorage.getItem("gestion_revenus") || "[]").length;
      let dep = JSON.parse(localStorage.getItem("gestion_depenses") || "[]").length;
      alert("Synth√®se :\nOuvriers : " + ouv + "\nRevenus : " + rev + "\nD√©penses : " + dep);
    }
    function toggleBackupList() {
      let b = document.getElementById("backups-list");
      let btn = document.getElementById("toggle-backups-btn");
      if (b.style.display === "" || b.style.display === "none") { viewBackups(); b.style.display = "block"; btn.textContent = "Masquer sauvegardes"; }
      else { b.style.display = "none"; btn.textContent = "Afficher sauvegardes"; }
    }
    function viewBackups() {
      let backups = JSON.parse(localStorage.getItem("backups") || "[]");
      let c = document.getElementById("backups-list");
      if (backups.length === 0) { c.innerHTML = "<p>Aucune sauvegarde.</p>"; return; }
      let html = "<table style='width:100%; border-collapse:collapse; font-size:10px;'><thead><tr><th style='border:1px solid var(--border-color); padding:4px;'>Nom</th><th style='border:1px solid var(--border-color); padding:4px;'>Section</th><th style='border:1px solid var(--border-color); padding:4px;'>Date</th><th style='border:1px solid var(--border-color); padding:4px;'>R√©cap</th><th style='border:1px solid var(--border-color); padding:4px;'>Suppr</th></tr></thead><tbody>";
      backups.forEach((b, i) => {
        html += `<tr><td style='border:1px solid var(--border-color); padding:4px;'>${b.customName || ""}</td><td style='border:1px solid var(--border-color); padding:4px;'>${b.section}</td><td style='border:1px solid var(--border-color); padding:4px;'>${b.date}</td><td style='border:1px solid var(--border-color); padding:4px;'>${b.summary}</td><td style='border:1px solid var(--border-color); padding:4px; text-align:center;'><button style='font-size:10px;' onclick='deleteBackup(${i})'>Supprimer</button></td></tr>`;
      });
      html += "</tbody></table>";
      c.innerHTML = html;
    }
    function deleteBackup(index) {
      let backups = JSON.parse(localStorage.getItem("backups") || "[]");
      if (index < 0 || index >= backups.length) return;
      if (!confirm("Supprimer sauvegarde " + (backups[index].section || "") + " ?")) return;
      backups.splice(index, 1);
      localStorage.setItem("backups", JSON.stringify(backups));
      viewBackups();
    }
    function toggleBackupInterface() {
      let d = document.getElementById("backup-interface");
      d.style.display = (d.style.display === "" || d.style.display === "none") ? "block" : "none";
    }
    function backupSection() { toggleBackupInterface(); }
    function performBackup() {
      let name = document.getElementById("backup-name").value.trim();
      let section = document.getElementById("backup-select").value;
      let map = { ouvriers: "gestion_ouvriers", baseouvriers: "baseouvriers", chantiers: "gestion_chantiers", travauxFinis: "travaux_finiss", revenus: "gestion_revenus", depenses: "gestion_depenses", depensesPrevues: "gestion_depenses_prevues", projets: "gestion_projets" };
      let sk = map[section];
      let raw = localStorage.getItem(sk) || "[]";
      let dateStr = new Date().toLocaleString();
      let backups = JSON.parse(localStorage.getItem("backups") || "[]");
      backups.push({ customName: name, section: section, date: dateStr, summary: raw });
      localStorage.setItem("backups", JSON.stringify(backups));
      let blob = new Blob([raw], { type: "application/json" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = (name ? name + "_" : "") + section + "_" + (new Date().toISOString().split("T")[0]) + ".json";
      a.click();
      URL.revokeObjectURL(url);
      toggleBackupInterface();
      alert("Sauvegarde effectu√©e pour la section " + section);
    }
    function printReport() { alert("Impression non impl√©ment√©e."); }
    function closeReport() { document.getElementById("report-modal").style.display = "none"; }
    function showOptionModal(t, c) {
      document.getElementById("option-modal-title").textContent = t;
      document.getElementById("option-modal-body").innerHTML = c;
      document.getElementById("option-modal").style.display = "flex";
    }
    function closeOptionModal() { document.getElementById("option-modal").style.display = "none"; }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Ajustement de la Balance
    ------------------------------ */
    function checkFinanceBalance() {
      let soldeElem = document.querySelector("#finance-summary td:last-child");
      if (!soldeElem) return;
      let soldeGlobal = parseFloat(soldeElem.innerText.replace(" ‚Ç¨", ""));
      let totalBanque = window.bankAccounts.reduce((sum, acc) => sum + acc.balance, 0);
      let difference = soldeGlobal - totalBanque;
      let notif = document.getElementById("bank-notification");
      let btn = document.getElementById("adjust-finance-btn");
      if (difference !== 0) {
        notif.style.display = "block";
        notif.innerHTML = `‚ö†Ô∏è Solde global (${soldeGlobal.toFixed(2)} ‚Ç¨) ‚â† Total banque (${totalBanque.toFixed(2)} ‚Ç¨) - Diff√©rence: ${difference.toFixed(2)} ‚Ç¨`;
        btn.style.display = "block";
      } else {
        notif.style.display = "none";
        btn.style.display = "none";
      }
    }
    function openAdjustModal() {
      let soldeElem = document.querySelector("#finance-summary td:last-child");
      if (!soldeElem) return;
      let soldeGlobal = parseFloat(soldeElem.innerText.replace(" ‚Ç¨", ""));
      let totalBanque = window.bankAccounts.reduce((sum, acc) => sum + acc.balance, 0);
      let difference = soldeGlobal - totalBanque;
      if (difference === 0) return;
      let modal = document.getElementById("adjustment-modal");
      let disp = document.getElementById("adjust-amount-display");
      let select = document.getElementById("adjust-account");
      disp.textContent = `Diff√©rence √† ajuster : ${difference.toFixed(2)} ‚Ç¨`;
      select.innerHTML = "";
      window.bankAccounts.forEach(account => {
        let opt = document.createElement("option");
        opt.value = account.id;
        opt.textContent = account.name + " (Solde : " + account.balance.toFixed(2) + " ‚Ç¨)";
        select.appendChild(opt);
      });
      modal.style.display = "flex";
    }
    function closeAdjustModal() { document.getElementById("adjustment-modal").style.display = "none"; }
    function applyAdjustment() {
      let diff = parseFloat(document.getElementById("adjust-amount-display").textContent.replace("Diff√©rence √† ajuster : ", "").replace(" ‚Ç¨", ""));
      let accId = document.getElementById("adjust-account").value;
      let amt = parseFloat(document.getElementById("adjust-value").value);
      if (isNaN(amt) || amt <= 0 || Math.abs(amt) > Math.abs(diff)) { alert("Montant invalide."); return; }
      let acc = window.bankAccounts.find(a => a.id === accId);
      if (!acc) { alert("Compte introuvable."); return; }
      acc.balance += (diff > 0 ? amt : -amt);
      saveBankAccounts();
      alert(`Ajustement effectu√© : ${amt.toFixed(2)} ‚Ç¨ ${diff > 0 ? "ajout√© √†" : "retir√© de"} ${acc.name}.`);
      closeAdjustModal();
      renderBankAccounts();
      checkFinanceBalance();
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Collaboration
    ------------------------------ */
    var CollaborationModule = {
      chantierSelected: null,
      collaborators: [],
      loadChantiers: function () {
        let s = document.getElementById("collab-chantier");
        if (!s) return;
        s.innerHTML = "";
        // Ne proposer que les chantiers en cours (avance < 100)
        let chs = window.chantiers.filter(ch => (ch.avance === undefined || ch.avance < 100));
        if (chs.length === 0) {
          let opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Aucun chantier en cours";
          s.appendChild(opt);
          return;
        }
        chs.forEach((ch, i) => {
          let profit = (parseFloat(ch.prix) || 0) - (parseFloat(ch.materiel) || 0);
          let opt = document.createElement("option");
          opt.value = window.chantiers.indexOf(ch);
          opt.textContent = ch.nom + " (Profit : " + profit.toFixed(2) + " ‚Ç¨)";
          s.appendChild(opt);
        });
        this.chantierSelected = chs[0];
      },
      addCollaboratorRow: function () {
        let c = document.getElementById("collab-list");
        let d = document.createElement("div");
        d.style.marginBottom = "8px";
        let iName = document.createElement("input");
        iName.type = "text";
        iName.placeholder = "Nom du collaborateur";
        iName.required = true;
        iName.style.marginRight = "8px";
        let iDays = document.createElement("input");
        iDays.type = "number";
        iDays.placeholder = "Jours travaill√©s";
        iDays.step = "0.1";
        iDays.required = true;
        iDays.style.marginRight = "8px";
        let bRemove = document.createElement("button");
        bRemove.type = "button";
        bRemove.textContent = "Supprimer";
        bRemove.onclick = function () { c.removeChild(d); CollaborationModule.calculate(); };
        d.append(iName, iDays, bRemove);
        c.appendChild(d);
      },
      getCollaboratorsData: function () {
        let c = document.getElementById("collab-list");
        let arr = [];
        Array.from(c.children).forEach(row => {
          let inputs = row.getElementsByTagName("input");
          if (inputs.length >= 2) {
            let nm = inputs[0].value.trim();
            let ds = parseFloat(inputs[1].value);
            if (nm && !isNaN(ds)) arr.push({ name: nm, days: ds });
          }
        });
        return arr;
      },
      adjustDays: function(index, delta) {
        if (index === 0) {
          let inputMoi = document.getElementById("collab-moi");
          let current = parseFloat(inputMoi.value) || 0;
          let newVal = current + delta;
          if (newVal < 0) newVal = 0;
          inputMoi.value = newVal;
        } else {
          let collabList = document.getElementById("collab-list");
          let childIndex = index - 1;
          if (collabList.children[childIndex]) {
            let inputs = collabList.children[childIndex].getElementsByTagName("input");
            if (inputs.length >= 2) {
              let current = parseFloat(inputs[1].value) || 0;
              let newVal = current + delta;
              if (newVal < 0) newVal = 0;
              inputs[1].value = newVal;
            }
          }
        }
        this.calculate();
      },
      calculate: function () {
        let s = document.getElementById("collab-chantier");
        let idx = s.value;
        if (idx === "") { alert("Aucun chantier s√©lectionn√©."); return; }
        let ch = window.chantiers[idx];
        if (!ch) { alert("Chantier introuvable."); return; }
        this.chantierSelected = ch;
        let profit = (parseFloat(ch.prix) || 0) - (parseFloat(ch.materiel) || 0);
        let mesJours = parseFloat(document.getElementById("collab-moi").value);
        if (isNaN(mesJours)) { alert("Saisir mes jours."); return; }
        this.collaborators = this.getCollaboratorsData();
        let totalDays = mesJours;
        this.collaborators.forEach(c => { totalDays += c.days; });
        if (totalDays === 0) { alert("Total jours = 0."); return; }
        let results = [];
        results.push({ name: "Moi", days: mesJours, share: (mesJours / totalDays) * profit });
        this.collaborators.forEach(c => { results.push({ name: c.name, days: c.days, share: (c.days / totalDays) * profit }); });
        // Sauvegarde des donn√©es de collaboration
        let collabData = {
          chantier: s.value,
          moi: mesJours,
          collaborators: this.collaborators
        };
        window.collaborations = collabData;
        localStorage.setItem("gestion_collaborations", JSON.stringify(collabData));
        let tbody = document.getElementById("collab-result-tbody");
        tbody.innerHTML = "";
        results.forEach(function(r, i) {
          let tr = document.createElement("tr");
          let tdName = document.createElement("td");
          tdName.textContent = r.name;
          let tdDays = document.createElement("td");
          tdDays.textContent = r.days.toFixed(1);
          let tdShare = document.createElement("td");
          tdShare.textContent = r.share.toFixed(2) + " ‚Ç¨";
          let tdActions = document.createElement("td");
          let btnPlus = document.createElement("button");
          btnPlus.textContent = "+";
          btnPlus.onclick = function() { CollaborationModule.adjustDays(i, 1); };
          let btnMinus = document.createElement("button");
          btnMinus.textContent = "-";
          btnMinus.onclick = function() { CollaborationModule.adjustDays(i, -1); };
          tdActions.appendChild(btnPlus);
          tdActions.appendChild(btnMinus);
          tr.appendChild(tdName);
          tr.appendChild(tdDays);
          tr.appendChild(tdShare);
          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });
        applyPaginationToTable("collab-result-tbody");
      }
    };

    // Fonction de chargement des donn√©es de collaboration depuis le localStorage
    function loadCollaborations() {
      let collabDataStr = localStorage.getItem("gestion_collaborations");
      if (collabDataStr) {
        let collabData = JSON.parse(collabDataStr);
        document.getElementById("collab-moi").value = collabData.moi || 0;
        let collabList = document.getElementById("collab-list");
        collabList.innerHTML = "";
        if (collabData.collaborators && Array.isArray(collabData.collaborators)) {
          collabData.collaborators.forEach(collab => {
            let d = document.createElement("div");
            d.style.marginBottom = "8px";
            let iName = document.createElement("input");
            iName.type = "text";
            iName.placeholder = "Nom du collaborateur";
            iName.required = true;
            iName.style.marginRight = "8px";
            iName.value = collab.name;
            let iDays = document.createElement("input");
            iDays.type = "number";
            iDays.placeholder = "Jours travaill√©s";
            iDays.step = "0.1";
            iDays.required = true;
            iDays.style.marginRight = "8px";
            iDays.value = collab.days;
            let bRemove = document.createElement("button");
            bRemove.type = "button";
            bRemove.textContent = "Supprimer";
            bRemove.onclick = function () { collabList.removeChild(d); CollaborationModule.calculate(); };
            d.append(iName, iDays, bRemove);
            collabList.appendChild(d);
          });
        }
        CollaborationModule.calculate();
      }
    }
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Refresh All & INITIALISATION
    ------------------------------ */
    function refreshAll() {
      renderBankAccounts();
      renderRevenusList();
      renderRevenusAttenteList();
      renderDepensesList();
      renderDepensesPrevuesList();
      renderPredictedFortune();
      renderFinanceSummary();
      renderOuvriers();
      renderBaseOuvriers();
      renderChantiers();
      renderBaseChantiers();
      renderProjets();
      renderAchatsTable();
      renderGroupedAchats();
      CollaborationModule.loadChantiers();
      loadCollaborations(); // Chargement des donn√©es de collaboration
      checkFinanceBalance();
    }
    document.addEventListener("DOMContentLoaded", function () {
      loadBankAccounts();
      if (localStorage.getItem("gestion_ouvriers")) window.ouvriers = JSON.parse(localStorage.getItem("gestion_ouvriers"));
      if (localStorage.getItem("baseouvriers")) window.baseOuvriers = JSON.parse(localStorage.getItem("baseouvriers"));
      if (localStorage.getItem("gestion_chantiers")) window.chantiers = JSON.parse(localStorage.getItem("gestion_chantiers"));
      if (localStorage.getItem("travaux_finiss")) window.travauxFinis = JSON.parse(localStorage.getItem("travaux_finiss"));
      if (localStorage.getItem("gestion_revenus")) window.revenus = JSON.parse(localStorage.getItem("gestion_revenus"));
      if (localStorage.getItem("gestion_depenses")) window.depenses = JSON.parse(localStorage.getItem("gestion_depenses"));
      if (localStorage.getItem("gestion_depenses_prevues")) window.depensesPrevues = JSON.parse(localStorage.getItem("gestion_depenses_prevues"));
      if (localStorage.getItem("gestion_projets")) window.projets = JSON.parse(localStorage.getItem("gestion_projets"));
      if (localStorage.getItem("gestion_collaborations")) window.collaborations = JSON.parse(localStorage.getItem("gestion_collaborations"));
      
      document.getElementById("form-new-account").addEventListener("submit", createBankAccount);
      
      document.getElementById("form-revenu").addEventListener("submit", function (e) {
        e.preventDefault();
        let desc = document.getElementById("revenu-description").value.trim();
        let mt = parseFloat(document.getElementById("revenu-montant").value);
        let ch = document.getElementById("revenu-chantier").checked;
        if (!desc || isNaN(mt) || mt <= 0) return;
        window.revenus.unshift({ description: desc, montant: mt, chantier: ch });
        saveFinance();
        renderRevenusList();
        renderFinanceSummary();
        this.reset();
      });
      
      document.getElementById("form-revenu-attente").addEventListener("submit", function (e) {
        e.preventDefault();
        let desc = document.getElementById("revenu-attente-description").value.trim();
        let mt = parseFloat(document.getElementById("revenu-attente-montant").value);
        if (!desc || isNaN(mt) || mt <= 0) return;
        window.revenusAttente.unshift({ description: desc, montant: mt, applique: false });
        saveFinance();
        renderRevenusAttenteList();
        renderFinanceSummary();
        this.reset();
      });
      
      document.getElementById("form-depense").addEventListener("submit", function (e) {
        e.preventDefault();
        let desc = document.getElementById("depense-description").value.trim();
        let mt = parseFloat(document.getElementById("depense-montant").value);
        if (!desc || isNaN(mt) || mt <= 0) return;
        window.depenses.unshift({ description: desc, montant: mt });
        saveFinance();
        renderDepensesList();
        renderFinanceSummary();
        this.reset();
      });
      
      document.getElementById("form-depense-prevue").addEventListener("submit", function (e) {
        e.preventDefault();
        let desc = document.getElementById("depense-prevue-description").value.trim();
        let mt = parseFloat(document.getElementById("depense-prevue-montant").value);
        if (!desc || isNaN(mt) || mt <= 0) return;
        window.depensesPrevues.unshift({ description: desc, montant: mt, applique: false });
        saveFinance();
        renderDepensesPrevuesList();
        renderPredictedFortune();
        renderFinanceSummary();
        this.reset();
      });
      
      document.getElementById("form-ouvrier").addEventListener("submit", function (e) {
        e.preventDefault();
        let n = document.getElementById("ouvrier-nom").value.trim();
        let t = parseFloat(document.getElementById("ouvrier-tarif").value);
        let j = parseFloat(document.getElementById("ouvrier-jours").value);
        if (!n || isNaN(t) || isNaN(j) || t <= 0 || j <= 0) return;
        window.ouvriers.unshift({ nom: n, tarif: t, jours: j, paye: false });
        saveOuvriers();
        renderOuvriers();
        window.baseOuvriers = window.ouvriers.slice();
        saveBaseOuvriers();
        renderBaseOuvriers();
        this.reset();
      });
      
      if(document.getElementById("btnAddCollaborateur"))
        document.getElementById("btnAddCollaborateur").addEventListener("click", function () { CollaborationModule.addCollaboratorRow(); });
      if(document.getElementById("btnCalcCollab"))
        document.getElementById("btnCalcCollab").addEventListener("click", function () { CollaborationModule.calculate(); });
      if(document.getElementById("btnAddAchat"))
        document.getElementById("btnAddAchat").addEventListener("click", ajouterAchat);
      if(document.getElementById("btnCreateGroup"))
        document.getElementById("btnCreateGroup").addEventListener("click", creerGroupeAchats);
      if(document.getElementById("toggle-groups"))
        document.getElementById("toggle-groups").addEventListener("click", toggleGroupedAchats);
      if(document.getElementById("btnCalculateProjet"))
        document.getElementById("btnCalculateProjet").addEventListener("click", calculateProjet);
      if(document.getElementById("projet-ajout-lien"))
        document.getElementById("projet-ajout-lien").addEventListener("change", function () { toggleLienProjet(); });
      if(document.getElementById("btnExportAll"))
        document.getElementById("btnExportAll").addEventListener("click", exportAllData);
      if(document.getElementById("btnImportAll"))
        document.getElementById("btnImportAll").addEventListener("click", importAllData);
      if(document.getElementById("import-file"))
        document.getElementById("import-file").addEventListener("change", handleImport);
      if(document.getElementById("btnClearAll"))
        document.getElementById("btnClearAll").addEventListener("click", clearAllData);
      if(document.getElementById("btnHelp"))
        document.getElementById("btnHelp").addEventListener("click", showHelp);
      if(document.getElementById("btnSummary"))
        document.getElementById("btnSummary").addEventListener("click", viewSummary);
      if(document.getElementById("toggle-backups-btn"))
        document.getElementById("toggle-backups-btn").addEventListener("click", toggleBackupList);
      if(document.getElementById("btnBackupSection"))
        document.getElementById("btnBackupSection").addEventListener("click", backupSection);
      if(document.getElementById("btnPerformBackup"))
        document.getElementById("btnPerformBackup").addEventListener("click", performBackup);
      if(document.getElementById("btnCancelBackup"))
        document.getElementById("btnCancelBackup").addEventListener("click", function () { toggleBackupInterface(); });
      if(document.getElementById("btnPrintReport"))
        document.getElementById("btnPrintReport").addEventListener("click", printReport);
      if(document.getElementById("btnCloseReport"))
        document.getElementById("btnCloseReport").addEventListener("click", closeReport);
      if(document.getElementById("btnCloseStepsModal"))
        document.getElementById("btnCloseStepsModal").addEventListener("click", closeStepsModal);
      
      refreshAll();
    });
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

  <script>
    /* ------------------------------
       Code de Conversion (inchang√©)
    ------------------------------ */
    document.addEventListener("DOMContentLoaded", function () {
      function setupConversion(buttonId, sourceTableId, targetTableId) {
        let button = document.getElementById(buttonId);
        if (!button) return;
        button.addEventListener("click", function () {
          let sourceTable = document.getElementById(sourceTableId);
          let targetTable = document.getElementById(targetTableId);
          if (!sourceTable || !targetTable) return;
          let sourceBody = sourceTable.getElementsByTagName("tbody")[0];
          let targetBody = targetTable.getElementsByTagName("tbody")[0];
          if (!sourceBody || !targetBody) return;
          let rows = Array.from(sourceBody.getElementsByTagName("tr"));
          rows.forEach(row => {
            let checkbox = row.querySelector("input[type='checkbox']");
            if (checkbox && checkbox.checked) {
              let clonedRow = row.cloneNode(true);
              clonedRow.querySelector("input[type='checkbox']").checked = false;
              targetBody.appendChild(clonedRow);
              row.remove();
            }
          });
          updateFinancialSummary();
        });
      }
      function updateFinancialSummary() {
        let totalRevenue = 0;
        let totalExpenses = 0;
        let revenueTable = document.getElementById("revenus-list");
        let expenseTable = document.getElementById("depenses-list");
        if (revenueTable) {
          let revenueRows = revenueTable.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
          totalRevenue = Array.from(revenueRows).reduce((sum, row) => {
            let amountCell = row.cells[1];
            return sum + (parseFloat(amountCell.textContent) || 0);
          }, 0);
        }
        if (expenseTable) {
          let expenseRows = expenseTable.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
          totalExpenses = Array.from(expenseRows).reduce((sum, row) => {
            let amountCell = row.cells[1];
            return sum + (parseFloat(amountCell.textContent) || 0);
          }, 0);
        }
        let summaryElement = document.getElementById("financial-summary");
        if (summaryElement) {
          summaryElement.textContent = "Total Revenus: " + totalRevenue.toFixed(2) + " ‚Ç¨ | Total D√©penses: " + totalExpenses.toFixed(2) + " ‚Ç¨";
        }
      }
      setupConversion("convert-revenue", "revenus-attente-list", "revenus-list");
      setupConversion("convert-expense", "depenses-prevues-list", "depenses-list");
    });
  
function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    loadBankAccounts();
});

function saveBankAccounts() {
    localStorage.setItem("bankAccounts", JSON.stringify(window.bankAccounts));
}

function loadBankAccounts() {
    let stored = localStorage.getItem("bankAccounts");
    if (stored) {
        window.bankAccounts = JSON.parse(stored);
    } else {
        // window.bankAccounts = []; // Pr√©servation des comptes existants
    }
    renderBankAccounts();
}

function renderBankAccounts() {
    let container = document.getElementById("accounts-grid");
    if (!container) return;
    container.innerHTML = "";
    window.bankAccounts.forEach(ac => {
        let card = document.createElement("div");
        card.classList.add("account-card", ac.type === "principal" ? "principal" : "secondaire");
        let cardInner = document.createElement("div");
        cardInner.classList.add("card-inner");

        let cardFront = document.createElement("div");
        cardFront.classList.add("card-front");
        let h3 = document.createElement("div");
        h3.className = "account-name";
        h3.textContent = ac.name;
        let bal = document.createElement("div");
        bal.className = "balance";
        bal.textContent = ac.balance.toFixed(2) + " ‚Ç¨";
        let lbl = document.createElement("div");
        lbl.className = "type-label";
        lbl.textContent = ac.type === "principal" ? "Compte Principal" : "Compte Secondaire";

        cardFront.append(h3, bal, lbl);
        
        let cardBack = document.createElement("div");
        cardBack.classList.add("card-back");

        let btnVirement = document.createElement("button");
        btnVirement.textContent = "Virement";
        btnVirement.style.margin = "5px";
        btnVirement.onclick = function(e) {
            e.stopPropagation();
            handleVirement(ac.id);
        };

        let btnDepense = document.createElement("button");
        btnDepense.textContent = "D√©pense";
        btnDepense.style.margin = "5px";
        btnDepense.onclick = function(e) {
            e.stopPropagation();
            handleDepense(ac.id);
        };

        cardBack.appendChild(btnVirement);
        cardBack.appendChild(btnDepense);

        cardInner.append(cardFront, cardBack);
        card.appendChild(cardInner);
        card.addEventListener("click", () => {
            card.classList.toggle("flip");
        });
        container.appendChild(card);
    });
}

function handleVirement(fromId) {
    let amount = parseFloat(prompt("Montant du virement :"));
    if (isNaN(amount) || amount <= 0) return;
    let fromAcc = window.bankAccounts.find(a => a.id === fromId);
    if (!fromAcc) {
        alert("Compte introuvable.");
        return;
    }
    if (fromAcc.balance < amount) {
        alert("Solde insuffisant.");
        return;
    }
    let toId = prompt("ID du compte destinataire :");
    let toAcc = window.bankAccounts.find(a => a.id === toId);
    if (!toAcc) {
        alert("Compte destinataire introuvable.");
        return;
    }
    fromAcc.balance -= amount;
    toAcc.balance += amount;
    saveBankAccounts();
    renderBankAccounts();
}

function handleDepense(fromId) {
    let amount = parseFloat(prompt("Montant de la d√©pense :"));
    if (isNaN(amount) || amount <= 0) return;
    let fromAcc = window.bankAccounts.find(a => a.id === fromId);
    if (!fromAcc) {
        alert("Compte introuvable.");
        return;
    }
    if (fromAcc.balance < amount) {
        alert("Solde insuffisant.");
        return;
    }
    fromAcc.balance -= amount;
    saveBankAccounts();
    renderBankAccounts();
}

function createBankAccount(e) {
    e.preventDefault();
    let name = document.getElementById("new-account-name").value.trim();
    let type = document.getElementById("new-account-type").value;
    if (!name) return;
    let newId = "compte" + Date.now();
    let newAcc = { id: newId, name: name, balance: 0, type: type };
    window.bankAccounts.push(newAcc);
    saveBankAccounts();
    renderBankAccounts();
}

function deleteBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let idx = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (idx === -1) {
        alert("Compte introuvable.");
        return;
    }
    if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[idx].name + " ?")) {
        window.bankAccounts.splice(idx, 1);
        saveBankAccounts();
        renderBankAccounts();
    }
}

</script>

</body>
</html>
<script>
  let backups = [];
  let historyLog = [];

  function exportAllData() {
    let data = JSON.stringify({
      finance: window.finance || [],
      ouvriers: window.ouvriers || [],
      chantiers: window.chantiers || [],
      projets: window.projets || [],
    });
    let blob = new Blob([data], { type: "application/json" });
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup.json";
    a.click();
  }

  function importAllData(event) {
    let file = event.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
      let importedData = JSON.parse(e.target.result);
      window.finance = importedData.finance || [];
      window.ouvriers = importedData.ouvriers || [];
      window.chantiers = importedData.chantiers || [];
      window.projets = importedData.projets || [];
      alert("Donn√©es import√©es avec succ√®s !");
    };
    reader.readAsText(file);
  }

  function showSaveSectionModal() {
    let section = prompt("Quelle section voulez-vous sauvegarder ? (finance, ouvriers, chantiers, projets)");
    if (section && window[section]) {
      backups.push({ section, data: JSON.stringify(window[section]) });
      alert("Sauvegarde effectu√©e !");
    } else {
      alert("Section invalide !");
    }
  }

  function showResetSectionModal() {
  let section = prompt("Quelle section voulez-vous r√©initialiser ? (finance, ouvriers, chantiers, projets)");
  if (section && window[section]) {
    // Vider la variable globale
    window[section] = [];
    // Supprimer les donn√©es enregistr√©es dans le localStorage selon la section
    switch (section) {
      case "finance":
        localStorage.removeItem("gestion_revenus");
        localStorage.removeItem("gestion_depenses");
        localStorage.removeItem("gestion_depenses_prevues");
        break;
      case "ouvriers":
        localStorage.removeItem("gestion_ouvriers");
        localStorage.removeItem("baseouvriers");
        break;
      case "chantiers":
        localStorage.removeItem("gestion_chantiers");
        localStorage.removeItem("travaux_finiss");
        break;
      case "projets":
        localStorage.removeItem("gestion_projets");
        break;
      default:
        alert("Section invalide !");
        return;
    }
    alert("Section r√©initialis√©e !");
    // Option 1 : Rafra√Æchir l'affichage via votre fonction refreshAll() si elle est bien d√©finie
    if (typeof refreshAll === "function") {
      refreshAll();
    }
    // Option 2 (alternatif) : Recharger compl√®tement la page pour √™tre certain que les anciennes donn√©es ne s'affichent plus
    location.reload();
  } else {
    alert("Section invalide !");
  }
}

  function toggleBackupList() {
    let listContainer = document.getElementById("backups-list");
    if (!listContainer) return;
    
    if (backups.length === 0) {
      listContainer.innerHTML = "<p>Aucune sauvegarde disponible.</p>";
    } else {
      listContainer.innerHTML = "<h3>Liste des sauvegardes</h3><ul>" +
        backups.map((b, index) => `<li>${b.section} <button onclick="restoreBackup(${index})">Restaurer</button></li>`).join("") +
        "</ul>";
    }
    listContainer.style.display = listContainer.style.display === "none" ? "block" : "none";
  }

  function restoreBackup(index) {
    let backup = backups[index];
    if (backup) {
      window[backup.section] = JSON.parse(backup.data);
      alert("Sauvegarde restaur√©e !");
    }
  }

  function showHistory() {
    let historyContainer = document.getElementById("backups-list");
    if (!historyContainer) return;
    
    if (historyLog.length === 0) {
      historyContainer.innerHTML = "<p>Aucun historique disponible.</p>";
    } else {
      historyContainer.innerHTML = "<h3>Historique des actions</h3><ul>" +
        historyLog.map(log => `<li>${log}</li>`).join("") +
        "</ul>";
    }
    historyContainer.style.display = historyContainer.style.display === "none" ? "block" : "none";
  }

  function showScheduleBackupModal() {
    let date = prompt("Entrez la date de sauvegarde (AAAA-MM-JJ) :");
    let section = prompt("Quelle section voulez-vous sauvegarder automatiquement ? (finance, ouvriers, chantiers, projets)");
    if (date && section && window[section]) {
      setTimeout(() => {
        backups.push({ section, data: JSON.stringify(window[section]), date });
        alert("Sauvegarde planifi√©e pour " + date);
      }, 2000);
    } else {
      alert("Donn√©es invalides !");
    }
  }

  function resetAllData() {
    if (confirm("√ätes-vous s√ªr de vouloir tout r√©initialiser ? Cette action est irr√©versible !")) {
      window.finance = [];
      window.ouvriers = [];
      window.chantiers = [];
      window.projets = [];
      backups = [];
      alert("Toutes les donn√©es ont √©t√© r√©initialis√©es !");
    }
  }

function resetBankAccounts() {
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨.");
}


function resetBankAccounts() {
    // Suppression compl√®te du stockage local
    // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es

    // Remettre √† z√©ro tous les comptes existants
    window.bankAccounts.forEach(acc => acc.balance = 0);

    // Sauvegarde de l'√©tat r√©initialis√©
    saveBankAccounts();

    // Rafra√Æchir l'affichage des comptes
    renderBankAccounts();

    alert("Tous les comptes bancaires ont √©t√© r√©initialis√©s √† 0‚Ç¨ et la m√©moire locale a √©t√© nettoy√©e.");
}

// Appliquer la suppression des vieilles sauvegardes √† l'initialisation


function resetAllBankAccounts() {
    window.bankAccounts.forEach(acc => acc.balance = 0);
    saveBankAccounts();
    renderBankAccounts();
    alert("Toutes les cartes bancaires ont √©t√© r√©initialis√©es √† 0‚Ç¨.");
}

function resetSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† r√©initialiser :");
    let account = window.bankAccounts.find(acc => acc.id === accountId);
    if (account) {
        account.balance = 0;
        saveBankAccounts();
        renderBankAccounts();
        alert("Le compte " + account.name + " a √©t√© r√©initialis√© √† 0‚Ç¨.");
    } else {
        alert("Compte introuvable.");
    }
}

function resetBankingSection() {
    if (confirm("Voulez-vous vraiment r√©initialiser toute la section bancaire ? Cette action est irr√©versible.")) {
        // localStorage.removeItem("bankAccounts"); // Suppression d√©sactiv√©e pour √©viter la perte de donn√©es
        // window.bankAccounts = []; // Pr√©servation des comptes existants
        saveBankAccounts();
        renderBankAccounts();
        alert("Toute la section bancaire a √©t√© r√©initialis√©e.");
    }
}

function deleteSpecificBankAccount() {
    let accountId = prompt("Entrez l'ID du compte √† supprimer :");
    let index = window.bankAccounts.findIndex(acc => acc.id === accountId);
    if (index !== -1) {
        if (confirm("Voulez-vous vraiment supprimer " + window.bankAccounts[index].name + " ?")) {
            window.bankAccounts.splice(index, 1);
            saveBankAccounts();
            renderBankAccounts();
            alert("Compte supprim√© avec succ√®s.");
        }
    } else {
        alert("Compte introuvable.");
    }
}

</script>






