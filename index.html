<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Koloral Sheqiri ‚Äì Gestion d'Entreprise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Manifest (assurez-vous que le fichier manifest.json existe) -->
  <link rel="manifest" href="manifest.json">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Styles g√©n√©raux */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
      color: #333;
      overflow-x: hidden;
    }
    header {
      background: linear-gradient(135deg, #005f73, #0a9396);
      color: #fff;
      text-align: center;
      padding: 1rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    header h1 { margin: 0; font-size: 1.8em; }
    /* Navigation via liste d√©roulante (au-dessous de l'en‚Äët√™te) */
    #nav-dropdown {
      margin-top: 70px;
      font-size: 1em;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      outline: none;
      display: block;
      width: 90%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    /* Menu d√©roulant pour ajustements rapides (achat/d√©pense) */
    .quick-menu {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #fff;
      color: #005f73;
      border: 1px solid #005f73;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .quick-menu-container {
      position: fixed;
      top: 50px;
      right: 10px;
      background: #fff;
      border: 1px solid #005f73;
      border-radius: 4px;
      display: none;
      z-index: 1001;
    }
    .quick-menu-container button {
      display: block;
      padding: 8px 12px;
      border: none;
      border-bottom: 1px solid #005f73;
      background: #fff;
      color: #005f73;
      font-size: 0.9em;
      cursor: pointer;
      text-align: left;
    }
    .quick-menu-container button:last-child { border-bottom: none; }
    .quick-menu-container button:hover {
      background: #005f73;
      color: #fff;
    }
    /* Conteneur principal (espace sous header et dropdown) */
    #main-content {
      padding-top: 140px;
      min-height: calc(100vh - 140px);
    }
    /* Chaque section repr√©sente une ‚Äúpage‚Äù */
    .section {
      display: none;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      margin: 10px auto;
      max-width: 800px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .section.active { display: block; }
    /* Formulaires, tables et boutons (extraits de vos styles pr√©c√©dents) */
    form input, form select, form button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    form button {
      background: #005f73;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    form button:hover { background: #0a9396; }
    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td { border: 1px solid #ddd; }
    th, td {
      padding: 10px;
      text-align: left;
      font-size: 0.95em;
    }
    th { background: #005f73; color: #fff; }
    .action-btn {
      padding: 6px 8px;
      background: #005f73;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 5px;
      font-size: 0.85em;
      transition: background 0.3s;
    }
    .action-btn:hover { background: #0a9396; }
    /* Barre de progression */
    .progress-container {
      width: 100%;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 8px;
      height: 18px;
    }
    .progress-bar {
      height: 100%;
      background: #005f73;
      width: 0%;
      border-radius: 4px;
      transition: width 0.3s;
    }
    /* Options suppl√©mentaires avec ic√¥nes */
    .options-list {
      list-style: none;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .options-list li {
      flex: 1 1 calc(50% - 10px);
      background: #005f73;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85em;
      font-weight: bold;
    }
    .options-list li:hover { background: #0a9396; }
    .option-icon { font-size: 1.2em; }
    /* Footer fixe */
    footer {
      text-align: center;
      padding: 1rem;
      background: #005f73;
      color: #fff;
      position: fixed;
      width: 100%;
      bottom: 0;
      left: 0;
      z-index: 1000;
    }
    /* Adaptation smartphone */
    @media (max-width: 600px) {
      header h1 { font-size: 1.5em; }
      #nav-dropdown { width: 95%; }
      .section { margin: 10px; padding: 10px; }
      .options-list li { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <!-- En-t√™te fixe -->
  <header>
    <h1>Koloral Sheqiri</h1>
    <!-- Bouton d'acc√®s au menu rapide pour ajustements d'achat/d√©pense -->
    <div class="quick-menu" id="quick-menu-btn">‚Ç¨ D√©penses</div>
    <!-- Menu d√©roulant pour les ajustements rapides -->
    <div class="quick-menu-container" id="quick-menu">
      <button onclick="ajusterDepense(-20)">-20 ‚Ç¨</button>
      <button onclick="ajusterDepense(-50)">-50 ‚Ç¨</button>
      <button onclick="ajusterDepense(-100)">-100 ‚Ç¨</button>
      <button onclick="ajusterDepense(50)">+50 ‚Ç¨</button>
      <button onclick="ajusterDepense(100)">+100 ‚Ç¨</button>
    </div>
  </header>
  
  <!-- Navigation principale via liste d√©roulante -->
  <div style="margin-top: 70px; text-align: center;">
    <select id="nav-dropdown" onchange="showSection(this.value)">
      <option value="ouvriers">Ouvriers</option>
      <option value="baseouvriers">Base Ouvriers</option>
      <option value="chantier">Chantiers</option>
      <option value="basechantier">Base Chantiers</option>
      <option value="finance">Finance</option>
      <option value="projet">Projet</option>
      <option value="plusoptions">Plus d‚ÄôOptions</option>
      <option value="siteweb">Site Web</option>
      <option value="utilitaires">Utilitaires</option>
    </select>
  </div>
  
  <!-- Contenu principal -->
  <div id="main-content">
    <!-- Section Ouvriers -->
    <section id="ouvriers" class="section active">
      <h2>Ouvriers</h2>
      <form id="form-ouvrier">
        <select id="ouvrier-select">
          <option value="">S√©lectionner un ouvrier (facultatif)</option>
        </select>
        <input type="text" id="ouvrier-nom" placeholder="Nom de l'ouvrier">
        <input type="number" id="ouvrier-tarif" placeholder="Prix √† la journ√©e (‚Ç¨)" step="0.01" required>
        <input type="number" id="ouvrier-jours" placeholder="Temps de travail (en jours)" step="0.1" required>
        <button type="submit">Enregistrer / Mettre √† jour</button>
      </form>
      <div class="table-container">
        <table id="table-ouvriers">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Prix/jour</th>
              <th>Jours</th>
              <th>Total</th>
              <th>Pay√©</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Section Base Ouvriers -->
    <section id="baseouvriers" class="section">
      <h2>Base Ouvriers</h2>
      <p>Liste des ouvriers enregistr√©s.</p>
      <div class="table-container">
        <table id="table-baseouvriers">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Jours Totaux</th>
              <th>Montant Total (‚Ç¨)</th>
              <th>Montant Pay√© (‚Ç¨)</th>
              <th>Montant D√ª (‚Ç¨)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Section Chantiers -->
    <section id="chantier" class="section">
      <h2>Chantiers</h2>
      <form id="form-chantier">
        <input type="text" id="chantier-nom" placeholder="Nom du chantier" required>
        <input type="number" id="chantier-duree" placeholder="Dur√©e (en jours)" step="1" required>
        <input type="number" id="chantier-prix" placeholder="Prix du chantier (‚Ç¨)" step="0.01" required>
        <input type="number" id="chantier-materiel" placeholder="Co√ªt des mat√©riaux (‚Ç¨)" step="0.01" required>
        <label><input type="checkbox" id="chantier-mat-payee"> Mat√©riaux pay√©s</label>
        <h3>√âtapes du Chantier</h3>
        <div id="etapes-container"></div>
        <div style="display: flex; gap: 5px; margin-top: 8px;">
          <input type="text" id="etape-input" placeholder="Description de l'√©tape">
          <button type="button" onclick="addEtape()">Ajouter √©tape</button>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <button type="submit">Enregistrer chantier</button>
      </form>
      <div id="chantier-workers"></div>
      <div class="table-container">
        <table id="table-chantier">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Dur√©e</th>
              <th>Prix</th>
              <th>Mat√©riaux</th>
              <th>Avancement</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Section Base Chantiers -->
    <section id="basechantier" class="section">
      <h2>Base Chantiers</h2>
      <p>Affichage des chantiers actifs et des travaux termin√©s.</p>
      <h3>Chantiers Actifs</h3>
      <div class="table-container">
        <table id="table-base-chantier-actif">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Dur√©e</th>
              <th>Prix</th>
              <th>Avancement</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <h3>Travaux Termin√©s</h3>
      <div class="table-container">
        <table id="table-base-chantier-fini">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Dur√©e</th>
              <th>Prix</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Section Finance -->
    <section id="finance" class="section">
      <h2>Finance</h2>
      <!-- Revenus Manuels -->
      <div>
        <h3>Revenus Manuels</h3>
        <form id="form-revenu">
          <input type="text" id="revenu-description" placeholder="Description du revenu" required>
          <input type="number" id="revenu-montant" placeholder="Montant (‚Ç¨)" step="0.01" required>
          <button type="submit">Ajouter revenu</button>
        </form>
        <div id="revenus-list"></div>
      </div>
      <!-- Revenus en Attente -->
      <div>
        <h3>Revenus en Attente</h3>
        <form id="form-revenu-attente">
          <input type="text" id="revenu-attente-description" placeholder="Description du revenu en attente" required>
          <input type="number" id="revenu-attente-montant" placeholder="Montant (‚Ç¨)" step="0.01" required>
          <button type="submit">Ajouter revenu en attente</button>
        </form>
        <div id="revenus-attente-list"></div>
      </div>
      <!-- D√©penses Manuelles -->
      <div>
        <h3>D√©penses Manuelles</h3>
        <form id="form-depense">
          <input type="text" id="depense-description" placeholder="Description de la d√©pense" required>
          <input type="number" id="depense-montant" placeholder="Montant (‚Ç¨)" step="0.01" required>
          <button type="submit">Ajouter d√©pense</button>
        </form>
        <div id="depenses-list"></div>
      </div>
      <!-- D√©penses Pr√©vues -->
      <div>
        <h3>D√©penses Pr√©vues</h3>
        <form id="form-depense-prevue">
          <input type="text" id="depense-prevue-description" placeholder="Description de la d√©pense pr√©vue" required>
          <input type="number" id="depense-prevue-montant" placeholder="Montant pr√©vu (‚Ç¨)" step="0.01" required>
          <button type="submit">Ajouter d√©pense pr√©vue</button>
        </form>
        <div id="depenses-prevues-list"></div>
      </div>
      <!-- R√©capitulatif Finance -->
      <div id="finance-summary">
        <p id="manual-revenus">Revenus manuels : 0 ‚Ç¨</p>
        <p id="revenus-attente">Revenus en attente : 0 ‚Ç¨</p>
        <p id="manual-depenses">D√©penses manuelles : 0 ‚Ç¨</p>
        <p id="depenses-prevues">D√©penses pr√©vues : 0 ‚Ç¨</p>
        <p id="global-balance">Solde global : 0 ‚Ç¨</p>
      </div>
    </section>

    <!-- Section Projet -->
    <section id="projet" class="section">
      <h2>Projet</h2>
      <form id="form-projet">
        <input type="text" id="projet-nom" placeholder="Nom du projet" required>
        <input type="number" id="projet-prix" placeholder="Budget total (‚Ç¨)" step="0.01" required>
        <label>
          <input type="checkbox" id="projet-ajout-lien" onchange="toggleLienProjet()"> Ajouter un lien
        </label>
        <input type="url" id="projet-lien" placeholder="URL du projet" style="display:none;">
        <input type="number" id="projet-duree" placeholder="Dur√©e souhait√©e (mois)" step="1" required>
        <label>
          <input type="checkbox" id="projet-mode-inverse"> Mode Inverse (budget mensuel)
        </label>
        <input type="number" id="projet-mensuel" placeholder="Budget mensuel (‚Ç¨)" step="0.01">
        <input type="number" id="projet-mois-objectif" placeholder="Mois jusqu'√† l'objectif" step="1">
        <select id="projet-priorite">
          <option value="1">Priorit√© 1 (Haute)</option>
          <option value="2">Priorit√© 2</option>
          <option value="3">Priorit√© 3 (Normale)</option>
          <option value="4">Priorit√© 4</option>
          <option value="5">Priorit√© 5 (Basse)</option>
        </select>
        <button type="button" onclick="calculateProjet()">Calculer Projet</button>
      </form>
      <div id="projet-achats">
        <h3>Liste d'Achats</h3>
        <form id="form-achat">
          <input type="text" id="achat-nom" placeholder="Nom de l'article">
          <input type="number" id="achat-prix" placeholder="Prix (‚Ç¨)" step="0.01">
          <input type="number" id="achat-priorite" placeholder="Priorit√© (1,2,3...)" step="1">
          <button type="button" onclick="ajouterAchat()">Ajouter √† la liste</button>
        </form>
        <div class="table-container">
          <table id="table-achats">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Prix</th>
                <th>Priorit√©</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div id="projet-resultat"></div>
    </section>

    <!-- Section Plus d'Options -->
    <section id="plusoptions" class="section">
      <h2>Plus d'Options</h2>
      <ul class="options-list">
        <li onclick="calculerMargeBeneficiaire()"><span class="option-icon">üìä</span><span class="option-label">Marge B√©n√©f.</span></li>
        <li onclick="previsionTresorerie()"><span class="option-icon">üí∞</span><span class="option-label">Tr√©sorerie</span></li>
        <li onclick="analyserRentabiliteProjet()"><span class="option-icon">üìà</span><span class="option-label">ROI Projet</span></li>
        <li onclick="genererEcheancier()"><span class="option-icon">üóìÔ∏è</span><span class="option-label">√âch√©ancier</span></li>
        <li onclick="comparerCouts()"><span class="option-icon">‚öñÔ∏è</span><span class="option-label">Comparer Co√ªts</span></li>
        <li onclick="planifierTaches()"><span class="option-icon">üìù</span><span class="option-label">Planifier T√¢ches</span></li>
        <li onclick="simulerInvestissement()"><span class="option-icon">üíπ</span><span class="option-label">Investissement</span></li>
        <li onclick="calculerTVAAvance()"><span class="option-icon">üßæ</span><span class="option-label">Calcul TVA</span></li>
        <li onclick="genererRapportPersonnalise()"><span class="option-icon">üì∞</span><span class="option-label">Rapport Perso</span></li>
        <li onclick="analyserPerformanceOuvriers()"><span class="option-icon">üè≠</span><span class="option-label">Perf. Ouvriers</span></li>
        <li onclick="calculerChiffreAffaires()"><span class="option-icon">üíµ</span><span class="option-label">Chiffre d'Aff.</span></li>
        <li onclick="afficherHistoriqueTravaux()"><span class="option-icon">üìö</span><span class="option-label">Hist. Travaux</span></li>
        <li onclick="analyserAvancee()"><span class="option-icon">üîç</span><span class="option-label">Analyse Avanc√©e</span></li>
      </ul>
      <div id="plusoptions-output"></div>
    </section>

    <!-- Section Site Web -->
    <section id="siteweb" class="section">
      <h2>Site Web</h2>
      <p>Acc√©dez aux sites partenaires :</p>
      <ul>
        <li><a href="https://koloral.fr" target="_blank">Koloral.fr</a></li>
        <li><a href="https://hostinger.com" target="_blank">Hostinger</a></li>
      </ul>
    </section>

    <!-- Section Utilitaires -->
    <section id="utilitaires" class="section">
      <h2>Utilitaires</h2>
      <button class="extra-btn" onclick="exportAllData()">Exporter donn√©es (JSON)</button>
      <button class="extra-btn" onclick="importAllData()">Importer donn√©es (JSON)</button>
      <input type="file" id="import-file" accept="application/json" style="display:none" onchange="handleImport(event)">
      <button class="extra-btn" onclick="clearAllData()">Tout r√©initialiser</button>
      <button class="extra-btn" onclick="showHelp()">Afficher aide</button>
      <button class="extra-btn" onclick="viewSummary()">Afficher Synth√®se</button>
    </section>
  </div>

  <!-- Footer fixe -->
  <footer>
    <p>&copy; 2025 Koloral Sheqiri</p>
  </footer>

  <!-- Script JavaScript regroupant toutes les fonctions -->
  <script>
    /* --- Navigation par sections via le dropdown --- */
    function showSection(sectionId) {
      const sections = document.querySelectorAll('.section');
      sections.forEach(sec => sec.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      window.scrollTo(0, 0);
    }
    
    /* --- Quick Menu pour ajustements rapides d'achat/d√©pense --- */
    const quickBtn = document.getElementById('quick-menu-btn');
    const quickMenu = document.getElementById('quick-menu');
    quickBtn.addEventListener('click', (e) => {
      quickMenu.style.display = (quickMenu.style.display === "block") ? "none" : "block";
      e.stopPropagation();
    });
    document.addEventListener('click', () => {
      quickMenu.style.display = "none";
    });
    function ajusterDepense(valeur) {
      // Pour cet exemple, on ajoute simplement une d√©pense dans la section Finance
      depenses.push({ description: "D√©pense rapide (" + valeur + "‚Ç¨)", amount: Math.abs(valeur) });
      saveFinance();
      renderFinanceSummary();
      renderDepenses();
      alert("D√©pense de " + valeur + "‚Ç¨ enregistr√©e.");
    }
    
    /* --- Ouvriers --- */
    let ouvriers = JSON.parse(localStorage.getItem('gestion_ouvriers')) || [];
    function saveOuvriers() { localStorage.setItem('gestion_ouvriers', JSON.stringify(ouvriers)); }
    function renderOuvriers() {
      const tbody = document.querySelector('#table-ouvriers tbody');
      tbody.innerHTML = '';
      ouvriers.forEach(o => {
        const total = o.tarif * o.jours;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.nom}</td>
          <td>${o.tarif.toFixed(2)} ‚Ç¨</td>
          <td>${o.jours.toFixed(1)}</td>
          <td>${total.toFixed(2)} ‚Ç¨</td>
          <td><input type="checkbox" ${o.paye ? 'checked' : ''} onchange="toggleOuvrierPay('${o.nom}')"></td>
          <td>
            <button class="action-btn" onclick="editOuvrier('${o.nom}')">Modifier</button>
            <button class="action-btn" onclick="deleteOuvrier('${o.nom}')">Supprimer</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function toggleOuvrierPay(nom) {
      const index = ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
      if(index !== -1) {
        ouvriers[index].paye = !ouvriers[index].paye;
        saveOuvriers();
        renderOuvriers();
      }
    }
    function deleteOuvrier(nom) {
      if(confirm("Supprimer l'ouvrier " + nom + " ?")) {
        ouvriers = ouvriers.filter(o => o.nom.toLowerCase() !== nom.toLowerCase());
        saveOuvriers();
        renderOuvriers();
      }
    }
    function editOuvrier(nom) {
      const index = ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
      if(index !== -1) {
        const newTarif = prompt("Modifier le tarif pour " + nom + " :", ouvriers[index].tarif);
        const newJours = prompt("Modifier le nombre de jours pour " + nom + " :", ouvriers[index].jours);
        if(newTarif !== null && newJours !== null) {
          ouvriers[index].tarif = parseFloat(newTarif) || ouvriers[index].tarif;
          ouvriers[index].jours = parseFloat(newJours) || ouvriers[index].jours;
          saveOuvriers();
          renderOuvriers();
        }
      }
    }
    document.getElementById('form-ouvrier').addEventListener('submit', function(e) {
      e.preventDefault();
      let nom = document.getElementById('ouvrier-nom').value.trim();
      const select = document.getElementById('ouvrier-select');
      if(select.value && !nom) { nom = select.value; }
      const tarif = parseFloat(document.getElementById('ouvrier-tarif').value);
      const jours = parseFloat(document.getElementById('ouvrier-jours').value);
      if(nom && !isNaN(tarif) && !isNaN(jours)) {
        const index = ouvriers.findIndex(o => o.nom.toLowerCase() === nom.toLowerCase());
        if(index !== -1) {
          ouvriers[index].jours += jours;
          ouvriers[index].tarif = tarif;
        } else {
          ouvriers.push({ nom, tarif, jours, paye: false });
        }
        saveOuvriers();
        renderOuvriers();
        this.reset();
      }
    });
    function populateOuvrierSelect() {
      const select = document.getElementById('ouvrier-select');
      select.innerHTML = '<option value="">S√©lectionner un ouvrier (facultatif)</option>';
      ouvriers.forEach(o => {
        select.innerHTML += `<option value="${o.nom}">${o.nom}</option>`;
      });
    }
    renderOuvriers();
    populateOuvrierSelect();

    /* --- Chantiers --- */
    let chantiers = JSON.parse(localStorage.getItem('gestion_chantiers')) || [];
    let travauxFinis = JSON.parse(localStorage.getItem('travaux_finiss')) || [];
    let currentEtapes = [];
    function saveChantiers() { localStorage.setItem('gestion_chantiers', JSON.stringify(chantiers)); }
    function saveTravauxFinis() { localStorage.setItem('travaux_finiss', JSON.stringify(travauxFinis)); }
    function addEtape() {
      const etapeInput = document.getElementById('etape-input');
      const desc = etapeInput.value.trim();
      if(desc === "") return;
      currentEtapes.push({ description: desc, done: false });
      etapeInput.value = "";
      renderEtapes();
    }
    function renderEtapes() {
      const container = document.getElementById('etapes-container');
      container.innerHTML = "";
      currentEtapes.forEach((etape, index) => {
        container.innerHTML += `
          <div style="margin-bottom:5px; border:1px solid #ccc; padding:4px; border-radius:4px;">
            <label>
              <input type="checkbox" onchange="toggleEtape(${index})" ${etape.done ? "checked" : ""}>
              ${etape.description}
            </label>
          </div>`;
      });
      const progress = updateChantierProgress(currentEtapes);
      document.getElementById('progress-bar').style.width = progress + "%";
    }
    function toggleEtape(index) {
      currentEtapes[index].done = !currentEtapes[index].done;
      renderEtapes();
    }
    function updateChantierProgress(etapes) {
      if(!etapes || etapes.length === 0) return 0;
      const completed = etapes.filter(e => e.done).length;
      return (completed / etapes.length) * 100;
    }
    document.getElementById('form-chantier').addEventListener('submit', function(e) {
      e.preventDefault();
      const nom = document.getElementById('chantier-nom').value.trim();
      const duree = parseFloat(document.getElementById('chantier-duree').value);
      const prix = parseFloat(document.getElementById('chantier-prix').value);
      const materiel = parseFloat(document.getElementById('chantier-materiel').value);
      const matPayee = document.getElementById('chantier-mat-payee').checked;
      if(nom && !isNaN(duree) && !isNaN(prix) && !isNaN(materiel)) {
        const chantier = {
          nom, duree, prix, materiel, matPayee,
          workerIds: [],
          etapes: currentEtapes.slice(),
          progress: updateChantierProgress(currentEtapes)
        };
        chantiers.push(chantier);
        saveChantiers();
        renderChantiers();
        this.reset();
        currentEtapes = [];
        renderEtapes();
      }
    });
    function renderChantiers() {
      const tbody = document.querySelector('#table-chantier tbody');
      tbody.innerHTML = '';
      chantiers.forEach((c, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.nom}</td>
          <td>${c.duree} j</td>
          <td>${c.prix.toFixed(2)} ‚Ç¨</td>
          <td>${c.materiel.toFixed(2)} ‚Ç¨</td>
          <td>${c.progress.toFixed(0)} %</td>
          <td>
            <button class="action-btn" onclick="editChantier(${idx})">Modifier</button>
            <button class="action-btn" onclick="deleteChantier(${idx})">Supprimer</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function editChantier(index) {
      const chantier = chantiers[index];
      const newNom = prompt("Modifier le nom du chantier :", chantier.nom);
      if(newNom !== null) { chantier.nom = newNom.trim() || chantier.nom; }
      saveChantiers();
      renderChantiers();
    }
    function deleteChantier(index) {
      if(confirm("Supprimer le chantier " + chantiers[index].nom + " ?")) {
        chantiers.splice(index, 1);
        saveChantiers();
        renderChantiers();
      }
    }
    renderChantiers();

    /* --- Base Chantiers --- */
    function renderBaseChantiers() {
      const tbodyActif = document.querySelector('#table-base-chantier-actif tbody');
      tbodyActif.innerHTML = '';
      chantiers.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.nom}</td><td>${c.duree} j</td><td>${c.prix.toFixed(2)} ‚Ç¨</td><td>${c.progress.toFixed(0)} %</td>`;
        tbodyActif.appendChild(tr);
      });
      const tbodyFini = document.querySelector('#table-base-chantier-fini tbody');
      tbodyFini.innerHTML = '';
      travauxFinis.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.nom}</td><td>${c.duree} j</td><td>${c.prix.toFixed(2)} ‚Ç¨</td>`;
        tbodyFini.appendChild(tr);
      });
    }

    /* --- Finance --- */
    let revenus = JSON.parse(localStorage.getItem('gestion_revenus')) || [];
    let depenses = JSON.parse(localStorage.getItem('gestion_depenses')) || [];
    let depensesPrevues = JSON.parse(localStorage.getItem('gestion_depenses_prevues')) || [];
    let revenusAttente = [];
    function saveFinance() {
      localStorage.setItem('gestion_revenus', JSON.stringify(revenus));
      localStorage.setItem('gestion_depenses', JSON.stringify(depenses));
      localStorage.setItem('gestion_depenses_prevues', JSON.stringify(depensesPrevues));
    }
    document.getElementById('form-revenu').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('revenu-description').value.trim();
      const amount = parseFloat(document.getElementById('revenu-montant').value);
      if(description && !isNaN(amount)) {
        revenus.push({ description, amount });
        saveFinance();
        renderFinanceSummary();
        renderRevenus();
        this.reset();
      }
    });
    document.getElementById('form-revenu-attente').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('revenu-attente-description').value.trim();
      const amount = parseFloat(document.getElementById('revenu-attente-montant').value);
      if(description && !isNaN(amount)) {
        revenusAttente.push({ description, amount });
        renderFinanceSummary();
        renderRevenusAttente();
        this.reset();
      }
    });
    document.getElementById('form-depense').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('depense-description').value.trim();
      const amount = parseFloat(document.getElementById('depense-montant').value);
      if(description && !isNaN(amount)) {
        depenses.push({ description, amount });
        saveFinance();
        renderFinanceSummary();
        renderDepenses();
        this.reset();
      }
    });
    document.getElementById('form-depense-prevue').addEventListener('submit', function(e) {
      e.preventDefault();
      const description = document.getElementById('depense-prevue-description').value.trim();
      const amount = parseFloat(document.getElementById('depense-prevue-montant').value);
      if(description && !isNaN(amount)) {
        depensesPrevues.push({ description, amount });
        saveFinance();
        renderFinanceSummary();
        renderDepensesPrevues();
        this.reset();
      }
    });
    function renderFinanceSummary() {
      const totalRevenus = revenus.reduce((sum, r) => sum + r.amount, 0);
      const totalRevenusAttente = revenusAttente.reduce((sum, r) => sum + r.amount, 0);
      const totalDepenses = depenses.reduce((sum, d) => sum + d.amount, 0);
      const totalDepensesPrevues = depensesPrevues.reduce((sum, d) => sum + d.amount, 0);
      const net = totalRevenus + totalRevenusAttente - totalDepenses;
      document.getElementById('manual-revenus').innerText = "Revenus manuels : " + totalRevenus.toFixed(2) + " ‚Ç¨";
      document.getElementById('revenus-attente').innerText = "Revenus en attente : " + totalRevenusAttente.toFixed(2) + " ‚Ç¨";
      document.getElementById('manual-depenses').innerText = "D√©penses manuelles : " + totalDepenses.toFixed(2) + " ‚Ç¨";
      document.getElementById('depenses-prevues').innerText = "D√©penses pr√©vues : " + totalDepensesPrevues.toFixed(2) + " ‚Ç¨";
      document.getElementById('global-balance').innerText = "Solde global : " + net.toFixed(2) + " ‚Ç¨";
    }
    function renderRevenus() {
      const container = document.getElementById('revenus-list');
      if(revenus.length === 0) { container.innerHTML = "<p>Aucun revenu enregistr√©.</p>"; return; }
      let html = `<table>
                    <thead>
                      <tr>
                        <th>Description</th>
                        <th>Montant</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>`;
      revenus.forEach((r, idx) => {
        html += `<tr>
                   <td>${r.description}</td>
                   <td>${r.amount.toFixed(2)} ‚Ç¨</td>
                   <td>
                     <button class="action-btn" onclick="editRevenu(${idx})">Modifier</button>
                     <button class="action-btn" onclick="deleteRevenu(${idx})">Supprimer</button>
                   </td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
    }
    function renderRevenusAttente() {
      const container = document.getElementById('revenus-attente-list');
      if(revenusAttente.length === 0) { container.innerHTML = "<p>Aucun revenu en attente.</p>"; return; }
      let html = `<table>
                    <thead>
                      <tr>
                        <th>Description</th>
                        <th>Montant</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>`;
      revenusAttente.forEach((r, idx) => {
        html += `<tr>
                   <td>${r.description}</td>
                   <td>${r.amount.toFixed(2)} ‚Ç¨</td>
                   <td>
                     <button class="action-btn" onclick="editRevenuAttente(${idx})">Modifier</button>
                     <button class="action-btn" onclick="deleteRevenuAttente(${idx})">Supprimer</button>
                   </td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
    }
    function renderDepenses() {
      const container = document.getElementById('depenses-list');
      if(depenses.length === 0) { container.innerHTML = "<p>Aucune d√©pense enregistr√©e.</p>"; return; }
      let html = `<table>
                    <thead>
                      <tr>
                        <th>Description</th>
                        <th>Montant</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>`;
      depenses.forEach((d, idx) => {
        html += `<tr>
                   <td>${d.description}</td>
                   <td>${d.amount.toFixed(2)} ‚Ç¨</td>
                   <td>
                     <button class="action-btn" onclick="editDepense(${idx})">Modifier</button>
                     <button class="action-btn" onclick="deleteDepense(${idx})">Supprimer</button>
                   </td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
    }
    function renderDepensesPrevues() {
      const container = document.getElementById('depenses-prevues-list');
      if(depensesPrevues.length === 0) { container.innerHTML = "<p>Aucune d√©pense pr√©vue enregistr√©e.</p>"; return; }
      let html = `<table>
                    <thead>
                      <tr>
                        <th>Description</th>
                        <th>Montant</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>`;
      depensesPrevues.forEach((d, idx) => {
        html += `<tr>
                   <td>${d.description}</td>
                   <td>${d.amount.toFixed(2)} ‚Ç¨</td>
                   <td>
                     <button class="action-btn" onclick="editDepensePrevue(${idx})">Modifier</button>
                     <button class="action-btn" onclick="deleteDepensePrevue(${idx})">Supprimer</button>
                   </td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
    }
    function editRevenu(idx) {
      const newDesc = prompt("Modifier la description :", revenus[idx].description);
      const newAmount = prompt("Modifier le montant :", revenus[idx].amount);
      if(newDesc !== null && newAmount !== null) {
        revenus[idx].description = newDesc.trim() || revenus[idx].description;
        revenus[idx].amount = parseFloat(newAmount) || revenus[idx].amount;
        saveFinance();
        renderFinanceSummary();
        renderRevenus();
      }
    }
    function deleteRevenu(idx) {
      if(confirm("Supprimer ce revenu ?")) {
        revenus.splice(idx, 1);
        saveFinance();
        renderFinanceSummary();
        renderRevenus();
      }
    }
    function editRevenuAttente(idx) {
      const newDesc = prompt("Modifier la description :", revenusAttente[idx].description);
      const newAmount = prompt("Modifier le montant :", revenusAttente[idx].amount);
      if(newDesc !== null && newAmount !== null) {
        revenusAttente[idx].description = newDesc.trim() || revenusAttente[idx].description;
        revenusAttente[idx].amount = parseFloat(newAmount) || revenusAttente[idx].amount;
        renderFinanceSummary();
        renderRevenusAttente();
      }
    }
    function deleteRevenuAttente(idx) {
      if(confirm("Supprimer ce revenu en attente ?")) {
        revenusAttente.splice(idx, 1);
        renderFinanceSummary();
        renderRevenusAttente();
      }
    }
    function editDepense(idx) {
      const newDesc = prompt("Modifier la description :", depenses[idx].description);
      const newAmount = prompt("Modifier le montant :", depenses[idx].amount);
      if(newDesc !== null && newAmount !== null) {
        depenses[idx].description = newDesc.trim() || depenses[idx].description;
        depenses[idx].amount = parseFloat(newAmount) || depenses[idx].amount;
        saveFinance();
        renderFinanceSummary();
        renderDepenses();
      }
    }
    function deleteDepense(idx) {
      if(confirm("Supprimer cette d√©pense ?")) {
        depenses.splice(idx, 1);
        saveFinance();
        renderFinanceSummary();
        renderDepenses();
      }
    }
    function editDepensePrevue(idx) {
      const newDesc = prompt("Modifier la description :", depensesPrevues[idx].description);
      const newAmount = prompt("Modifier le montant pr√©vu :", depensesPrevues[idx].amount);
      if(newDesc !== null && newAmount !== null) {
        depensesPrevues[idx].description = newDesc.trim() || depensesPrevues[idx].description;
        depensesPrevues[idx].amount = parseFloat(newAmount) || depensesPrevues[idx].amount;
        saveFinance();
        renderFinanceSummary();
        renderDepensesPrevues();
      }
    }
    function deleteDepensePrevue(idx) {
      if(confirm("Supprimer cette d√©pense pr√©vue ?")) {
        depensesPrevues.splice(idx, 1);
        saveFinance();
        renderFinanceSummary();
        renderDepensesPrevues();
      }
    }
    renderFinanceSummary();
    renderRevenus();
    renderRevenusAttente();
    renderDepenses();
    renderDepensesPrevues();

    /* --- Projet --- */
    let projets = JSON.parse(localStorage.getItem('gestion_projets')) || [];
    function saveProjets() { localStorage.setItem('gestion_projets', JSON.stringify(projets)); }
    function renderProjets() {
      const container = document.getElementById('projet-resultat');
      if(projets.length === 0) { container.innerHTML = "<p>Aucun projet enregistr√©.</p>"; return; }
      let html = `<table id="projet-list">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Budget (‚Ç¨)</th>
              <th>Lien</th>
              <th>D√©lai (mois)</th>
              <th>Mode</th>
              <th>Calcul</th>
              <th>Priorit√©</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
      projets.forEach((p, idx) => {
        html += `<tr>
            <td>${p.nom}</td>
            <td>${p.prix.toFixed(2)}</td>
            <td>${p.lien ? `<a href="${p.lien}" target="_blank">Lien</a>` : "-"}</td>
            <td>${p.duree} mois</td>
            <td>${p.mode}</td>
            <td>${p.calcul}</td>
            <td>${p.priorite}</td>
            <td>
              <button class="action-btn" onclick="editProjet(${idx})">Modifier</button>
              <button class="action-btn" onclick="deleteProjet(${idx})">Supprimer</button>
            </td>
          </tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
    }
    function toggleLienProjet() {
      const check = document.getElementById('projet-ajout-lien').checked;
      document.getElementById('projet-lien').style.display = check ? "block" : "none";
    }
    function calculateProjet() {
      const nom = document.getElementById('projet-nom').value.trim();
      const prix = parseFloat(document.getElementById('projet-prix').value);
      const duree = parseInt(document.getElementById('projet-duree').value);
      const mode = document.getElementById('projet-mode-inverse').checked ? "Inverse" : "Direct";
      const mensuel = parseFloat(document.getElementById('projet-mensuel').value);
      const priorite = document.getElementById('projet-priorite').value;
      const moisObjectif = parseInt(document.getElementById('projet-mois-objectif').value);
      if(nom && !isNaN(prix) && !isNaN(duree)) {
        let calcul = "";
        if(mode === "Direct") {
          const budgetMensuel = prix / duree;
          calcul = "Budget mensuel requis : " + budgetMensuel.toFixed(2) + " ‚Ç¨";
        } else {
          if(!isNaN(mensuel) && mensuel > 0) {
            const moisEstime = Math.ceil(prix / mensuel);
            calcul = "Dur√©e estim√©e : " + moisEstime + " mois";
          } else {
            calcul = "Montant mensuel invalide";
          }
        }
        let economieMensuelle = "";
        if(!isNaN(moisObjectif) && moisObjectif > 0) {
          economieMensuelle = " Pour atteindre l'objectif en " + moisObjectif + " mois, √©conomisez " + (prix / moisObjectif).toFixed(2) + " ‚Ç¨ par mois.";
        }
        const lien = document.getElementById('projet-lien').value.trim();
        const projet = { nom, prix, duree, lien: lien || null, mode, calcul: calcul + economieMensuelle, priorite, suivi: [] };
        projets.push(projet);
        saveProjets();
        renderProjets();
        document.getElementById('form-projet').reset();
        document.getElementById('projet-lien').style.display = "none";
      } else {
        alert("Veuillez remplir correctement les champs du projet.");
      }
    }
    function editProjet(idx) {
      const projet = projets[idx];
      const newNom = prompt("Modifier le nom du projet :", projet.nom);
      if(newNom !== null) { projet.nom = newNom.trim() || projet.nom; }
      const newPrix = prompt("Modifier le budget total (‚Ç¨) :", projet.prix);
      if(newPrix !== null) { projet.prix = parseFloat(newPrix) || projet.prix; }
      const newDuree = prompt("Modifier le d√©lai souhait√© (mois) :", projet.duree);
      if(newDuree !== null) { projet.duree = parseInt(newDuree) || projet.duree; }
      const newPriorite = prompt("Modifier la priorit√© (1 √† 5) :", projet.priorite);
      if(newPriorite !== null) { projet.priorite = newPriorite || projet.priorite; }
      saveProjets();
      renderProjets();
    }
    function deleteProjet(idx) {
      if(confirm("Supprimer le projet " + projets[idx].nom + " ?")) {
        projets.splice(idx, 1);
        saveProjets();
        renderProjets();
      }
    }
    renderProjets();

    /* --- Plus d'Options --- */
    function calculerMargeBeneficiaire() {
      const idx = prompt("Entrez l'indice du chantier pour calculer la marge :");
      if(idx === null) return;
      const chantier = chantiers[idx];
      if(!chantier) { alert("Chantier non trouv√©."); return; }
      let coutOuvriers = 0;
      if(chantier.workerIds && chantier.duree) {
        chantier.workerIds.forEach(name => {
          const worker = ouvriers.find(o => o.nom === name);
          if(worker) { coutOuvriers += worker.tarif * chantier.duree; }
        });
      }
      const coutMateriel = chantier.matPayee ? 0 : chantier.materiel;
      const coutTotal = (chantier.prix * 0.22) + coutOuvriers + coutMateriel;
      const marge = ((chantier.prix - coutTotal) / chantier.prix) * 100;
      document.getElementById('plusoptions-output').innerText = "Marge b√©n√©ficiaire du chantier '" + chantier.nom + "' : " + marge.toFixed(2) + " %";
    }
    function previsionTresorerie() {
      const mois = parseInt(prompt("Sur combien de mois projeter la tr√©sorerie ?"));
      if(isNaN(mois) || mois <= 0) { alert("Valeur invalide."); return; }
      const soldeText = document.getElementById('global-balance').innerText;
      const solde = parseFloat(soldeText.replace(/[^\d.-]/g, ""));
      const projection = solde * mois;
      document.getElementById('plusoptions-output').innerText = "Projection sur " + mois + " mois : " + projection.toFixed(2) + " ‚Ç¨";
    }
    function analyserRentabiliteProjet() {
      const idx = prompt("Entrez l'indice du projet √† analyser :");
      if(idx === null) return;
      const projet = projets[idx];
      if(!projet) { alert("Projet non trouv√©."); return; }
      const revenuEstime = parseFloat(prompt("Revenu estim√© pour ce projet (‚Ç¨) :"));
      if(isNaN(revenuEstime)) { alert("Valeur invalide."); return; }
      const roi = ((revenuEstime - projet.prix) / projet.prix) * 100;
      document.getElementById('plusoptions-output').innerText = "ROI pour le projet '" + projet.nom + "' : " + roi.toFixed(2) + " %";
    }
    function genererEcheancier() {
      const montantTotal = parseFloat(prompt("Montant total (‚Ç¨) :"));
      const mois = parseInt(prompt("R√©partir sur combien de mois ?"));
      if(isNaN(montantTotal) || isNaN(mois) || mois <= 0) { alert("Valeurs invalides."); return; }
      const montantMensuel = montantTotal / mois;
      let echeancier = "√âch√©ancier :\n";
      let date = new Date();
      for(let i = 1; i <= mois; i++) {
        date.setMonth(date.getMonth() + 1);
        echeancier += "Mois " + i + " (" + date.toLocaleDateString() + ") : " + montantMensuel.toFixed(2) + " ‚Ç¨\n";
      }
      document.getElementById('plusoptions-output').innerText = echeancier;
    }
    function comparerCouts() {
      const idx1 = prompt("Indice du premier chantier :");
      const idx2 = prompt("Indice du deuxi√®me chantier :");
      const chantier1 = chantiers[idx1];
      const chantier2 = chantiers[idx2];
      if(!chantier1 || !chantier2) { alert("Chantier introuvable."); return; }
      const cout1 = chantier1.prix + chantier1.materiel;
      const cout2 = chantier2.prix + chantier2.materiel;
      let message = "Comparaison :\n";
      message += chantier1.nom + " : " + cout1.toFixed(2) + " ‚Ç¨\n";
      message += chantier2.nom + " : " + cout2.toFixed(2) + " ‚Ç¨\n";
      message += (cout1 < cout2) ? chantier1.nom + " est moins cher." : (cout2 < cout1) ? chantier2.nom + " est moins cher." : "Les deux ont le m√™me co√ªt.";
      document.getElementById('plusoptions-output').innerText = message;
    }
    function planifierTaches() {
      const nb = parseInt(prompt("Nombre de t√¢ches √† planifier :"));
      if(isNaN(nb) || nb <= 0) { alert("Nombre invalide."); return; }
      let taches = [];
      for(let i = 0; i < nb; i++) {
        const tache = prompt("T√¢che " + (i+1) + " :");
        const dateLimite = prompt("Date limite (AAAA-MM-JJ) pour la t√¢che " + (i+1) + " :");
        if(tache && dateLimite) { taches.push({ tache, dateLimite }); }
      }
      taches.sort((a, b) => new Date(a.dateLimite) - new Date(b.dateLimite));
      let message = "T√¢ches planifi√©es :\n";
      taches.forEach((t, i) => { message += (i+1) + ". " + t.tache + " (avant " + t.dateLimite + ")\n"; });
      document.getElementById('plusoptions-output').innerText = message;
    }
    function simulerInvestissement() {
      const principal = parseFloat(prompt("Montant investi initialement (‚Ç¨) :"));
      const taux = parseFloat(prompt("Taux d'int√©r√™t annuel (%) :"));
      const annees = parseInt(prompt("Dur√©e de l'investissement (ann√©es) :"));
      if(isNaN(principal) || isNaN(taux) || isNaN(annees)) { alert("Valeurs invalides."); return; }
      const montantFinal = principal * Math.pow((1 + taux/100), annees);
      document.getElementById('plusoptions-output').innerText = "Apr√®s " + annees + " ans, " + principal.toFixed(2) + " ‚Ç¨ √† " + taux + "% donnera " + montantFinal.toFixed(2) + " ‚Ç¨.";
    }
    function calculerTVAAvance() {
      const montant = parseFloat(prompt("Montant hors taxe (‚Ç¨) :"));
      const taux = parseFloat(prompt("Taux de TVA (%) :"));
      if(isNaN(montant) || isNaN(taux)) { alert("Valeurs invalides."); return; }
      const tva = montant * (taux/100);
      document.getElementById('plusoptions-output').innerText = "TVA √† " + taux + "% sur " + montant.toFixed(2) + " ‚Ç¨ = " + tva.toFixed(2) + " ‚Ç¨ (Total TTC = " + (montant+tva).toFixed(2) + " ‚Ç¨)";
    }
    function genererRapportPersonnalise() {
      const dateDebut = prompt("Date de d√©but (AAAA-MM-JJ) :");
      const dateFin = prompt("Date de fin (AAAA-MM-JJ) :");
      if(!dateDebut || !dateFin) { alert("Dates invalides."); return; }
      document.getElementById('plusoptions-output').innerText = "Rapport pour la p√©riode du " + dateDebut + " au " + dateFin + ".";
    }
    function analyserPerformanceOuvriers() {
      if(ouvriers.length === 0) { alert("Aucun ouvrier enregistr√©."); return; }
      let totalCout = 0, totalJours = 0;
      let details = "";
      ouvriers.forEach(o => {
        const total = o.tarif * o.jours;
        totalCout += total;
        totalJours += o.jours;
        details += o.nom + " : " + o.tarif.toFixed(2) + " ‚Ç¨/jour, Total " + total.toFixed(2) + " ‚Ç¨\n";
      });
      const moyenne = totalJours > 0 ? (totalCout / totalJours) : 0;
      details += "\nPerformance moyenne : " + moyenne.toFixed(2) + " ‚Ç¨/jour.";
      document.getElementById('plusoptions-output').innerText = details;
    }
    function calculerChiffreAffaires() {
      if(travauxFinis.length === 0) {
        document.getElementById('plusoptions-output').innerText = "Aucun chantier termin√© enregistr√©.";
        return;
      }
      const ca = travauxFinis.reduce((sum, c) => sum + c.prix, 0);
      document.getElementById('plusoptions-output').innerText = "Chiffre d'Affaires des travaux termin√©s : " + ca.toFixed(2) + " ‚Ç¨";
    }
    function afficherHistoriqueTravaux() {
      if(travauxFinis.length === 0) {
        document.getElementById('plusoptions-output').innerText = "Aucun travail termin√©.";
        return;
      }
      let historique = "Historique des Travaux Termin√©s :\n";
      travauxFinis.forEach((c, idx) => {
        historique += idx + ". " + c.nom + " ‚Äì " + c.prix.toFixed(2) + " ‚Ç¨\n";
      });
      document.getElementById('plusoptions-output').innerText = historique;
    }
    function analyserAvancee() {
      alert("Analyse avanc√©e en cours de d√©veloppement‚Ä¶");
    }
    
    /* --- Utilitaires --- */
    function exportAllData() {
      const allData = { ouvriers, baseOuvriers, chantiers, revenus, revenusAttente, depenses, depensesPrevues, projets, travauxFinis };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
      const dlAnchorElem = document.createElement('a');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "donnees_entreprise.json");
      dlAnchorElem.click();
    }
    function importAllData() {
      document.getElementById('import-file').click();
    }
    function handleImport(event) {
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if(importedData.ouvriers) { ouvriers = importedData.ouvriers; saveOuvriers(); renderOuvriers(); populateOuvrierSelect(); }
          if(importedData.baseOuvriers) { baseOuvriers = importedData.baseOuvriers; saveBaseOuvriers(); }
          if(importedData.chantiers) { chantiers = importedData.chantiers; saveChantiers(); renderChantiers(); }
          if(importedData.revenus) { revenus = importedData.revenus; }
          if(importedData.depenses) { depenses = importedData.depenses; }
          if(importedData.projets) { projets = importedData.projets; saveProjets(); renderProjets(); }
          if(importedData.travauxFinis) { travauxFinis = importedData.travauxFinis; saveTravauxFinis(); }
          renderFinanceSummary();
          alert("Importation r√©ussie !");
        } catch(error) {
          alert("Erreur lors de l'importation des donn√©es.");
        }
      };
      reader.readAsText(file);
    }
    function clearAllData() {
      if(confirm("Tout r√©initialiser ? Cette action effacera toutes vos donn√©es.")) { localStorage.clear(); location.reload(); }
    }
    function showHelp() {
      alert("Utilitaires :\n1. Exporter donn√©es\n2. Importer donn√©es\n3. R√©initialiser toutes les donn√©es\n4. Afficher Synth√®se\n5. Autres options...");
    }
    function viewSummary() { generateReport(); }
    function generateReport() {
      let reportHTML = "<h3>Rapport Global</h3>";
      reportHTML += "<h4>Ouvriers</h4><ul>";
      ouvriers.forEach(o => { reportHTML += `<li>${o.nom} ‚Äì Tarif: ${o.tarif} ‚Ç¨, Jours: ${o.jours}, Total: ${(o.tarif * o.jours).toFixed(2)} ‚Ç¨</li>`; });
      reportHTML += "</ul><h4>Chantiers Actifs</h4><ul>";
      chantiers.forEach(c => { reportHTML += `<li>${c.nom} ‚Äì Dur√©e: ${c.duree} j, Prix: ${c.prix} ‚Ç¨</li>`; });
      reportHTML += "</ul><h4>Travaux Termin√©s</h4><ul>";
      travauxFinis.forEach(c => { reportHTML += `<li>${c.nom} ‚Äì Dur√©e: ${c.duree} j, Prix: ${c.prix} ‚Ç¨</li>`; });
      reportHTML += "</ul><h4>Projets</h4><ul>";
      projets.forEach(p => { reportHTML += `<li>${p.nom} ‚Äì Budget: ${p.prix}, D√©lai: ${p.duree} mois</li>`; });
      reportHTML += "</ul><h4>Finance</h4>";
      reportHTML += `<p>${document.getElementById('manual-revenus').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('revenus-attente').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('manual-depenses').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('depenses-prevues').innerText}</p>`;
      reportHTML += `<p>${document.getElementById('global-balance').innerText}</p>`;
      document.getElementById('report-data').innerHTML = reportHTML;
      document.getElementById('report-modal').style.display = "flex";
    }
    function closeReport() { document.getElementById('report-modal').style.display = "none"; }
    function printReport() {
      const printContent = document.getElementById('report-data').innerHTML;
      const originalContent = document.body.innerHTML;
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      location.reload();
    }
    function downloadReportCSV() {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Type,Description,Montant\n";
      revenus.forEach(r => { csvContent += `Revenu,${r.description},${r.amount}\n`; });
      revenusAttente.forEach(r => { csvContent += `Revenu en attente,${r.description},${r.amount}\n`; });
      depenses.forEach(d => { csvContent += `D√©pense,${d.description},${d.amount}\n`; });
      depensesPrevues.forEach(d => { csvContent += `D√©pense pr√©vue,${d.description},${d.amount}\n`; });
      ouvriers.forEach(o => {
        const total = o.tarif * o.jours;
        csvContent += `Ouvrier,${o.nom} ‚Äì Tarif: ${o.tarif}, Total: ${total.toFixed(2)}\n`;
      });
      chantiers.forEach(c => { csvContent += `Chantier,${c.nom} ‚Äì Dur√©e: ${c.duree} j, ${c.prix}\n`; });
      projets.forEach(p => { csvContent += `Projet,${p.nom} ‚Äì Budget: ${p.prix}, D√©lai: ${p.duree} mois\n`; });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "rapport_global.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
  
  <!-- Modal Rapport -->
  <div class="report-modal" id="report-modal">
    <div class="report-content">
      <span class="close-report" onclick="closeReport()">&times;</span>
      <h2>Rapport Global</h2>
      <div id="report-data"></div>
      <button class="extra-btn" onclick="printReport()">Imprimer Rapport</button>
    </div>
  </div>
</body>
</html>
